<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:fragment="html(title, content, customCSS, customJS, activeMenu, activeSubMenu)">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="theme-color" content="#6c5ce7"/>

  <title th:replace="${title}">í† ë§ˆí† ë¦¬ë©¤ë²„</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.ico"/>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link th:href="@{/bootstrap/css/bootstrap.css}" rel="stylesheet"/>

  <!-- Common CSS -->
  <link th:href="@{/assets/mobile/css/common.css}" rel="stylesheet"/>
  <link th:href="@{/assets/mobile/css/layout.css}" rel="stylesheet"/>

  <!-- Custom CSS -->
  <th:block th:replace="${customCSS}"></th:block>
</head>
<body class="mobile-layout" th:classappend="|page-${activeMenu ?: 'main'}|">

  <!-- í—¤ë” -->
  <header class="mobile-header fixed-top" id="mobileHeader">
    <div class="container-fluid">
      <div class="header-content">
        <!-- ë¡œê³  -->
        <div class="header-logo">
          <a href="/mobile/home" class="logo-link">
            <span class="logo-text">TOMATOREMEMBER</span>
          </a>
        </div>

        <!-- í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ -->
        <button class="header-menu-btn" type="button" id="menuToggleBtn" aria-label="ë©”ë‰´ ì—´ê¸°">
          <span class="menu-icon">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="mobile-main" id="mobileMain">
    <div th:replace="${content}"></div>
  </main>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="mobile-nav fixed-bottom" id="mobileNav">
    <div class="nav-container">
      <a href="/mobile/home" class="nav-item" th:classappend="${(activeMenu ?: 'main') == 'main' ? 'active' : ''}"
         aria-label="í™ˆ í˜ì´ì§€ë¡œ ì´ë™">
        <i class="fas fa-home"></i>
        <span>í™ˆ</span>
      </a>
      <a href="/mobile/search" class="nav-item" th:classappend="${(activeMenu ?: 'main') == 'search' ? 'active' : ''}"
         aria-label="ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™">
        <i class="fas fa-search"></i>
        <span>ê²€ìƒ‰</span>
      </a>
      <a href="/mobile/support" class="nav-item" th:classappend="${(activeMenu ?: 'main') == 'support' ? 'active' : ''}"
         aria-label="ë„ì›€ë§ í˜ì´ì§€ë¡œ ì´ë™">
        <i class="fas fa-clock"></i>
        <span>ë„ì›€ë§</span>
      </a>
      <a href="/mobile/mypage" class="nav-item" th:classappend="${(activeMenu ?: 'main') == 'mypage' ? 'active' : ''}"
         aria-label="ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™">
        <i class="fas fa-user"></i>
        <span>ë§ˆì´í˜ì´ì§€</span>
      </a>
    </div>
  </nav>

  <!-- ì±„íŒ… FAB ë²„íŠ¼ (ë¡œê·¸ì¸ í›„ì—ë§Œ í‘œì‹œ) -->
  <button class="chat-fab" id="chatFab" onclick="openChat()"
          th:if="${currentUser != null}"
          aria-label="ì±„íŒ… ì—´ê¸°">
    <i class="fas fa-comments"></i>
  </button>

  <!-- í–„ë²„ê±° ë©”ë‰´ ì˜¤ë²„ë ˆì´ -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ (Offcanvas) -->
  <div class="mobile-offcanvas" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header">
      <div class="offcanvas-title" id="mobileMenuLabel">
        <!-- ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ì •ë³´ -->
        <div class="user-info" th:if="${currentUser != null}">
          <div class="user-avatar">
            <img th:src="${currentUser.profileImageUrl ?: '/assets/mobile/images/default-avatar.png'}"
                 th:alt="${currentUser.name}" class="avatar-img">
          </div>
          <div class="user-details">
            <h6 class="user-name" th:text="${currentUser.name ?: 'ì‚¬ìš©ì'}">ê¹€í† ë§ˆí† </h6>
            <p class="user-email" th:text="${currentUser.email ?: ''}">tomato@example.com</p>
          </div>
        </div>

        <!-- ë¡œê·¸ì¸ ì „ ê²ŒìŠ¤íŠ¸ ì •ë³´ -->
        <div class="guest-info" th:unless="${currentUser != null}">
          <div class="guest-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="guest-details">
            <h6>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h6>
            <a href="/mobile/login" class="btn btn-sm btn-primary">ë¡œê·¸ì¸</a>
          </div>
        </div>
      </div>

      <button type="button" class="btn-close" id="menuCloseBtn" aria-label="ë©”ë‰´ ë‹«ê¸°"></button>
    </div>

    <div class="offcanvas-body">
      <!-- ë¡œê·¸ì¸ í›„ ë©”ë‰´ -->
      <div class="menu-section" th:if="${currentUser != null}">
        <h6 class="menu-title">ì„œë¹„ìŠ¤</h6>
        <ul class="menu-list">
          <li>
            <a href="/mobile/memorial/management" class="menu-link">
              <i class="fas fa-heart text-danger"></i>
              <span>ë©”ëª¨ë¦¬ì–¼ ê´€ë¦¬</span>
            </a>
          </li>
          <li>
            <a href="/mobile/memorial/history" class="menu-link">
              <i class="fas fa-chart-line text-primary"></i>
              <span>í™œë™ ë‚´ì—­</span>
            </a>
          </li>
        </ul>

        <h6 class="menu-title">ë„ì›€ & ì„¤ì •</h6>
        <ul class="menu-list">
          <li>
            <a href="/mobile/payment" class="menu-link">
              <i class="fas fa-credit-card text-warning"></i>
              <span>í† í° ê´€ë¦¬</span>
            </a>
          </li>
          <li>
            <a href="/mobile/profile" class="menu-link">
              <i class="fas fa-user-edit text-info"></i>
              <span>í”„ë¡œí•„ ì„¤ì •</span>
            </a>
          </li>
          <li>
            <a href="/mobile/family/manage" class="menu-link">
              <i class="fas fa-users-cog text-success"></i>
              <span>ê°€ì¡± ê´€ë¦¬</span>
            </a>
          </li>
        </ul>

        <h6 class="menu-title">ì •ë³´ & ì„¤ì •</h6>
        <ul class="menu-list">
          <li>
            <a href="/mobile/support/help" class="menu-link">
              <i class="fas fa-question-circle text-muted"></i>
              <span>ë„ì›€ë§</span>
            </a>
          </li>
          <li>
            <a href="/mobile/support/contact" class="menu-link">
              <i class="fas fa-phone text-muted"></i>
              <span>ê³ ê°ì§€ì›</span>
            </a>
          </li>
          <li>
            <button class="menu-link logout-btn" onclick="logout()">
              <i class="fas fa-sign-out-alt text-danger"></i>
              <span>ë¡œê·¸ì•„ì›ƒ</span>
            </button>
          </li>
        </ul>
      </div>

      <!-- ë¡œê·¸ì¸ ì „ ë©”ë‰´ -->
      <div class="menu-section" th:unless="${currentUser != null}">
        <h6 class="menu-title">ê³„ì •</h6>
        <ul class="menu-list">
          <li>
            <a href="/mobile/login" class="menu-link">
              <i class="fas fa-sign-in-alt text-primary"></i>
              <span>ë¡œê·¸ì¸</span>
            </a>
          </li>
          <li>
            <a href="/mobile/register" class="menu-link">
              <i class="fas fa-user-plus text-success"></i>
              <span>íšŒì›ê°€ì…</span>
            </a>
          </li>
        </ul>

        <h6 class="menu-title">ì„œë¹„ìŠ¤</h6>
        <ul class="menu-list">
          <li>
            <a href="/mobile/experience" class="menu-link">
              <i class="fas fa-gift text-warning"></i>
              <span>3ê°œì›” ë¬´ë£Œì²´í—˜</span>
            </a>
          </li>
          <li>
            <a href="/mobile/about" class="menu-link">
              <i class="fas fa-info-circle text-info"></i>
              <span>ì„œë¹„ìŠ¤ ì†Œê°œ</span>
            </a>
          </li>
        </ul>

        <h6 class="menu-title">ì •ë³´</h6>
        <ul class="menu-list">
          <li>
            <a href="/mobile/support/faq" class="menu-link">
              <i class="fas fa-question-circle text-muted"></i>
              <span>ë„ì›€ë§</span>
            </a>
          </li>
          <li>
            <a href="/mobile/support/contact" class="menu-link">
              <i class="fas fa-phone text-muted"></i>
              <span>ê³ ê°ì§€ì›</span>
            </a>
          </li>
          <li>
            <a href="/mobile/terms" class="menu-link">
              <i class="fas fa-shield-alt text-muted"></i>
              <span>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- í‘¸í„° ì •ë³´ -->
      <div class="menu-footer">
        <p class="company-info">
          ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ì§„ 4ê¸¸ 32 ì´í† ë§ˆí† ë¹Œë”© 2ì¸µ<br>
          ì „í™”ë²ˆí˜¸: 02-2128-3838<br>
          ì´ë©”ì¼: tomatoai@etomato.com
        </p>
        <p class="copyright">
          COPYRIGHT Â© 2025 TOMATOREMEMBER.<br>
          ALL RIGHTS RESERVED.
        </p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script th:src="@{/bootstrap/js/bootstrap.bundle.js}"></script>

  <!-- í† í° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
  <div th:replace="~{fragments/token-sync :: tokenSync}"></div>

  <!-- Common JS -->
  <script th:src="@{/assets/mobile/js/common.js}" type="module"></script>
  <script th:src="@{/assets/mobile/js/layout.js}" type="module"></script>

  <!-- Custom JS -->
  <th:block th:replace="${customJS}"></th:block>

  <!-- ì „ì—­ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // ê¸°ë³¸ ì „ì—­ ì„¤ì •
    window.APP_CONFIG = {
      baseUrl: '',
      activeMenu: /*[[ ${activeMenu} ?: 'main' ]]*/ 'main',
      activeSubMenu: /*[[ ${activeSubMenu} ?: null ]]*/ null,
      currentUser: /*[[ ${currentUser} ?: null ]]*/ null,
      isLoggedIn: /*[[ ${currentUser != null} ]]*/ false
    };

    // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
    window.API_ENDPOINTS = {
      LOGIN: '/api/auth/login',
      LOGOUT: '/api/auth/logout',
      REFRESH: '/api/auth/refresh',
      MEMORIAL: '/api/memorial',
      VIDEO_CALL: '/api/video-call',
      TRIBUTE: '/api/tribute',
      USER_PROFILE: '/api/user/profile',
      TRIAL_STATUS: '/api/user/trial-status'
    };

    // ì „ì—­ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    window.globalUtils = {
      // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
      logout: function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          // í† í° ì •ë¦¬
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');

          // ë¡œê·¸ì•„ì›ƒ í˜ì´ì§€ë¡œ ì´ë™ (ì„œë²„ì—ì„œ ì¿ í‚¤ ì •ë¦¬)
          window.location.href = '/mobile/logout';
        }
      },

      // ì±„íŒ… ì—´ê¸° í•¨ìˆ˜
      openChat: function() {
        console.log('ğŸ’¬ ì±„íŒ… ì—´ê¸°');
        // TODO: ì±„íŒ… ê¸°ëŠ¥ êµ¬í˜„ í›„ ì£¼ì„ í•´ì œ
        alert('ì±„íŒ… ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
      },

      // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
      showLoginModal: function() {
        alert('ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´\\në¨¼ì € ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
        setTimeout(() => {
          window.location.href = '/mobile/login';
        }, 1000);
      },

      // í˜ì´ì§€ ë¡œë”© ìƒíƒœ í‘œì‹œ
      showPageLoading: function() {
        document.body.classList.add('loading');
      },

      // í˜ì´ì§€ ë¡œë”© ìƒíƒœ ìˆ¨ê¹€
      hidePageLoading: function() {
        document.body.classList.remove('loading');
      }
    };

    // ì „ì—­ í•¨ìˆ˜ë“¤ (í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
    function logout() {
      window.globalUtils.logout();
    }

    function openChat() {
      window.globalUtils.openChat();
    }

    function showLoginModal() {
      window.globalUtils.showLoginModal();
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“± í† ë§ˆí† ë¦¬ë©¤ë²„ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      console.log('ğŸ‘¤ ë¡œê·¸ì¸ ìƒíƒœ:', window.APP_CONFIG.isLoggedIn);
      console.log('ğŸ“ í™œì„± ë©”ë‰´:', window.APP_CONFIG.activeMenu);

      // í˜ì´ì§€ë³„ ì´ˆê¸°í™” ë¡œì§
      if (window.pageInitializer) {
        window.pageInitializer();
      }
    });

    // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        console.log('ğŸ‘ï¸ í˜ì´ì§€ ê°€ì‹œì„± ë³µì›');

        // í˜ì´ì§€ë³„ ìƒˆë¡œê³ ì¹¨ ë¡œì§
        if (window.pageRefresher) {
          window.pageRefresher();
        }
      }
    });

    // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
    window.addEventListener('online', function() {
      console.log('ğŸŒ ì˜¨ë¼ì¸ ìƒíƒœ ë³µì›');
      // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì•Œë¦¼ ì œê±°
      const offlineAlert = document.querySelector('.offline-alert');
      if (offlineAlert) {
        offlineAlert.remove();
      }
    });

    window.addEventListener('offline', function() {
      console.log('ğŸ“´ ì˜¤í”„ë¼ì¸ ìƒíƒœ');
      // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì•Œë¦¼ í‘œì‹œ
      if (!document.querySelector('.offline-alert')) {
        const alert = document.createElement('div');
        alert.className = 'offline-alert';
        alert.innerHTML = 'ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.';
        alert.style.cssText = `
          position: fixed;
          top: 70px;
          left: 50%;
          transform: translateX(-50%);
          background: #f56565;
          color: white;
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 2000;
          animation: slideDown 0.3s ease;
        `;
        document.body.appendChild(alert);
      }
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›
    document.addEventListener('keydown', function(e) {
      // ESC í‚¤ë¡œ ë©”ë‰´ ë‹«ê¸°
      if (e.key === 'Escape') {
        if (window.layoutManager && window.layoutManager.isMenuOpen) {
          window.layoutManager.closeMenu();
        }

        // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
        const openModal = document.querySelector('.modal.show');
        if (openModal) {
          const closeBtn = openModal.querySelector('.btn-close');
          if (closeBtn) {
            closeBtn.click();
          }
        }
      }
    });

    // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
    if (window.location.search.includes('debug=true')) {
      console.log('ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”');
      window.debugMode = true;

      // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
      window.showDebugInfo = function() {
        console.group('ğŸ” ë””ë²„ê·¸ ì •ë³´');
        console.log('APP_CONFIG:', window.APP_CONFIG);
        console.log('API_ENDPOINTS:', window.API_ENDPOINTS);
        console.log('Layout Manager:', window.layoutManager);
        console.log('Current User:', window.APP_CONFIG.currentUser);
        console.log('Token Info:', {
          accessToken: localStorage.getItem('accessToken')?.substring(0, 20) + '...',
          refreshToken: localStorage.getItem('refreshToken')?.substring(0, 20) + '...'
        });
        console.groupEnd();
      };
    }
  </script>

  <!-- ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
  <style>
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-100%);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .offline-alert {
      animation: slideDown 0.3s ease;
    }
  </style>

</body>
</html>