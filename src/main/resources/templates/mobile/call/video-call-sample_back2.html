<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TomatoRemember MVP (권한 최적화)</title>
  <style>
    /* 기존 스타일 유지 */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    html, body {
      width: 100%; height: 100%;
      background: #222;
      font-family: sans-serif;
      color: #fff;
    }
    #app {
      width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      position: relative;
    }
    video {
      display: block;
      width: 100%; height: 100%;
      object-fit: cover;
      background: black;
    }
    .controls {
      position: absolute;
      display: flex; gap: 8px;
      left: 50%; transform: translateX(-50%);
    }
    .controls input {
      padding: 6px 8px;
      border-radius: 4px; border: none;
      font-size: 14px;
      flex: 1;
    }
    .controls button {
      padding: 6px 12px;
      border: none; border-radius: 4px;
      background: #4CAF50; color: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    /* 통화 시작 모달 */
    .start-modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: #333;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      max-width: 90vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .modal-content h2 {
      margin-bottom: 15px;
      color: #fff;
      font-size: 24px;
    }
    .modal-content p {
      margin-bottom: 25px;
      color: #ccc;
      font-size: 16px;
      line-height: 1.4;
    }
    .start-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .start-button:hover {
      background: #45a049;
    }

    /* 로딩 상태 */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 1500;
    }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 4px solid #333;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 모바일 폰 프레임 */
    .phone-frame {
      position: relative;
      width: 360px; height: 640px;
      background: #111;
      border: 12px solid #333;
      border-radius: 36px;
      box-shadow: inset 0 0 0 1px #000, 0 4px 20px rgba(0,0,0,0.5);
      overflow: hidden;
      max-width: 90vw;
      max-height: 95vh;
      transform: scale(0.95);
      margin: auto;
    }
    .phone-frame .header {
      position: absolute; top: 8px; width: 100%; text-align: center;
      font-size: 14px; pointer-events: none;
    }
    .phone-frame .screen {
      position: absolute; top: 56px; left: 16px;
      width: calc(100% - 32px); height: calc(100% - 120px);
      background: #000;
    }
    .phone-frame .controls {
      bottom: 12px;
      width: calc(100% - 40px);
    }

    /* 반응형 */
    @media (min-width: 768px) {
      #full-video {
        position: relative;
        width: 100vw; height: 100vh;
        overflow: hidden;
      }
      #full-video video {
        object-fit: contain;
        background: black;
      }
      #full-video .controls {
        bottom: 24px;
        padding: 0 16px;
      }
      .phone-frame { display: none; }
      #full-video { display: block; }
    }

    @media (max-width: 767px) {
      #full-video { display: none; }
      .phone-frame { display: block; }
    }

    .video-hidden {
      display: none;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- 로딩 오버레이 -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p style="margin-top: 20px;">권한 상태를 확인하는 중...</p>
  </div>

  <!-- 통화 시작 모달 (조건부 표시) -->
  <div id="start-modal" class="start-modal" style="display: none;">
    <div class="modal-content">
      <h2>🍅 TomatoRemember</h2>
      <p id="modal-message">통화를 시작하시겠습니까?<br>화면을 터치하여 시작해주세요.</p>
      <button id="start-button" class="start-button">통화 시작</button>
    </div>
  </div>

  <!-- PC/태블릿: 전체화면 비디오 + 컨트롤 -->
  <div id="full-video" class="video-hidden">
    <video id="videoPlayerDesktop" loop autoplay muted playsinline>
      <source src="http://110.93.190.10:6060/static/waiting_3_slow.mp4" type="video/mp4">
      동영상 재생을 지원하지 않는 브라우저입니다.
    </video>
    <div class="controls">
      <input id="textInputDesktop" type="text" placeholder="메시지를 입력하세요...">
      <button id="sendBtnDesktop">전송</button>
    </div>
  </div>

  <!-- 모바일: 폰 프레임 내부 비디오 + 컨트롤 -->
  <div class="phone-frame video-hidden">
    <div class="header">
      TOMATOREMEMBER
    </div>
    <div class="screen">
      <video id="videoPlayerMobile" loop autoplay muted playsinline>
        <source src="http://110.93.190.10:6060/static/waiting_3_slow.mp4" type="video/mp4">
        동영상 재생을 지원하지 않는 브라우저입니다.
      </video>
    </div>
    <div class="controls">
      <input id="textInputMobile" type="text" placeholder="메시지를 입력하세요...">
      <button id="sendBtnMobile">전송</button>
    </div>
  </div>
</div>

<script>
  let callStarted = false;
  let sseConnection = null;
  const WAITING_VIDEO_URL = 'http://110.93.190.10:6060/static/waiting_3_slow.mp4';

  // 🔧 권한 상태 확인 및 초기화
  async function initializeApp() {
    try {
      console.log('🚀 앱 초기화 시작');

      // 기본 미디어 권한 확인
      const permissions = await checkMediaPermissions();
      console.log('📋 권한 상태:', permissions);

      // 로딩 오버레이 숨기기
      document.getElementById('loading-overlay').style.display = 'none';

      if (permissions.hasAllPermissions) {
        // ✅ 모든 권한이 승인된 경우 - 바로 통화 시작
        console.log('✅ 모든 권한 승인됨 - 바로 통화 시작');
        await startCall();
      } else {
        // ❌ 권한이 필요한 경우 - 모달 표시
        console.log('❌ 권한 필요 - 모달 표시');
        showPermissionModal(permissions);
      }

    } catch (error) {
      console.error('❌ 앱 초기화 실패:', error);

      // 로딩 오버레이 숨기기
      document.getElementById('loading-overlay').style.display = 'none';

      // 권한 확인 실패 시에도 모달 표시
      showPermissionModal({
        hasAllPermissions: false,
        camera: 'unknown',
        microphone: 'unknown',
        autoplay: 'unknown'
      });
    }
  }

  // 🔍 미디어 권한 상태 확인
  async function checkMediaPermissions() {
    const result = {
      hasAllPermissions: false,
      camera: 'unknown',
      microphone: 'unknown',
      autoplay: 'unknown'
    };

    try {
      // Navigator.permissions API 사용 (지원되는 경우)
      if (navigator.permissions) {
        try {
          const cameraPermission = await navigator.permissions.query({name: 'camera'});
          const microphonePermission = await navigator.permissions.query({name: 'microphone'});

          result.camera = cameraPermission.state;
          result.microphone = microphonePermission.state;

          console.log('🎥 카메라 권한:', cameraPermission.state);
          console.log('🎤 마이크 권한:', microphonePermission.state);
        } catch (e) {
          console.log('📋 Permissions API 부분 지원:', e.message);
        }
      }

      // getUserMedia로 실제 권한 테스트 (더 정확함)
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });

        // 권한이 승인된 경우
        result.camera = 'granted';
        result.microphone = 'granted';

        // 스트림 즉시 정리
        stream.getTracks().forEach(track => track.stop());

        console.log('✅ getUserMedia 테스트 성공 - 권한 승인됨');
      } catch (error) {
        console.log('❌ getUserMedia 테스트 실패:', error.name);

        if (error.name === 'NotAllowedError') {
          result.camera = 'denied';
          result.microphone = 'denied';
        } else if (error.name === 'NotFoundError') {
          console.log('📷 미디어 디바이스를 찾을 수 없음');
        }
      }

      // autoplay 정책 확인 (간접적)
      try {
        const video = document.createElement('video');
        video.muted = true;
        video.autoplay = true;
        video.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAAwAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAQAAAAAALgAAAC4AAAAAAAccGlkAAAAYXN0c2QAAAAAAAAAAQAAAFFhdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALgAuABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhmdHlwAAAAGGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAADhtZGF0AAAA';
        result.autoplay = 'granted';
      } catch (e) {
        result.autoplay = 'unknown';
      }

      // 모든 권한 승인 여부 확인
      result.hasAllPermissions = (
              result.camera === 'granted' &&
              result.microphone === 'granted'
      );

    } catch (error) {
      console.error('권한 확인 중 오류:', error);
    }

    return result;
  }

  // 📱 권한 모달 표시
  function showPermissionModal(permissions) {
    const modal = document.getElementById('start-modal');
    const message = document.getElementById('modal-message');

    if (permissions.camera === 'denied' || permissions.microphone === 'denied') {
      message.innerHTML = `
          <strong>⚠️ 미디어 권한이 차단되어 있습니다</strong><br><br>
          영상통화를 위해 카메라와 마이크 권한이 필요합니다.<br>
          브라우저 설정에서 권한을 허용해주세요.
        `;
    } else {
      message.innerHTML = `
          통화를 시작하시겠습니까?<br>
          카메라와 마이크 권한을 요청합니다.
        `;
    }

    modal.style.display = 'flex';
  }

  // 📞 통화 시작
  async function startCall() {
    if (callStarted) return;

    try {
      callStarted = true;
      console.log('📞 통화 시작!');

      // 모달 숨기기
      document.getElementById('start-modal').style.display = 'none';

      // 비디오 영역 보이기
      document.getElementById('full-video').classList.remove('video-hidden');
      document.querySelector('.phone-frame').classList.remove('video-hidden');

      // 모든 비디오 재생 시작 (소리 포함)
      const videos = document.querySelectorAll('video');
      for (const video of videos) {
        try {
          video.muted = false; // 소리 활성화
          await video.play();
          console.log('🎥 비디오 재생 시작 (소리 포함)');
        } catch (err) {
          console.error('비디오 재생 실패:', err);
        }
      }

      // SSE 연결 시작
      initializeSSE();

    } catch (error) {
      console.error('통화 시작 실패:', error);
      callStarted = false;

      // 오류 시 모달 다시 표시
      showPermissionModal({
        hasAllPermissions: false,
        camera: 'error',
        microphone: 'error'
      });
    }
  }

  // 통화 시작 버튼 클릭
  document.getElementById('start-button').addEventListener('click', async () => {
    console.log('🔘 통화 시작 버튼 클릭');
    await startCall();
  });

  // SSE 연결 초기화
  function initializeSSE() {
    if (sseConnection) return;

    console.log('🔌 SSE 연결 시작');
    sseConnection = new EventSource('/api/stream');

    sseConnection.addEventListener('videoUpdate', handleVideoUpdate);
    sseConnection.onerror = (err) => {
      console.error('SSE 연결 오류:', err);
    };
  }

  // 비디오 업데이트 처리
  function handleVideoUpdate(event) {
    const newVideoUrl = event.data;
    console.log('🎬 새 비디오 URL 받음:', newVideoUrl);

    const activeVideo = window.innerWidth >= 768
            ? document.getElementById('videoPlayerDesktop')
            : document.getElementById('videoPlayerMobile');

    playResultVideo(activeVideo, newVideoUrl);
  }

  // 결과 비디오 재생
  async function playResultVideo(videoElement, resultUrl) {
    try {
      console.log('▶️ 결과 비디오 재생 시작:', resultUrl);

      videoElement.src = resultUrl;
      videoElement.loop = false;
      videoElement.muted = false;

      await new Promise((resolve, reject) => {
        videoElement.onloadedmetadata = resolve;
        videoElement.onerror = reject;
        videoElement.load();
      });

      await videoElement.play();
      console.log('🎥 결과 비디오 재생 중');

      videoElement.onended = () => {
        console.log('✅ 결과 비디오 재생 완료, 대기 영상으로 복귀');
        returnToWaitingVideo(videoElement);
      };

    } catch (err) {
      console.error('결과 비디오 재생 실패:', err);
      returnToWaitingVideo(videoElement);
    }
  }

  // 대기 영상으로 복귀
  async function returnToWaitingVideo(videoElement) {
    try {
      console.log('🔄 대기 영상으로 복귀');

      videoElement.src = WAITING_VIDEO_URL;
      videoElement.loop = true;
      videoElement.muted = false;

      await new Promise((resolve, reject) => {
        videoElement.onloadedmetadata = resolve;
        videoElement.onerror = reject;
        videoElement.load();
      });

      await videoElement.play();
      console.log('🔁 대기 영상 재생 시작');

    } catch (err) {
      console.error('대기 영상 재생 실패:', err);
    }
  }

  // 메시지 전송
  async function sendMessage(text) {
    console.log('💬 메시지 전송:', text);

    try {
      fetch('/api/request', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text: text })
      }).then(response => {
        if (response.ok) {
          console.log('✅ 전송 성공');
        } else {
          console.error('❌ 전송 실패:', response.status);
        }
      }).catch(err => {
        console.error('🌐 네트워크 오류:', err);
      });
    } catch (err) {
      console.error('📤 전송 오류:', err);
    }
  }

  // 컨트롤 설정
  function setupControls(inputEl, btnEl) {
    function handleSend() {
      const text = inputEl.value.trim();
      if (!text) return;

      sendMessage(text);
      inputEl.value = '';
    }

    btnEl.addEventListener('click', handleSend);
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleSend();
      }
    });
  }

  // 컨트롤 설정
  setupControls(
          document.getElementById('textInputDesktop'),
          document.getElementById('sendBtnDesktop')
  );
  setupControls(
          document.getElementById('textInputMobile'),
          document.getElementById('sendBtnMobile')
  );

  // 🚀 페이지 로드 시 앱 초기화
  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>