<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="theme-color" content="#28a745"/>

    <title>í”„ë¡œí•„ ì„¤ì • - í† ë§ˆí† ë¦¬ë©¤ë²„</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.ico"/>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link th:href="@{/bootstrap/css/bootstrap.css}" rel="stylesheet"/>

    <!-- Common CSS -->
    <link th:href="@{/assets/mobile/css/common.css}" rel="stylesheet"/>

    <!-- Profile Settings CSS -->
    <link th:href="@{/assets/mobile/css/profile-settings.css}" rel="stylesheet"/>
</head>

<body class="profile-settings-page">
    <div class="container">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <button class="back-btn" id="backBtn" aria-label="ë’¤ë¡œê°€ê¸°">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h1 class="page-title">í”„ë¡œí•„ ì„¤ì •</h1>
        </div>

        <!-- í”„ë¡œí•„ ì •ë³´ ì¹´ë“œ -->
        <div class="profile-card fade-in">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">
                    <span th:text="${currentUser?.name?.substring(0,1) ?: '?'}">?</span>
                </div>
                <div class="profile-info">
                    <h2 id="profileName" th:text="${currentUser?.name ?: 'ì‚¬ìš©ì'}">ì‚¬ìš©ì</h2>
                    <p id="profileEmail" th:text="${currentUser?.email ?: currentUser?.phoneNumber ?: 'ì •ë³´ ì—†ìŒ'}">ì •ë³´ ì—†ìŒ</p>
                </div>
            </div>

            <!-- ê°œì¸ì •ë³´ ì„¹ì…˜ -->
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    ë‚´ ì •ë³´
                </h3>
            </div>

            <form id="profileForm">
                <input type="hidden" id="memberId" th:value="${currentUser?.id}">

                <div class="form-group">
                    <label for="userName" class="form-label">ì´ë¦„ *</label>
                    <input type="text" class="form-control" id="userName"
                           th:value="${currentUser?.name}" required>
                </div>

                <div class="form-group">
                    <label for="userBirthDate" class="form-label">ìƒë…„ì›”ì¼</label>
                    <input type="date" class="form-control" id="userBirthDate"
                           th:value="${currentUser?.birthDate}">
                </div>

                <div class="form-group">
                    <label for="userPhone" class="form-label">ì—°ë½ì²˜</label>
                    <input type="tel" class="form-control" id="userPhone"
                           th:value="${currentUser?.phoneNumber}"
                           placeholder="010-0000-0000">
                </div>

                <div class="form-group">
                    <label for="userEmail" class="form-label">ì´ë©”ì¼</label>
                    <input type="email" class="form-control" id="userEmail"
                           th:value="${currentUser?.email}"
                           placeholder="example@email.com">
                </div>
            </form>
        </div>

        <!-- í”„ë¡œí•„ ì‚¬ì§„ ì„¹ì…˜ -->
        <div class="photo-section fade-in">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-camera"></i>
                    í”„ë¡œí•„ ì‚¬ì§„
                </h3>
            </div>

            <div class="photo-notice">
                <i class="fas fa-info-circle"></i>
                <p>í•™ìŠµì— í•„ìš”í•œ í”„ë¡œí•„ ì‚¬ì§„ ì •ë©´ ì‚¬ì§„ 5ì¥ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.</p>
            </div>

            <!-- ì‚¬ì§„ ì—…ë¡œë“œ ì¡°ê±´ë¶€ ì•Œë¦¼ -->
            <div class="alert alert-warning" id="photoAlert" style="display: none;">
                í”„ë¡œí•„ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì‹œë©´ ë°˜ë“œì‹œ 5ì¥ì„ ëª¨ë‘ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.
            </div>

            <!-- í•„ìˆ˜ ì‚¬ì§„ ì•Œë¦¼ (ì˜ìƒí†µí™” ì ‘ê·¼ ì‹œ) -->
            <div class="alert alert-info" th:if="${redirectFromVideoCall}" id="videoCallAlert">
                <strong>ì˜ìƒí†µí™”ë¥¼ ìœ„í•´ í”„ë¡œí•„ ì‚¬ì§„ì´ í•„ìš”í•©ë‹ˆë‹¤!</strong><br>
                5ì¥ì˜ ì •ë©´ ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.
            </div>

            <!-- ì‚¬ì§„ ê·¸ë¦¬ë“œ -->
            <div class="photo-grid" id="photoGrid">
                <div class="photo-slot" th:each="i : ${#numbers.sequence(0, 4)}"
                     th:attr="data-index=${i}">
                    <i class="fas fa-camera"></i>
                    <span th:switch="${i}">
                        <span th:case="0">ì²« ë²ˆì§¸<br>ì‚¬ì§„</span>
                        <span th:case="1">ë‘ ë²ˆì§¸<br>ì‚¬ì§„</span>
                        <span th:case="2">ì„¸ ë²ˆì§¸<br>ì‚¬ì§„</span>
                        <span th:case="3">ë„¤ ë²ˆì§¸<br>ì‚¬ì§„</span>
                        <span th:case="4">ë‹¤ì„¯ ë²ˆì§¸<br>ì‚¬ì§„</span>
                    </span>
                </div>
            </div>

            <!-- íŒŒì¼ ì…ë ¥ -->
            <input type="file" class="file-input" id="photoInput" accept="image/*" multiple>

            <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
            <button class="photo-upload-btn" id="photoUploadBtn">
                <i class="fas fa-camera"></i>
                ì‚¬ì§„ ì„ íƒí•˜ê¸°
            </button>

            <div class="alert alert-info" style="margin-top: var(--spacing-md);">
                <strong>ì‚¬ì§„ ì´¬ì˜ ê°€ì´ë“œ:</strong><br>
                â€¢ ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì–¼êµ´ì´ ì˜ ë³´ì´ë„ë¡ ì´¬ì˜í•´ì£¼ì„¸ìš”<br>
                â€¢ ë°ì€ ê³³ì—ì„œ ì„ ëª…í•˜ê²Œ ì´¬ì˜í•´ì£¼ì„¸ìš”<br>
                â€¢ ì•ˆê²½ì´ë‚˜ ëª¨ì ë“±ìœ¼ë¡œ ì–¼êµ´ì´ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ í•´ì£¼ì„¸ìš”
            </div>
        </div>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button class="btn btn-primary btn-block" id="saveBtn">
            <i class="fas fa-save"></i>
            í”„ë¡œí•„ ì €ì¥
        </button>

        <!-- íšŒì›íƒˆí‡´ ì„¹ì…˜ -->
        <div class="delete-account-section">
            <button class="btn btn-danger" id="deleteAccountBtn">
                <i class="fas fa-user-times"></i>
                íšŒì›íƒˆí‡´
            </button>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
            </div>
            <p class="loading-message" id="loadingMessage">ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script th:src="@{/bootstrap/js/bootstrap.bundle.js}"></script>

    <!-- í† í° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <div th:replace="~{fragments/token-sync :: tokenSync}"></div>

    <!-- Common JS -->
    <script th:src="@{/assets/mobile/js/common.js}" type="module"></script>
    <script th:src="@{/assets/mobile/js/commonFetch.js}" type="module"></script>

    <!-- ì„œë²„ ë°ì´í„° ì „ë‹¬ -->
    <script th:inline="javascript">
        window.serverData = {
            currentUser: {
                // ê¸°ë³¸ ì •ë³´ë§Œ
            },
            profileData: {
                imageUrls: /*[[ ${profileData?.imageUrls} ]]*/ [],
                uploadedImageCount: /*[[ ${profileData?.uploadedImageCount} ]]*/ 0,
                validImageCount: /*[[ ${profileData?.validImageCount} ]]*/ 0,
                canStartVideoCall: /*[[ ${profileData?.canStartVideoCall} ]]*/ false,
                completionPercentage: /*[[ ${profileData?.completionPercentage} ]]*/ 0,
                hasAnyImages: /*[[ ${profileData?.hasAnyImages} ]]*/ false,
                needsCompleteUpload: /*[[ ${profileData?.needsCompleteUpload} ]]*/ false
            },
            redirectFromVideoCall: /*[[ ${redirectFromVideoCall ?: false} ]]*/ false,
            maxProfileImages: 5
        };
    </script>

    <!-- Profile Settings JS -->
    <script th:src="@{/assets/mobile/js/profile-settings.js}" type="module"></script>

    <!-- ì „ì—­ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ê¸°ë³¸ ì „ì—­ ì„¤ì •
        window.APP_CONFIG = {
            baseUrl: '',
            currentUser: /*[[ ${currentUser} ]]*/ null,
            isLoggedIn: /*[[ ${currentUser != null} ]]*/ false
        };

        // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
        window.API_ENDPOINTS = {
            PROFILE_UPDATE: '/api/profile/update',
            PROFILE_IMAGE_UPLOAD: '/api/profile/upload-image',
            PROFILE_IMAGE_DELETE: '/api/profile/delete-image',
            ACCOUNT_DELETE: '/api/profile/delete-account'
        };

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± í”„ë¡œí•„ ì„¤ì • í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            console.log('ğŸ‘¤ ë¡œê·¸ì¸ ìƒíƒœ:', window.APP_CONFIG.isLoggedIn);
        });

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ğŸ‘ï¸ í˜ì´ì§€ ê°€ì‹œì„± ë³µì›');
            }
        });

        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
        window.addEventListener('online', function() {
            console.log('ğŸŒ ì˜¨ë¼ì¸ ìƒíƒœ ë³µì›');
        });

        window.addEventListener('offline', function() {
            console.log('ğŸ“´ ì˜¤í”„ë¼ì¸ ìƒíƒœ');
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›
        document.addEventListener('keydown', function(e) {
            // ESC í‚¤ë¡œ ë’¤ë¡œê°€ê¸°
            if (e.key === 'Escape') {
                const backBtn = document.getElementById('backBtn');
                if (backBtn) {
                    backBtn.click();
                }
            }
        });
    </script>
</body>
</html>