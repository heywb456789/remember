<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† ë§ˆí† ë¦¬ë©¤ë²„ - ì˜ìƒí†µí™”</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) */
    .main-video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .main-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      transition: opacity 0.5s ease;
    }

    /* ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) - PC/ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    .my-camera-container {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 160px;
      background: #2c3e50;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }

    .my-camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3498db, #2980b9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” - ê³ ì • ìœ„ì¹˜ ë³´ì¥ */
    .control-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 30px 20px 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 1000;
      min-height: 120px;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 30px;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
    }

    .record-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .record-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .record-btn.recording {
      background: #e74c3c;
      animation: recordingPulse 1.5s ease-in-out infinite;
    }

    .record-btn.recording::after {
      content: '';
      position: absolute;
      width: 80px;
      height: 80px;
      border: 2px solid rgba(231, 76, 60, 0.6);
      border-radius: 50%;
      animation: recordingRing 1.5s ease-out infinite;
    }

    @keyframes recordingPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes recordingRing {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.3);
        opacity: 0;
      }
    }

    .end-call-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .end-call-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    /* ìƒíƒœ í‘œì‹œ */
    .status-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      font-size: 14px;
      backdrop-filter: blur(10px);
      z-index: 100;
      transition: opacity 0.3s ease;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #27ae60;
      border-radius: 50%;
      margin-right: 8px;
      animation: statusBlink 2s ease-in-out infinite;
    }

    @keyframes statusBlink {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* ìŒì†Œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .mute-btn {
      background: #95a5a6;
      box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
    }

    .mute-btn:hover {
      background: #7f8c8d;
      transform: scale(1.1);
    }

    .mute-btn.active {
      background: #27ae60;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
    }

    /* ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ */
    .permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .permission-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .permission-dialog {
      background: #2c3e50;
      border-radius: 16px;
      padding: 32px;
      max-width: 360px;
      width: 90%;
      text-align: center;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }

    .permission-modal.show .permission-dialog {
      transform: scale(1);
    }

    .permission-icon {
      font-size: 64px;
      margin-bottom: 20px;
      display: block;
    }

    .permission-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #ecf0f1;
    }

    .permission-message {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 24px;
      color: #bdc3c7;
    }

    .permission-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .permission-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .permission-btn.deny {
      background: #7f8c8d;
      color: white;
    }

    .permission-btn.allow {
      background: #3498db;
      color: white;
    }

    .permission-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* ìŒì„± ì•ˆë‚´ ë§í’ì„  */
    .audio-guide {
      position: absolute;
      bottom: 130px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(52, 73, 94, 0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      text-align: center;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      z-index: 150;
      animation: guideBounce 0.5s ease-out;
      display: none;
    }

    .audio-guide.show {
      display: block;
    }

    .guide-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid rgba(52, 73, 94, 0.95);
    }

    .guide-text strong {
      color: #f39c12;
    }

    @keyframes guideBounce {
      0% {
        transform: translateX(-50%) translateY(10px);
        opacity: 0;
      }
      100% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* í„ìŠ¤ íš¨ê³¼ (ë²„íŠ¼ ê°•ì¡°) */
    .mute-btn.pulse {
      animation: mutePulse 1.5s ease-in-out infinite;
    }

    @keyframes mutePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 4px 20px rgba(241, 196, 15, 0.6);
      }
    }

    /* ì„¸ì…˜ ì •ë³´ í‘œì‹œ */
    .session-info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 6px 12px;
      border-radius: 15px;
      color: white;
      font-size: 12px;
      backdrop-filter: blur(10px);
      z-index: 100;
      opacity: 0.7;
    }

    /* PC/íƒœë¸”ë¦¿ ë°˜ì‘í˜• (768px ì´ìƒ) */
    @media (min-width: 768px) {
      .my-camera-container {
        width: 180px;
        height: 240px;
        top: 30px;
        right: 30px;
      }

      .control-bar {
        padding: 40px 30px 50px;
        gap: 30px;
      }

      .control-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }

      .status-indicator {
        top: 30px;
        left: 30px;
        font-size: 16px;
        padding: 10px 20px;
      }

      .audio-guide {
        bottom: 160px;
        font-size: 16px;
        padding: 16px 20px;
      }

      .main-video {
        object-fit: contain;
      }

      .permission-dialog {
        max-width: 420px;
        padding: 40px;
      }

      .permission-icon {
        font-size: 72px;
      }

      .permission-title {
        font-size: 24px;
      }

      .permission-message {
        font-size: 16px;
      }
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• (480px ì´í•˜) */
    @media (max-width: 480px) {
      .my-camera-container {
        width: 100px;
        height: 133px;
        top: 15px;
        right: 15px;
      }

      .control-bar {
        padding: 20px 15px 30px;
        gap: 15px;
        min-height: 100px;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .audio-guide {
        bottom: 120px;
        font-size: 13px;
        padding: 10px 14px;
      }

      .status-indicator {
        top: 15px;
        left: 15px;
        font-size: 12px;
        padding: 6px 12px;
      }

      .main-video {
        object-fit: cover;
      }

      .permission-dialog {
        padding: 24px;
      }

      .permission-icon {
        font-size: 56px;
      }

      .permission-title {
        font-size: 18px;
      }

      .permission-message {
        font-size: 14px;
      }
    }

    /* ì•„ì´í° SE ë° ë§¤ìš° ì‘ì€ í™”ë©´ (375px ì´í•˜) */
    @media (max-width: 375px) {
      .control-bar {
        padding: 15px 10px 25px;
        gap: 12px;
        min-height: 90px;
      }

      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }

      .my-camera-container {
        width: 80px;
        height: 107px;
        top: 10px;
        right: 10px;
      }

      .permission-dialog {
        padding: 20px;
      }
    }

    /* ê°€ë¡œ ëª¨ë“œ ëŒ€ì‘ */
    @media (orientation: landscape) and (max-height: 500px) {
      .control-bar {
        padding: 15px 20px 20px;
        min-height: 80px;
      }

      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }

      .my-camera-container {
        width: 80px;
        height: 107px;
        top: 10px;
        right: 10px;
      }

      .audio-guide {
        bottom: 90px;
      }
    }

    /* ì•ˆì „ ì˜ì—­ ëŒ€ì‘ (ì•„ì´í° ë…¸ì¹˜ ë“±) */
    @supports (padding: max(0px)) {
      .control-bar {
        padding-bottom: max(30px, env(safe-area-inset-bottom));
      }

      .my-camera-container {
        top: max(20px, env(safe-area-inset-top));
        right: max(20px, env(safe-area-inset-right));
      }

      .status-indicator {
        top: max(20px, env(safe-area-inset-top));
        left: max(20px, env(safe-area-inset-left));
      }
    }

    /* ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes pulseGlow {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
        box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 0 30px rgba(52, 152, 219, 0.8);
      }
    }

    @keyframes fadeInOut {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
    }
  </style>
</head>
<body>
<!-- ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ -->
<div id="permissionModal" class="permission-modal">
  <div class="permission-dialog">
    <div id="permissionIcon" class="permission-icon">ğŸ¥</div>
    <div id="permissionTitle" class="permission-title">ë¯¸ë””ì–´ ê¶Œí•œ í•„ìš”</div>
    <div id="permissionMessage" class="permission-message">
      ì˜ìƒí†µí™”ë¥¼ ìœ„í•´ ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
      iOS Safariì—ì„œ ìµœì ì˜ ê²½í—˜ì„ ìœ„í•´ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
    </div>
    <div class="permission-buttons">
      <button class="permission-btn deny" onclick="denyPermission()">ë‚˜ì¤‘ì—</button>
      <button class="permission-btn allow" onclick="requestPermissions()">í—ˆìš©</button>
    </div>
  </div>
</div>

<!-- ìƒíƒœ í‘œì‹œ -->
<div class="status-indicator">
  <span class="status-dot"></span>
  <span id="statusText">ê¶Œí•œ ìš”ì²­ ì¤‘...</span>
</div>

<!-- ì„¸ì…˜ ì •ë³´ í‘œì‹œ -->
<div id="sessionInfo" class="session-info" style="display: none;">
  <span id="sessionId">ì„¸ì…˜: ë¡œë”©ì¤‘...</span>
</div>

<!-- ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) -->
<div class="main-video-container">
  <video id="mainVideo" class="main-video" autoplay loop muted playsinline style="display: none;">
    <source src="https://aicut.newstomato.com/remember/static/waiting_kt.mp4" type="video/mp4">
    ëŒ€ê¸° ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  </video>
</div>

<!-- ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) -->
<div class="my-camera-container">
  <video id="myCamera" class="my-camera" autoplay muted playsinline style="display: none;"></video>
  <div id="cameraPlaceholder" class="camera-placeholder">ğŸ“¹</div>
</div>

<!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
<div class="control-bar">
  <button id="recordBtn" class="control-btn record-btn" onclick="toggleRecording()">
    <span id="recordIcon">âº</span>
  </button>

  <!-- ìŒì†Œê±° ë²„íŠ¼ -->
  <button id="muteBtn" class="control-btn mute-btn" onclick="toggleMute()">
    <span id="muteIcon">ğŸ”‡</span>
  </button>

  <button class="control-btn end-call-btn" onclick="endCall()">
    ğŸ“
  </button>
</div>

<!-- ìŒì„± ì•ˆë‚´ ë§í’ì„  -->
<div id="audioGuide" class="audio-guide">
  <div class="guide-arrow"></div>
  <div class="guide-text">
    ìŒì„± ì¬ìƒì„ ìœ„í•´<br>
    <strong>ğŸ”‡ ë²„íŠ¼ì„ í„°ì¹˜</strong>í•´ì£¼ì„¸ìš”
  </div>
</div>

<script>
  // ========== ì „ì—­ ë³€ìˆ˜ ==========

  // ê¶Œí•œ ê´€ë ¨
  let cameraPermissionGranted = false;
  let microphonePermissionGranted = false;
  let permissionRequestInProgress = false;

  // ì„¸ì…˜ ë° ì—°ê²° ê´€ë ¨
  let sessionKey = null;
  let sseEventSource = null;

  // ë…¹í™” ê´€ë ¨
  let mediaRecorder = null;
  let recordedChunks = [];
  let isRecording = false;
  let userMediaStream = null;

  // ìŒì†Œê±° ê´€ë ¨
  let isAudioEnabled = false;
  let guideTimeout = null;

  // ì˜ìƒ ì¬ìƒ ê´€ë ¨
  let waitingVideoPreloaded = false;
  let currentVideoState = 'WAITING';
  let videoTransitionInProgress = false;

  // DOM ìš”ì†Œë“¤
  const permissionModal = document.getElementById('permissionModal');
  const permissionIcon = document.getElementById('permissionIcon');
  const permissionTitle = document.getElementById('permissionTitle');
  const permissionMessage = document.getElementById('permissionMessage');
  const mainVideo = document.getElementById('mainVideo');
  const myCamera = document.getElementById('myCamera');
  const cameraPlaceholder = document.getElementById('cameraPlaceholder');
  const recordBtn = document.getElementById('recordBtn');
  const recordIcon = document.getElementById('recordIcon');
  const statusText = document.getElementById('statusText');
  const muteBtn = document.getElementById('muteBtn');
  const muteIcon = document.getElementById('muteIcon');
  const audioGuide = document.getElementById('audioGuide');
  const sessionInfo = document.getElementById('sessionInfo');
  const sessionId = document.getElementById('sessionId');

  // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
  let sseReconnectAttempts = 0;
  let maxReconnectAttempts = 10;
  let heartbeatInterval = null;
  let lastHeartbeat = Date.now();

  // ========== SessionStorage ê´€ë¦¬ ==========
  const SESSION_STORAGE_KEY = 'videoCallSession';
  const SESSION_TTL = 3 * 60 * 60 * 1000; // 3ì‹œê°„

  function saveSession(sessionKey, contactName) {
    const sessionData = {
      sessionKey,
      contactName,
      createdAt: Date.now(),
      lastActivity: Date.now()
    };
    sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessionData));
    console.log('ğŸ’¾ ì„¸ì…˜ ì €ì¥ë¨:', sessionData);
    updateSessionInfoDisplay(sessionData);
  }

  function loadSession() {
    const saved = sessionStorage.getItem(SESSION_STORAGE_KEY);
    if (!saved) {
      console.log('ğŸ“‚ ì €ì¥ëœ ì„¸ì…˜ ì—†ìŒ');
      return null;
    }

    const session = JSON.parse(saved);
    const age = Date.now() - session.createdAt;

    if (age > SESSION_TTL) {
      sessionStorage.removeItem(SESSION_STORAGE_KEY);
      console.log('â° ì„¸ì…˜ ë§Œë£Œë¨ (3ì‹œê°„ ì´ˆê³¼):', Math.round(age / 1000 / 60 / 60), 'ì‹œê°„');
      return null;
    }

    console.log('ğŸ“‚ ê¸°ì¡´ ì„¸ì…˜ ë¡œë“œë¨:', session, '(ë‚˜ì´:', Math.round(age / 1000 / 60), 'ë¶„)');
    return session;
  }

  function updateSessionActivity() {
    const saved = sessionStorage.getItem(SESSION_STORAGE_KEY);
    if (saved) {
      const session = JSON.parse(saved);
      session.lastActivity = Date.now();
      sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(session));
    }
  }

  function updateSessionInfoDisplay(sessionData) {
    if (sessionData) {
      const shortKey = sessionData.sessionKey.substring(sessionData.sessionKey.length - 8);
      const age = Math.round((Date.now() - sessionData.createdAt) / 1000 / 60);
      sessionId.textContent = `ì„¸ì…˜: ${shortKey} (${age}ë¶„)`;
      sessionInfo.style.display = 'block';
    } else {
      sessionInfo.style.display = 'none';
    }
  }

  // ========== ê¶Œí•œ ìš”ì²­ ì‹œìŠ¤í…œ (OSë³„ ìµœì í™”) ==========

  async function requestPermissions() {
    if (permissionRequestInProgress) {
      console.log('â³ ê¶Œí•œ ìš”ì²­ì´ ì´ë¯¸ ì§„í–‰ ì¤‘');
      return;
    }

    permissionRequestInProgress = true;
    hidePermissionModal();

    try {
      updateStatusSmoothly('ê¶Œí•œ í™•ì¸ ì¤‘...');
      console.log('ğŸ” ë¯¸ë””ì–´ ê¶Œí•œ ìš”ì²­ ì‹œì‘');
      console.log('ğŸ“± í”Œë«í¼:', BROWSER_INFO.platform);

      // ê¸°ë³¸ ì œì•½ì‚¬í•­
      const constraints = {
        video: {
          width: { ideal: 1920, min: 1280 },
          height: { ideal: 1080, min: 720 },
          frameRate: { ideal: 30, min: 24 },
          facingMode: 'user'
        },
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100
        }
      };

      console.log('ğŸ“± getUserMedia í˜¸ì¶œ ì¤‘...');

      // OSë³„ ê¶Œí•œ ìš”ì²­ ë°©ì‹
      if (BROWSER_INFO.isIOSSafari) {
        console.log('ğŸ iOS Safari ë‹¨ê³„ë³„ ê¶Œí•œ ìš”ì²­');

        // iOS Safari: ë‹¨ê³„ë³„ ê¶Œí•œ ìš”ì²­
        try {
          // 1ë‹¨ê³„: ì¹´ë©”ë¼ ê¶Œí•œ
          console.log('ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­');
          const videoStream = await navigator.mediaDevices.getUserMedia({ video: constraints.video });
          console.log('âœ… ì¹´ë©”ë¼ ê¶Œí•œ íšë“');

          // 2ë‹¨ê³„: ë§ˆì´í¬ ê¶Œí•œ
          console.log('ğŸ¤ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­');
          const audioStream = await navigator.mediaDevices.getUserMedia({ audio: constraints.audio });
          console.log('âœ… ë§ˆì´í¬ ê¶Œí•œ íšë“');

          // 3ë‹¨ê³„: ìŠ¤íŠ¸ë¦¼ ê²°í•©
          console.log('ğŸ”— ìŠ¤íŠ¸ë¦¼ ê²°í•©');
          const tracks = [...videoStream.getTracks(), ...audioStream.getTracks()];
          userMediaStream = new MediaStream(tracks);

          console.log('âœ… iOS Safari ê¶Œí•œ ì™„ë£Œ:', userMediaStream.getTracks().map(t => t.kind));

        } catch (iosError) {
          console.error('âŒ iOS Safari ê¶Œí•œ ì‹¤íŒ¨:', iosError);
          throw iosError;
        }

      } else {
        console.log('ğŸ¤– Android/Desktop í†µí•© ê¶Œí•œ ìš”ì²­');

        // Android/Desktop: í†µí•© ê¶Œí•œ ìš”ì²­
        userMediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log('âœ… í†µí•© ê¶Œí•œ íšë“:', userMediaStream.getTracks().map(t => t.kind));
      }

      cameraPermissionGranted = true;
      microphonePermissionGranted = true;

      // ì¹´ë©”ë¼ ì„¤ì •
      setupCamera();

      // ê¶Œí•œ íšë“ í›„ ì˜ìƒí†µí™” ì´ˆê¸°í™”
      await initializeVideoCallAfterPermission();

      updateStatusSmoothly('ê¶Œí•œ ì„¤ì • ì™„ë£Œ');
      console.log('ğŸ‰ ê¶Œí•œ ìš”ì²­ ì„±ê³µ - ì˜ìƒí†µí™” ì´ˆê¸°í™”');

    } catch (error) {
      console.error('âŒ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', error);
      handlePermissionError(error);
    } finally {
      permissionRequestInProgress = false;
    }
  }

  // ========== ìŒì†Œê±° ê¸°ëŠ¥ (OSë³„ ìµœì í™”) ==========

  async function enableAudio() {
    try {
      console.log('ğŸ”Š ì˜¤ë””ì˜¤ í™œì„±í™” ì‹œì‘');
      console.log('ğŸ“± í”Œë«í¼:', BROWSER_INFO.platform, 'ì „í™˜ ë°©ì‹:', VIDEO_SETTINGS.volumeTransition);

      if (BROWSER_INFO.isIOSSafari && VIDEO_SETTINGS.volumeTransition === 'SAFE') {
        console.log('ğŸ iOS Safari ì•ˆì „ ì˜¤ë””ì˜¤ í™œì„±í™”');

        // iOS Safari ì•ˆì „ ëª¨ë“œ
        mainVideo.muted = false;
        mainVideo.volume = 0.1;

        // í˜„ì¬ ì¬ìƒ ìƒíƒœ í™•ì¸
        const wasPlaying = !mainVideo.paused;
        const currentTime = mainVideo.currentTime;

        if (wasPlaying) {
          try {
            await mainVideo.play();
            console.log('ğŸ”Š iOS ì˜¤ë””ì˜¤ ì¬ìƒ ì„±ê³µ');
          } catch (playError) {
            console.warn('âš ï¸ iOS ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', playError);
          }
        }

        // ë³¼ë¥¨ ì •ìƒ ì„¤ì •
        mainVideo.volume = 0.8;

      } else {
        console.log('ğŸ¤– Android/Desktop ë¶€ë“œëŸ¬ìš´ ì˜¤ë””ì˜¤ í™œì„±í™”');

        // Android/Desktop ë¶€ë“œëŸ¬ìš´ ëª¨ë“œ
        mainVideo.muted = false;
        mainVideo.volume = 0.01;
        await mainVideo.play();
        mainVideo.volume = 0.8;
      }

      isAudioEnabled = true;
      muteIcon.textContent = 'ğŸ”Š';
      muteBtn.classList.add('active');
      muteBtn.classList.remove('pulse');

      hideAudioGuide();
      showSuccessMessage('ìŒì„±ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
      console.log('âœ… ì˜¤ë””ì˜¤ í™œì„±í™” ì™„ë£Œ');

    } catch (error) {
      console.error('ì˜¤ë””ì˜¤ í™œì„±í™” ì‹¤íŒ¨:', error);
      showErrorMessage('ìŒì„± í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ========== ì´ˆê¸° ì˜ìƒ ì„¤ì • (OSë³„ ìµœì í™”) ==========

  async function startWaitingVideoImmediately() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì‹œì‘:', waitingVideoUrl);
      console.log('ğŸ“± í”Œë«í¼:', BROWSER_INFO.platform);

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.autoplay = true;
      mainVideo.playsInline = true;
      mainVideo.style.display = 'block';

      // OSë³„ ì´ˆê¸° ì„¤ì •
      if (BROWSER_INFO.isIOSSafari) {
        console.log('ğŸ iOS Safari ì´ˆê¸° ì„¤ì •');
        mainVideo.preload = 'auto';
        mainVideo.removeAttribute('crossorigin');
      } else {
        console.log('ğŸ¤– Android/Desktop ì´ˆê¸° ì„¤ì •');
        mainVideo.preload = 'metadata';
      }

      setupVideoEventListeners();

      try {
        console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹œë„...');
        await mainVideo.play();
        console.log('âœ… ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì„±ê³µ');
        currentVideoState = 'WAITING';
        waitingVideoPreloaded = true;
        updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');

        // ìŒì„± ì•ˆë‚´ í‘œì‹œ
        setTimeout(() => {
          if (!isAudioEnabled) {
            showInitialAudioGuide();
          }
        }, 1000);

      } catch (playError) {
        console.error('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', playError);
        if (playError.name === 'NotAllowedError') {
          console.log('ğŸ“± ìë™ì¬ìƒ ì°¨ë‹¨ë¨');
          showTouchToPlayGuide();
        } else {
          throw playError;
        }
      }

    } catch (error) {
      console.error('ì¦‰ì‹œ ì¬ìƒ ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  async function startWaitingVideoOnly() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      console.log('ğŸ¬ ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì‹œì‘:', waitingVideoUrl);
      console.log('ğŸ“± í”Œë«í¼:', BROWSER_INFO.platform);

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.autoplay = true;
      mainVideo.playsInline = true;
      mainVideo.style.display = 'block';

      // OSë³„ ì„¤ì •
      if (BROWSER_INFO.isIOSSafari) {
        mainVideo.preload = 'auto';
        mainVideo.removeAttribute('crossorigin');
      } else {
        mainVideo.preload = 'metadata';
      }

      setupVideoEventListeners();

      console.log('ğŸ¬ ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì‹œë„...');
      await mainVideo.play();
      console.log('âœ… ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì„±ê³µ');
      currentVideoState = 'WAITING';

    } catch (error) {
      console.error('ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  function setupCamera() {
    if (userMediaStream) {
      myCamera.srcObject = userMediaStream;
      myCamera.style.display = 'block';
      cameraPlaceholder.style.display = 'none';
      console.log('ğŸ“· ì¹´ë©”ë¼ ì„¤ì • ì™„ë£Œ');
    }
  }

  function handlePermissionError(error) {
    console.error('ê¶Œí•œ ì˜¤ë¥˜:', error);

    if (error.name === 'NotAllowedError') {
      updateStatusSmoothly('ê¶Œí•œì´ ê±°ë¶€ë¨');
      showPermissionErrorDialog('ì¹´ë©”ë¼ ë° ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    } else if (error.name === 'NotFoundError') {
      updateStatusSmoothly('ë¯¸ë””ì–´ ì¥ì¹˜ ì—†ìŒ');
      showPermissionErrorDialog('ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } else {
      updateStatusSmoothly('ê¶Œí•œ ì˜¤ë¥˜');
      showPermissionErrorDialog('ë¯¸ë””ì–´ ê¶Œí•œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function showPermissionErrorDialog(message) {
    permissionIcon.textContent = 'âŒ';
    permissionTitle.textContent = 'ê¶Œí•œ ì˜¤ë¥˜';
    permissionMessage.textContent = message;

    // ë²„íŠ¼ ë³€ê²½
    const buttons = document.querySelector('.permission-buttons');
    buttons.innerHTML = `
            <button class="permission-btn deny" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
            <button class="permission-btn allow" onclick="requestPermissions()">ë‹¤ì‹œ ì‹œë„</button>
        `;

    showPermissionModal();
  }

  function denyPermission() {
    console.log('âŒ ì‚¬ìš©ìê°€ ê¶Œí•œì„ ê±°ë¶€í•¨');
    updateStatusSmoothly('ê¶Œí•œ ì—†ì´ ì²´í—˜');
    hidePermissionModal();

    // ê¶Œí•œ ì—†ì´ ê¸°ë³¸ ì´ˆê¸°í™”
    initializeWithoutPermission();
  }

  function goBack() {
    console.log('ğŸ”™ ë’¤ë¡œê°€ê¸°');
    const hasOnboarding = hasCompletedOnboarding();
    const redirectPath = hasOnboarding ? '/mobile/home' : '/mobile/onboarding';
    window.location.href = redirectPath;
  }

  async function initializeWithoutPermission() {
    console.log('ğŸ¬ ê¶Œí•œ ì—†ì´ ì˜ìƒí†µí™” ì´ˆê¸°í™”');

    // ëŒ€ê¸° ì˜ìƒë§Œ ì‹¤í–‰
    try {
      await startWaitingVideoOnly();
      updateStatusSmoothly('ì²´í—˜ ëª¨ë“œ');

      // ì²´í—˜ ëª¨ë“œì„ì„ ì•Œë¦¬ëŠ” ë©”ì‹œì§€
      setTimeout(() => {
        showInfoMessage('ì²´í—˜ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\në…¹í™” ê¸°ëŠ¥ì€ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }, 2000);

    } catch (error) {
      console.error('ì²´í—˜ ëª¨ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  // ========== ì˜ìƒí†µí™” ì´ˆê¸°í™” (ê¶Œí•œ í›„) ==========

  async function initializeVideoCallAfterPermission() {
    try {
      console.log('ğŸš€ ê¶Œí•œ íšë“ í›„ ì˜ìƒí†µí™” ì´ˆê¸°í™” ì‹œì‘');

      // 1. ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
      const existingSession = loadSession();

      if (existingSession) {
        console.log('ğŸ“± ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬:', existingSession);

        const isValid = await validateSessionOnServer(existingSession.sessionKey);
        console.log('ğŸ” ì„œë²„ ì„¸ì…˜ ìœ íš¨ì„±:', isValid);

        if (isValid) {
          console.log('âœ… ê¸°ì¡´ ì„¸ì…˜ ì¬ì‚¬ìš©');
          sessionKey = existingSession.sessionKey;
          updateSessionInfoDisplay(existingSession);

          await startWaitingVideoImmediately();
          connectSSE();
          updateSessionActivity();
          updateStatusSmoothly(`${existingSession.contactName}ì™€ ì¬ì—°ê²° ì¤‘...`);
          return;
        } else {
          console.log('âŒ ê¸°ì¡´ ì„¸ì…˜ ë¬´íš¨ - ìƒˆë¡œ ìƒì„±');
          sessionStorage.removeItem(SESSION_STORAGE_KEY);
        }
      }

      // 2. ìƒˆ ì„¸ì…˜ ìƒì„±
      console.log('ğŸ†• ìƒˆ ì„¸ì…˜ ìƒì„±');
      await createNewSession();

    } catch (error) {
      console.error('âŒ ì˜ìƒí†µí™” ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
      handleInitializationError(error);
    }
  }

  async function createNewSession() {
    try {
      // 1. ì¦‰ì‹œ ëŒ€ê¸° ì˜ìƒ ì‹œì‘
      await startWaitingVideoImmediately();

      // 2. ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„¸ì…˜ ìƒì„±
      await initializeSessionInBackground();

      console.log('âœ… ìƒˆ ì„¸ì…˜ ìƒì„± ì™„ë£Œ');

    } catch (error) {
      console.error('ìƒˆ ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:', error);
      handleInitializationError(error);
    }
  }

  async function startWaitingVideoImmediately() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì¦‰ì‹œ ì‹œì‘:', waitingVideoUrl);

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.autoplay = true;
      mainVideo.playsInline = true;
      mainVideo.style.display = 'block';

      // iOS Safariì—ì„œ ì¤‘ìš”: crossOrigin ì„¤ì • ì œê±°
      mainVideo.removeAttribute('crossorigin');

      setupVideoEventListeners();

      // iOS Safariì—ì„œ ì‚¬ìš©ì ì œìŠ¤ì²˜ ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ ì¬ìƒ
      try {
        console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹œë„...');
        await mainVideo.play();
        console.log('âœ… ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì„±ê³µ');
        currentVideoState = 'WAITING';
        waitingVideoPreloaded = true;
        updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');

        // ìŒì„± ì•ˆë‚´ í‘œì‹œ
        setTimeout(() => {
          if (!isAudioEnabled) {
            showInitialAudioGuide();
          }
        }, 1000);

      } catch (playError) {
        console.error('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', playError);
        if (playError.name === 'NotAllowedError') {
          console.log('ğŸ“± ìë™ì¬ìƒ ì°¨ë‹¨ë¨');
          showTouchToPlayGuide();
        } else {
          throw playError;
        }
      }

    } catch (error) {
      console.error('ì¦‰ì‹œ ì¬ìƒ ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  async function startWaitingVideoOnly() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      console.log('ğŸ¬ ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì‹œì‘:', waitingVideoUrl);

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.autoplay = true;
      mainVideo.playsInline = true;
      mainVideo.style.display = 'block';

      // iOS Safariì—ì„œ ì¤‘ìš”: crossOrigin ì„¤ì • ì œê±°
      mainVideo.removeAttribute('crossorigin');

      setupVideoEventListeners();

      console.log('ğŸ¬ ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì‹œë„...');
      await mainVideo.play();
      console.log('âœ… ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì„±ê³µ');
      currentVideoState = 'WAITING';

    } catch (error) {
      console.error('ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  function showInitialAudioGuide() {
    console.log('ğŸ”Š ì´ˆê¸° ìŒì„± ì•ˆë‚´ í‘œì‹œ');

    if (!isAudioEnabled) {
      audioGuide.classList.add('show');
      muteBtn.classList.add('pulse');

      setTimeout(() => {
        hideAudioGuide();
      }, 3000);
    }
  }

  function showTouchToPlayGuide() {
    const guide = document.createElement('div');
    guide.id = 'touchGuide';
    guide.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            z-index: 200;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            animation: pulseGlow 2s ease-in-out infinite;
        `;
    guide.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¬</div>
            <div style="font-weight: 600; margin-bottom: 8px;">í™”ë©´ì„ í„°ì¹˜í•´ì£¼ì„¸ìš”</div>
            <div style="font-size: 14px; opacity: 0.8;">ì˜ìƒì„ ì‹œì‘í•˜ë ¤ë©´ í„°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤</div>
        `;

    guide.onclick = async () => {
      try {
        await mainVideo.play();
        guide.remove();
        console.log('âœ… ì‚¬ìš©ì í„°ì¹˜ë¡œ ì¬ìƒ ì‹œì‘');
        updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');
      } catch (e) {
        console.error('ìˆ˜ë™ ì¬ìƒ ì‹¤íŒ¨:', e);
      }
    };

    document.querySelector('.main-video-container').appendChild(guide);
  }

  // ========== ì„¸ì…˜ ê´€ë¦¬ ==========

  async function initializeSessionInBackground() {
    try {
      const contactName = getCurrentContactName();
      console.log('ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ìƒì„± ì¤‘:', contactName);

      const sessionResponse = await fetch('/api/video/create-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({contactName: contactName})
      });

      const sessionData = await sessionResponse.json();

      if (sessionData.status.code === 'OK_0000') {
        sessionKey = sessionData.response.sessionKey;
        console.log('âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ:', sessionKey);

        saveSession(sessionKey, contactName);
        connectSSE();
        startConnectionMonitoring();
        setupNetworkMonitoring();
        updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

      } else {
        throw new Error(sessionData.status.message);
      }

    } catch (error) {
      console.error('ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
      updateStatusSmoothly('ì—°ê²° ì¬ì‹œë„ ì¤‘...');

      setTimeout(() => {
        initializeSessionInBackground();
      }, 3000);
    }
  }

  async function validateSessionOnServer(sessionKey) {
    try {
      console.log('ğŸ” ì„œë²„ ì„¸ì…˜ ê²€ì¦:', sessionKey);

      const response = await fetch(`/api/video/session/${sessionKey}`, {
        method: 'GET',
        headers: {'Content-Type': 'application/json'},
        timeout: 10000
      });

      if (!response.ok) {
        if (response.status === 404 || response.status === 410) {
          console.log('âŒ ì„¸ì…˜ ë§Œë£Œ ë˜ëŠ” ì—†ìŒ');
          return false;
        }
        console.log('âš ï¸ ì„œë²„ ì˜¤ë¥˜ì§€ë§Œ ì„¸ì…˜ ì¬ì‚¬ìš© ì‹œë„');
        return true;
      }

      const data = await response.json();
      console.log('ğŸ” ì„œë²„ ì‘ë‹µ:', data);

      return data.status.code === 'OK_0000';

    } catch (error) {
      console.error('âŒ ì„¸ì…˜ ê²€ì¦ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
      return true; // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ê¸°ì¡´ ì„¸ì…˜ ì¬ì‚¬ìš©
    }
  }

  // ========== SSE ì—°ê²° ==========

  function connectSSE() {
    if (!sessionKey) {
      console.error('ì„¸ì…˜ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤');
      return;
    }

    console.log(`ğŸ”— SSE ì—°ê²° ì‹œë„:`, sessionKey);

    if (sseEventSource) {
      sseEventSource.close();
      sseEventSource = null;
    }

    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
      heartbeatInterval = null;
    }

    sseEventSource = new EventSource(`/api/video/stream/${sessionKey}`);
    lastHeartbeat = Date.now();

    sseEventSource.onopen = function (event) {
      console.log('âœ… SSE ì—°ê²° ì„±ê³µ');
      sseReconnectAttempts = 0;
      updateStatusSmoothly('ì—°ê²° ì¤‘...');
      startHeartbeat();
    };

    sseEventSource.addEventListener('connected', function (event) {
      try {
        const data = JSON.parse(event.data);
        console.log('ğŸ“¡ SSE ì—°ê²° ì™„ë£Œ:', data);

        if (data.reconnected) {
          updateStatusSmoothly(`${data.contactName}ì™€ ì¬ì—°ê²°ë¨`);
        } else {
          updateStatusSmoothly(`${data.contactName}ì™€ ì—°ê²°ë¨`);
        }

        lastHeartbeat = Date.now();
      } catch (error) {
        console.error('Connected ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error);
        updateStatusSmoothly('ì—°ê²°ë¨');
      }
    });

    sseEventSource.addEventListener('heartbeat', function (event) {
      lastHeartbeat = Date.now();
      updateSessionActivity();

      try {
        const data = JSON.parse(event.data);
        console.log('ğŸ’“ í•˜íŠ¸ë¹„íŠ¸:', data.sessionAge, 'ë¶„');

        const sessionData = loadSession();
        if (sessionData) {
          updateSessionInfoDisplay(sessionData);
        }
      } catch (error) {
        console.log('ğŸ’“ í•˜íŠ¸ë¹„íŠ¸ ìˆ˜ì‹ ');
      }
    });

    sseEventSource.addEventListener('response', function (event) {
      try {
        const data = JSON.parse(event.data);
        console.log('ğŸ¬ ì‘ë‹µ ì˜ìƒ ìˆ˜ì‹ :', data);
        lastHeartbeat = Date.now();
        updateSessionActivity();
        playResponseVideo(data.videoUrl);
      } catch (error) {
        console.error('Response ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error);
      }
    });

    sseEventSource.addEventListener('error', function (event) {
      console.error('âŒ SSE ì»¤ìŠ¤í…€ ì˜¤ë¥˜:', event);
      try {
        if (event.data) {
          const data = JSON.parse(event.data);
          console.error('ì˜¤ë¥˜ ë°ì´í„°:', data);
          updateStatusSmoothly('ì²˜ë¦¬ ì˜¤ë¥˜');
          showErrorMessage(data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (parseError) {
        console.error('ì˜¤ë¥˜ ì´ë²¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨:', parseError);
      }
    });

    sseEventSource.onerror = function (event) {
      console.error('ğŸ”¥ SSE ì—°ê²° ì˜¤ë¥˜:', event);

      switch (sseEventSource.readyState) {
        case EventSource.CONNECTING:
          console.log('ğŸ”„ SSE ì¬ì—°ê²° ì¤‘...');
          updateStatusSmoothly('ì¬ì—°ê²° ì¤‘...');
          return;
        case EventSource.CLOSED:
          console.log('ğŸš« SSE ì—°ê²° ë‹«í˜');
          updateStatusSmoothly('ì—°ê²° ì¢…ë£Œ');
          handleSSEReconnection();
          return;
        default:
          console.log('âš ï¸ SSE ì—°ê²° ë¶ˆì•ˆì •');
          updateStatusSmoothly('ì—°ê²° ë¶ˆì•ˆì •');
          handleSSEReconnection();
          return;
      }
    };
  }

  function startHeartbeat() {
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
    }

    heartbeatInterval = setInterval(() => {
      const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
      const heartbeatTimeout = 60000; // 60ì´ˆ

      if (timeSinceLastHeartbeat > heartbeatTimeout) {
        console.warn('ğŸ’” í•˜íŠ¸ë¹„íŠ¸ íƒ€ì„ì•„ì›ƒ - ì¬ì—°ê²° í•„ìš”');
        handleSSEReconnection();
      }
    }, 30000);
  }

  function handleSSEReconnection() {
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
      heartbeatInterval = null;
    }

    if (sseReconnectAttempts >= maxReconnectAttempts) {
      console.error('ğŸš¨ ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
      updateStatusSmoothly('ì—°ê²° ì‹¤íŒ¨');
      showErrorMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }

    sseReconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, sseReconnectAttempts - 1), 30000);

    console.log(`ğŸ”„ ${delay / 1000}ì´ˆ í›„ SSE ì¬ì—°ê²° ì‹œë„`);
    updateStatusSmoothly(`${Math.round(delay / 1000)}ì´ˆ í›„ ì¬ì—°ê²°...`);

    setTimeout(() => {
      if (sessionKey) {
        console.log('ğŸ”„ SSE ì¬ì—°ê²° ì‹œì‘');
        connectSSE();
      }
    }, delay);
  }

  function startConnectionMonitoring() {
    setInterval(() => {
      if (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN) {
        console.warn('âš ï¸ SSE ì—°ê²° ìƒíƒœ ì´ìƒ - ì¬ì—°ê²° ì‹œë„');
        handleSSEReconnection();
      }
    }, 300000); // 5ë¶„ë§ˆë‹¤
  }

  function setupNetworkMonitoring() {
    window.addEventListener('online', () => {
      console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
      updateStatusSmoothly('ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ë¨');

      setTimeout(() => {
        if (sessionKey && (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN)) {
          console.log('ğŸ”„ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ í›„ SSE ì¬ì—°ê²°');
          sseReconnectAttempts = 0;
          connectSSE();
        }
      }, 1000);
    });

    window.addEventListener('offline', () => {
      console.log('ğŸ“µ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
      updateStatusSmoothly('ë„¤íŠ¸ì›Œí¬ ì˜¤í”„ë¼ì¸');

      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    });
  }

  // ========== ë…¹í™” ê¸°ëŠ¥ ==========

  async function toggleRecording() {
    updateSessionActivity();

    if (!cameraPermissionGranted || !userMediaStream) {
      showInfoMessage('ë…¹í™” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    if (!isRecording) {
      await startRecording();
    } else {
      await stopRecording();
    }
  }

  async function startRecording() {
    try {
      recordedChunks = [];

      const options = {
        mimeType: 'video/webm;codecs=vp9,opus',
        videoBitsPerSecond: 5000000,
        audioBitsPerSecond: 128000
      };

      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options.mimeType = 'video/webm;codecs=vp8,opus';
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = 'video/webm';
        }
      }

      mediaRecorder = new MediaRecorder(userMediaStream, options);

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = () => {
        processRecordedVideo();
      };

      mediaRecorder.start();
      isRecording = true;

      recordBtn.classList.add('recording');
      recordIcon.textContent = 'â¹';
      updateStatusSmoothly('ë…¹í™” ì¤‘');

      console.log('ğŸ“¹ ë…¹í™” ì‹œì‘');

    } catch (error) {
      console.error('ë…¹í™” ì‹œì‘ ì˜¤ë¥˜:', error);
      showErrorMessage('ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }

  async function stopRecording() {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      isRecording = false;

      recordBtn.classList.remove('recording');
      recordIcon.textContent = 'âº';
      updateStatusSmoothly('ì²˜ë¦¬ ì¤‘');

      console.log('â¹ ë…¹í™” ì¤‘ì§€');
    }
  }

  async function processRecordedVideo() {
    if (!sessionKey) {
      showErrorMessage('ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      console.log('ğŸ“¹ ì˜ìƒ ì²˜ë¦¬ ì‹œì‘');
      updateStatusSmoothly('ì „ì†¡ ì¤‘...');
      updateSessionActivity();

      const blob = new Blob(recordedChunks, {type: 'video/webm'});
      const formData = new FormData();
      formData.append('video', blob, `recorded_video_${sessionKey}_${Date.now()}.webm`);

      console.log('ğŸ“¤ ì„œë²„ë¡œ ì˜ìƒ ì „ì†¡ ì¤‘...', blob.size, 'bytes');

      const response = await fetch(`/api/video/process/${sessionKey}`, {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        console.log('âœ… ì„œë²„ ì‘ë‹µ:', result);
        updateStatusSmoothly('ì²˜ë¦¬ ì¤‘...');
        console.log('ğŸ”„ SSE ì‘ë‹µ ëŒ€ê¸° ì¤‘...');
      } else {
        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
      }

    } catch (error) {
      console.error('ì˜ìƒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      updateStatusSmoothly('ì „ì†¡ ì‹¤íŒ¨');
      showErrorMessage('ì˜ìƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ========== OSë³„ ì´ˆê¸°ê°’ ì„¤ì • (ë‹¨ìˆœí™”) ==========

  // ë¸Œë¼ìš°ì € ë° OS ê°ì§€
  function getBrowserInfo() {
    const userAgent = navigator.userAgent;
    const isIOS = /iPad|iPhone|iPod/.test(userAgent);
    const isAndroid = /Android/.test(userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(userAgent);
    const isChrome = /Chrome/.test(userAgent);
    const isFirefox = /Firefox/.test(userAgent);

    return {
      isIOS,
      isAndroid,
      isSafari,
      isChrome,
      isFirefox,
      isIOSSafari: isIOS && isSafari,
      isAndroidChrome: isAndroid && isChrome,
      platform: isIOS ? 'iOS' : (isAndroid ? 'Android' : 'Desktop')
    };
  }

  // OSë³„ ë¹„ë””ì˜¤ ì„¤ì • (ë‹¨ìˆœí™”)
  function getVideoSettings() {
    const browser = getBrowserInfo();

    if (browser.isIOSSafari) {
      // iOS Safari: ì¦‰ì‹œ ì „í™˜ (ê¹œë¹¡ì„ ìµœì†Œí™”)
      return {
        transitionType: 'INSTANT',
        loadTimeout: 10000,
        volumeTransition: 'SAFE'
      };
    } else {
      // Android/Desktop: ë¶€ë“œëŸ¬ìš´ ì „í™˜
      return {
        transitionType: 'SMOOTH',
        loadTimeout: 10000,
        volumeTransition: 'SMOOTH'
      };
    }
  }

  // ì „ì—­ ì„¤ì • ë³€ìˆ˜
  const VIDEO_SETTINGS = getVideoSettings();
  const BROWSER_INFO = getBrowserInfo();

  console.log('ğŸ”§ ë¸Œë¼ìš°ì € ì •ë³´:', BROWSER_INFO);
  console.log('âš™ï¸ ë¹„ë””ì˜¤ ì„¤ì • (ë‹¨ìˆœí™”):', VIDEO_SETTINGS);

  // ========== í„°ì¹˜ë¡œ ì¬ìƒ ê°€ì´ë“œ (ë‹¨ìˆœí™”) ==========

  function showTouchToPlayGuide() {
    const guide = document.createElement('div');
    guide.id = 'touchGuide';
    guide.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            z-index: 200;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            animation: pulseGlow 2s ease-in-out infinite;
        `;
    guide.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¬</div>
            <div style="font-weight: 600; margin-bottom: 8px;">í™”ë©´ì„ í„°ì¹˜í•´ì£¼ì„¸ìš”</div>
            <div style="font-size: 14px; opacity: 0.8;">ì˜ìƒì„ ì‹œì‘í•˜ë ¤ë©´ í„°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤</div>
        `;

    guide.onclick = async () => {
      try {
        await mainVideo.play();
        guide.remove();
        console.log('âœ… ì‚¬ìš©ì í„°ì¹˜ë¡œ ì¬ìƒ ì‹œì‘');
        updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');
      } catch (e) {
        console.error('ìˆ˜ë™ ì¬ìƒ ì‹¤íŒ¨:', e);
        guide.remove();
        showStaticBackground();
      }
    };

    document.querySelector('.main-video-container').appendChild(guide);
  }

  // ========== ìŒì†Œê±° ê¸°ëŠ¥ (ë‹¨ìˆœí™”) ==========

  async function enableAudio() {
    try {
      console.log('ğŸ”Š ì˜¤ë””ì˜¤ í™œì„±í™” ì‹œì‘');

      // ë‹¨ìˆœí•˜ê²Œ ìŒì†Œê±° í•´ì œ
      mainVideo.muted = false;

      if (BROWSER_INFO.isIOSSafari) {
        // iOS Safari: ì•ˆì „í•œ ë³¼ë¥¨ ì„¤ì •
        mainVideo.volume = 0.1;

        // ì¬ìƒ ì¤‘ì´ë©´ ì¬ìƒ ìƒíƒœ ìœ ì§€
        if (!mainVideo.paused) {
          try {
            await mainVideo.play();
          } catch (playError) {
            console.warn('âš ï¸ iOS ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', playError);
          }
        }

        // ë³¼ë¥¨ ì •ìƒ ì„¤ì •
        mainVideo.volume = 0.8;

      } else {
        // Android/Desktop: ë¶€ë“œëŸ¬ìš´ ë³¼ë¥¨ ì„¤ì •
        mainVideo.volume = 0.01;

        // ì¬ìƒ ì¤‘ì´ë©´ ì¬ìƒ ìƒíƒœ ìœ ì§€
        if (!mainVideo.paused) {
          await mainVideo.play();
        }

        mainVideo.volume = 0.8;
      }

      isAudioEnabled = true;
      muteIcon.textContent = 'ğŸ”Š';
      muteBtn.classList.add('active');
      muteBtn.classList.remove('pulse');

      hideAudioGuide();
      showSuccessMessage('ìŒì„±ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
      console.log('âœ… ì˜¤ë””ì˜¤ í™œì„±í™” ì™„ë£Œ');

    } catch (error) {
      console.error('ì˜¤ë””ì˜¤ í™œì„±í™” ì‹¤íŒ¨:', error);
      showErrorMessage('ìŒì„± í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ========== ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ì„¤ì • (ë‹¨ìˆœí™”) ==========

  function setupVideoEventListeners() {
    // ë‹¨ìˆœí•œ ì˜¤ë¥˜ ì²˜ë¦¬ë§Œ
    mainVideo.addEventListener('error', (e) => {
      console.error('ë¹„ë””ì˜¤ ì˜¤ë¥˜:', e);
      if (currentVideoState === 'WAITING') {
        showStaticBackground();
      }
    });

    // ê¸°ë³¸ ì´ë²¤íŠ¸ë“¤
    mainVideo.addEventListener('loadstart', () => {
      console.log('ğŸ”„ ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘');
    });

    mainVideo.addEventListener('canplay', () => {
      console.log('â–¶ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
    });

    mainVideo.addEventListener('play', () => {
      console.log('â–¶ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘');
    });

    mainVideo.addEventListener('pause', () => {
      console.log('â¸ï¸ ë¹„ë””ì˜¤ ì¼ì‹œì •ì§€');
    });
  }

  // ========== ì˜ìƒ ì¬ìƒ (MVP ë°©ì‹ìœ¼ë¡œ ë‹¨ìˆœí™”) ==========

  async function playResponseVideo(videoUrl) {
    if (videoTransitionInProgress) {
      console.log('â³ ì˜ìƒ ì „í™˜ ì¤‘ì´ë¯€ë¡œ ëŒ€ê¸°');
      return;
    }

    try {
      videoTransitionInProgress = true;
      console.log('ğŸ¬ ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì‹œì‘ (MVP ë°©ì‹):', videoUrl);

      updateStatusSmoothly('ì‘ë‹µ ì¬ìƒ ì¤‘');
      currentVideoState = 'TRANSITIONING';

      // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•œ í˜ì´ë“œ ì•„ì›ƒ
      await fadeOutVideo();

      // MVP ë°©ì‹: ë‹¨ìˆœí•˜ê²Œ srcë§Œ ë³€ê²½
      await playVideoSimple(videoUrl, false); // loop = false

      // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•œ í˜ì´ë“œ ì¸
      await fadeInVideo();

      currentVideoState = 'RESPONSE';
      console.log('âœ… ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì„±ê³µ (MVP ë°©ì‹)');

      if (!isAudioEnabled) {
        showAudioGuide();
      }

      // ì˜ìƒ ì¢…ë£Œ ì‹œ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€
      const onVideoEnded = async () => {
        console.log('ğŸ”„ ì‘ë‹µ ì˜ìƒ ì¢…ë£Œ, ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
        mainVideo.removeEventListener('ended', onVideoEnded);
        await returnToWaitingVideo();
      };

      mainVideo.addEventListener('ended', onVideoEnded);

    } catch (error) {
      console.error('ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜:', error);
      await handleResponseVideoError(error);
    } finally {
      videoTransitionInProgress = false;
    }
  }

  // MVP ë°©ì‹ ë‹¨ìˆœ ë¹„ë””ì˜¤ ì¬ìƒ
  async function playVideoSimple(videoUrl, loop = true) {
    return new Promise((resolve, reject) => {
      console.log('ğŸ¬ ë‹¨ìˆœ ë¹„ë””ì˜¤ ì¬ìƒ:', videoUrl);

      // ê¸°ë³¸ ì„¤ì •
      mainVideo.src = videoUrl;
      mainVideo.loop = loop;
      mainVideo.muted = !isAudioEnabled;
      mainVideo.playsInline = true;

      if (isAudioEnabled) {
        mainVideo.volume = 0.8;
      }

      // ë‹¨ìˆœí•œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (MVP ë°©ì‹)
      const onLoadedMetadata = () => {
        console.log('âœ… ë¹„ë””ì˜¤ ë¡œë”© ì™„ë£Œ');
        cleanup();
        mainVideo.play()
                .then(() => {
                  console.log('âœ… ë¹„ë””ì˜¤ ì¬ìƒ ì„±ê³µ');
                  resolve();
                })
                .catch(reject);
      };

      const onError = (error) => {
        console.error('âŒ ë¹„ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨:', error);
        cleanup();
        reject(error);
      };

      const cleanup = () => {
        mainVideo.removeEventListener('loadedmetadata', onLoadedMetadata);
        mainVideo.removeEventListener('error', onError);
        if (timeout) clearTimeout(timeout);
      };

      // ì´ë²¤íŠ¸ ë“±ë¡
      mainVideo.addEventListener('loadedmetadata', onLoadedMetadata);
      mainVideo.addEventListener('error', onError);

      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
      const timeout = setTimeout(() => {
        console.warn('â° ë¹„ë””ì˜¤ ë¡œë”© íƒ€ì„ì•„ì›ƒ');
        cleanup();
        // íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ ì¬ìƒ ì‹œë„
        mainVideo.play()
                .then(() => {
                  console.log('âœ… íƒ€ì„ì•„ì›ƒ í›„ ì¬ìƒ ì„±ê³µ');
                  resolve();
                })
                .catch(reject);
      }, 10000);

      // ë¡œë”© ì‹œì‘
      mainVideo.load();
    });
  }

  // ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ ì•„ì›ƒ
  async function fadeOutVideo() {
    if (!VIDEO_SETTINGS.transitionType === 'SMOOTH') return;

    console.log('ğŸŒ… ë¹„ë””ì˜¤ í˜ì´ë“œ ì•„ì›ƒ');

    return new Promise((resolve) => {
      mainVideo.style.transition = 'opacity 0.3s ease';
      mainVideo.style.opacity = '0';

      setTimeout(() => {
        resolve();
      }, 300);
    });
  }

  // ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ ì¸
  async function fadeInVideo() {
    if (!VIDEO_SETTINGS.transitionType === 'SMOOTH') return;

    console.log('ğŸŒ„ ë¹„ë””ì˜¤ í˜ì´ë“œ ì¸');

    return new Promise((resolve) => {
      mainVideo.style.transition = 'opacity 0.3s ease';
      mainVideo.style.opacity = '1';

      setTimeout(() => {
        // ì „í™˜ ì™„ë£Œ í›„ transition ì œê±°
        mainVideo.style.transition = '';
        resolve();
      }, 300);
    });
  }

  // ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ (MVP ë°©ì‹)
  async function returnToWaitingVideo() {
    try {
      console.log('ğŸ”„ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ (MVP ë°©ì‹)');

      currentVideoState = 'TRANSITIONING';
      updateStatusSmoothly('ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ ì¤‘...');

      // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•œ í˜ì´ë“œ ì•„ì›ƒ
      await fadeOutVideo();

      // MVP ë°©ì‹: ë‹¨ìˆœí•˜ê²Œ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³€ê²½
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';
      await playVideoSimple(waitingVideoUrl, true); // loop = true

      // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•œ í˜ì´ë“œ ì¸
      await fadeInVideo();

      currentVideoState = 'WAITING';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
      console.log('âœ… ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì™„ë£Œ');

    } catch (error) {
      console.error('âŒ ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì‹¤íŒ¨:', error);

      // ì‹¤íŒ¨ ì‹œ ê°•ì œ ë³µêµ¬
      currentVideoState = 'WAITING';
      mainVideo.style.opacity = '1';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
    }
  }

  // ì´ˆê¸° ëŒ€ê¸° ì˜ìƒ ì‹œì‘ (MVP ë°©ì‹)
  async function startWaitingVideoImmediately() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì‹œì‘ (MVP ë°©ì‹):', waitingVideoUrl);

      mainVideo.style.display = 'block';
      mainVideo.style.opacity = '1';

      // MVP ë°©ì‹ìœ¼ë¡œ ëŒ€ê¸° ì˜ìƒ ì‹œì‘
      await playVideoSimple(waitingVideoUrl, true);

      currentVideoState = 'WAITING';
      waitingVideoPreloaded = true;
      updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');

      // ìŒì„± ì•ˆë‚´ í‘œì‹œ
      setTimeout(() => {
        if (!isAudioEnabled) {
          showInitialAudioGuide();
        }
      }, 1000);

    } catch (error) {
      console.error('ì¦‰ì‹œ ì¬ìƒ ì‹¤íŒ¨:', error);

      if (error.name === 'NotAllowedError') {
        console.log('ğŸ“± ìë™ì¬ìƒ ì°¨ë‹¨ë¨');
        showTouchToPlayGuide();
      } else {
        showStaticBackground();
      }
    }
  }

  // ì²´í—˜ ëª¨ë“œ ëŒ€ê¸° ì˜ìƒ (MVP ë°©ì‹)
  async function startWaitingVideoOnly() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      console.log('ğŸ¬ ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì‹œì‘ (MVP ë°©ì‹):', waitingVideoUrl);

      mainVideo.style.display = 'block';
      mainVideo.style.opacity = '1';

      // MVP ë°©ì‹ìœ¼ë¡œ ì²´í—˜ ëª¨ë“œ ì‹œì‘
      await playVideoSimple(waitingVideoUrl, true);

      currentVideoState = 'WAITING';
      console.log('âœ… ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì„±ê³µ');

    } catch (error) {
      console.error('ì²´í—˜ ëª¨ë“œ ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  // ì˜¤ë¥˜ ì²˜ë¦¬ (MVP ë°©ì‹)
  async function handleResponseVideoError(error) {
    console.error('ì‘ë‹µ ì˜ìƒ ì˜¤ë¥˜:', error);

    if (error.name === 'NotAllowedError') {
      console.log('ğŸ”Š ìë™ì¬ìƒ ì°¨ë‹¨ - ìŒì„± ì•ˆë‚´ í‘œì‹œ');
      showAudioGuide();
    }

    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ (MVP ë°©ì‹)
    try {
      console.log('ğŸ”„ ì˜¤ë¥˜ ë³µêµ¬: ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
      await returnToWaitingVideo();
      console.log('âœ… ì˜¤ë¥˜ ë³µêµ¬ ì™„ë£Œ');

    } catch (recoveryError) {
      console.error('âŒ ì˜¤ë¥˜ ë³µêµ¬ ì‹¤íŒ¨:', recoveryError);

      // ìµœí›„ì˜ ìˆ˜ë‹¨: ì§ì ‘ ëŒ€ê¸° ì˜ìƒ ì„¤ì •
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';
      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.style.opacity = '1';

      try {
        await mainVideo.play();
        currentVideoState = 'WAITING';
        updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
      } catch (finalError) {
        console.error('âŒ ìµœí›„ì˜ ë³µêµ¬ë„ ì‹¤íŒ¨:', finalError);
        showStaticBackground();
      }
    }
  }

  // ========== ì´ˆê¸°í™” ì‹œ iOS Safari ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ==========

  async function initializeVideoCallAfterPermission() {
    try {
      console.log('ğŸš€ ê¶Œí•œ íšë“ í›„ ì˜ìƒí†µí™” ì´ˆê¸°í™” ì‹œì‘');

      // iOS Safari ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
      if (BROWSER_INFO.isIOSSafari) {
        monitorIOSVideoState();
      }

      // 1. ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
      const existingSession = loadSession();

      if (existingSession) {
        console.log('ğŸ“± ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬:', existingSession);

        const isValid = await validateSessionOnServer(existingSession.sessionKey);
        console.log('ğŸ” ì„œë²„ ì„¸ì…˜ ìœ íš¨ì„±:', isValid);

        if (isValid) {
          console.log('âœ… ê¸°ì¡´ ì„¸ì…˜ ì¬ì‚¬ìš©');
          sessionKey = existingSession.sessionKey;
          updateSessionInfoDisplay(existingSession);

          await startWaitingVideoImmediately();
          connectSSE();
          updateSessionActivity();
          updateStatusSmoothly(`${existingSession.contactName}ì™€ ì¬ì—°ê²° ì¤‘...`);
          return;
        } else {
          console.log('âŒ ê¸°ì¡´ ì„¸ì…˜ ë¬´íš¨ - ìƒˆë¡œ ìƒì„±');
          sessionStorage.removeItem(SESSION_STORAGE_KEY);
        }
      }

      // 2. ìƒˆ ì„¸ì…˜ ìƒì„±
      console.log('ğŸ†• ìƒˆ ì„¸ì…˜ ìƒì„±');
      await createNewSession();

    } catch (error) {
      console.error('âŒ ì˜ìƒí†µí™” ì´ˆê¸°í™” ì˜¤ë¥˜:', error);

      // iOS Safari ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ í´ë°±
      if (BROWSER_INFO.isIOSSafari) {
        console.log('ğŸ†˜ iOS Safari ì´ˆê¸°í™” ì‹¤íŒ¨ - í´ë°± ëª¨ë“œ');
        await fallbackToWaitingVideoOnly();
      } else {
        handleInitializationError(error);
      }
    }
  }

  // ========== ê¶Œí•œ ì—†ì´ ì´ˆê¸°í™” ì‹œì—ë„ iOS Safari ëª¨ë‹ˆí„°ë§ ==========

  async function initializeWithoutPermission() {
    console.log('ğŸ¬ ê¶Œí•œ ì—†ì´ ì˜ìƒí†µí™” ì´ˆê¸°í™”');

    // iOS Safari ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
    if (BROWSER_INFO.isIOSSafari) {
      monitorIOSVideoState();
    }

    // ëŒ€ê¸° ì˜ìƒë§Œ ì‹¤í–‰
    try {
      await startWaitingVideoOnly();
      updateStatusSmoothly('ì²´í—˜ ëª¨ë“œ');

      // ì²´í—˜ ëª¨ë“œì„ì„ ì•Œë¦¬ëŠ” ë©”ì‹œì§€
      setTimeout(() => {
        showInfoMessage('ì²´í—˜ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\në…¹í™” ê¸°ëŠ¥ì€ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }, 2000);

    } catch (error) {
      console.error('ì²´í—˜ ëª¨ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);

      // iOS Safari ì‹¤íŒ¨ ì‹œ í´ë°±
      if (BROWSER_INFO.isIOSSafari) {
        console.log('ğŸ†˜ iOS Safari ì²´í—˜ ëª¨ë“œ ì‹¤íŒ¨ - í´ë°±');
        await fallbackToWaitingVideoOnly();
      } else {
        showStaticBackground();
      }
    }
  }

  // iOS Safari ì „ìš©: SRC êµì²´ ë°©ì‹
  async function playResponseVideoSrcReplace(videoUrl) {
    console.log('ğŸ iOS Safari SRC êµì²´ ëª¨ë“œ ì‹œì‘');

    // í˜„ì¬ ìƒíƒœ ì €ì¥
    const originalSrc = mainVideo.src;
    const originalLoop = mainVideo.loop;
    const originalMuted = mainVideo.muted;

    try {
      // ì‘ë‹µ ì˜ìƒ ì„¤ì •
      mainVideo.src = videoUrl;
      mainVideo.loop = false;
      mainVideo.muted = !isAudioEnabled;
      mainVideo.currentTime = 0;
      mainVideo.playsInline = true;

      if (isAudioEnabled) {
        mainVideo.volume = 0.8;
      }

      // ë¡œë”© ëŒ€ê¸°
      await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('iOS ì˜ìƒ ë¡œë”© íƒ€ì„ì•„ì›ƒ'));
        }, VIDEO_SETTINGS.loadTimeout);

        const events = ['loadeddata', 'canplay'];
        let resolved = false;

        const handleLoad = () => {
          if (!resolved) {
            resolved = true;
            clearTimeout(timeout);
            events.forEach(event => {
              mainVideo.removeEventListener(event, handleLoad);
            });
            resolve();
          }
        };

        events.forEach(event => {
          mainVideo.addEventListener(event, handleLoad);
        });

        mainVideo.load();
      });

      // ì¬ìƒ ì‹œì‘
      await mainVideo.play();

      currentVideoState = 'RESPONSE';
      console.log('âœ… iOS Safari ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì„±ê³µ');

      if (!isAudioEnabled) {
        showAudioGuide();
      }

      // ì¢…ë£Œ ì´ë²¤íŠ¸
      const onVideoEnded = async () => {
        mainVideo.removeEventListener('ended', onVideoEnded);
        await returnToWaitingVideoSrcReplace(originalSrc, originalLoop, originalMuted);
      };

      mainVideo.addEventListener('ended', onVideoEnded);

    } catch (error) {
      console.error('âŒ iOS Safari ì‘ë‹µ ì˜ìƒ ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  // Android/Desktop: ì˜¤ë²„ë ˆì´ ë°©ì‹ (ê¸°ì¡´ ë¶€ë“œëŸ¬ìš´ ì „í™˜)
  async function playResponseVideoOverlay(videoUrl) {
    console.log('ğŸ¤– Android/Desktop ì˜¤ë²„ë ˆì´ ëª¨ë“œ ì‹œì‘');

    try {
      // ì‘ë‹µ ì˜ìƒ ìš”ì†Œ ìƒì„±
      const responseVideo = document.createElement('video');
      responseVideo.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
                background: #000;
                opacity: 0;
                transition: opacity 0.5s ease;
                z-index: 10;
            `;

      responseVideo.src = videoUrl;
      responseVideo.loop = false;
      responseVideo.muted = !isAudioEnabled;
      responseVideo.preload = VIDEO_SETTINGS.preloadStrategy;
      responseVideo.playsInline = true;

      if (isAudioEnabled) {
        responseVideo.volume = 0.8;
      }

      document.querySelector('.main-video-container').appendChild(responseVideo);

      // ë¡œë”© ëŒ€ê¸°
      await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Android ì˜ìƒ ë¡œë”© íƒ€ì„ì•„ì›ƒ'));
        }, VIDEO_SETTINGS.loadTimeout);

        responseVideo.addEventListener('canplaythrough', () => {
          clearTimeout(timeout);
          resolve();
        }, {once: true});

        responseVideo.addEventListener('error', (e) => {
          clearTimeout(timeout);
          reject(e);
        }, {once: true});
      });

      // ì¬ìƒ ì‹œì‘
      await responseVideo.play();

      // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼
      if (VIDEO_SETTINGS.transitionType === 'SMOOTH') {
        responseVideo.style.opacity = '1';
        mainVideo.style.opacity = '0.2';
      } else {
        responseVideo.style.opacity = '1';
        mainVideo.style.opacity = '0';
      }

      currentVideoState = 'RESPONSE';
      console.log('âœ… Android/Desktop ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì„±ê³µ');

      if (!isAudioEnabled) {
        showAudioGuide();
      }

      // ì¢…ë£Œ ì´ë²¤íŠ¸
      responseVideo.addEventListener('ended', async () => {
        console.log('ğŸ”„ Android/Desktop ì‘ë‹µ ì˜ìƒ ì¢…ë£Œ');
        await returnToWaitingVideoOverlay(responseVideo);
      }, {once: true});

    } catch (error) {
      console.error('âŒ Android/Desktop ì‘ë‹µ ì˜ìƒ ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  // ========== iOS Safari ë””ë²„ê¹… ë° í´ë°± ì „ëµ ==========

  // iOS Safari ìƒíƒœ ëª¨ë‹ˆí„°ë§
  function monitorIOSVideoState() {
    if (!BROWSER_INFO.isIOSSafari) return;

    console.log('ğŸ iOS Safari ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘');

    setInterval(() => {
      const state = {
        src: mainVideo.src,
        currentTime: mainVideo.currentTime,
        duration: mainVideo.duration,
        paused: mainVideo.paused,
        ended: mainVideo.ended,
        readyState: mainVideo.readyState,
        networkState: mainVideo.networkState,
        error: mainVideo.error
      };

      console.log('ğŸ“Š iOS Safari ë¹„ë””ì˜¤ ìƒíƒœ:', state);

      // ë¹„ì •ìƒ ìƒíƒœ ê°ì§€ ë° ë³µêµ¬
      if (currentVideoState === 'RESPONSE' && mainVideo.paused && !mainVideo.ended) {
        console.warn('âš ï¸ iOS Safari ë¹„ì •ìƒ ìƒíƒœ ê°ì§€ - ë³µêµ¬ ì‹œë„');

        setTimeout(async () => {
          try {
            await mainVideo.play();
            console.log('âœ… iOS Safari ë¹„ì •ìƒ ìƒíƒœ ë³µêµ¬ ì„±ê³µ');
          } catch (error) {
            console.error('âŒ iOS Safari ë¹„ì •ìƒ ìƒíƒœ ë³µêµ¬ ì‹¤íŒ¨:', error);
          }
        }, 500);
      }

    }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒíƒœ ì²´í¬
  }

  // iOS Safari í´ë°±: ëŒ€ê¸° ì˜ìƒë§Œ ì¬ìƒ
  async function fallbackToWaitingVideoOnly() {
    console.log('ğŸ†˜ iOS Safari í´ë°±: ëŒ€ê¸° ì˜ìƒë§Œ ì¬ìƒ');

    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      // ì™„ì „ ì´ˆê¸°í™”
      mainVideo.pause();
      mainVideo.removeAttribute('src');
      mainVideo.load();

      await new Promise(resolve => setTimeout(resolve, 300));

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.playsInline = true;
      mainVideo.autoplay = false;

      await new Promise(resolve => setTimeout(resolve, 500));

      await mainVideo.play();

      currentVideoState = 'WAITING';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘ (iOS ëª¨ë“œ)');

      // ì‘ë‹µ ì˜ìƒ ì¬ìƒ ë¹„í™œì„±í™”
      window.disableResponseVideo = true;

      console.log('âœ… iOS Safari í´ë°± ì™„ë£Œ');

      // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
      showInfoMessage('iOS Safariì—ì„œ ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.\nëŒ€ê¸° ì˜ìƒë§Œ ì¬ìƒë©ë‹ˆë‹¤.');

    } catch (error) {
      console.error('âŒ iOS Safari í´ë°± ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  // iOS Safari ì‘ë‹µ ì˜ìƒ ì¬ìƒ (í´ë°± í¬í•¨)
  async function playResponseVideoSrcReplaceWithFallback(videoUrl) {
    console.log('ğŸ iOS Safari ì‘ë‹µ ì˜ìƒ ì¬ìƒ (í´ë°± í¬í•¨)');

    // ì´ë¯¸ í´ë°± ëª¨ë“œì¸ ê²½ìš° ìŠ¤í‚µ
    if (window.disableResponseVideo) {
      console.log('â­ï¸ iOS Safari í´ë°± ëª¨ë“œ - ì‘ë‹µ ì˜ìƒ ìŠ¤í‚µ');
      showInfoMessage('ì‘ë‹µ ì˜ìƒì„ ë°›ì•˜ì§€ë§Œ iOS Safari ì œí•œìœ¼ë¡œ ì¸í•´ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      // ì²« ë²ˆì§¸ ì‹œë„: ê¸°ì¡´ ë°©ë²•
      await playResponseVideoSrcReplace(videoUrl);

    } catch (error) {
      console.error('âŒ iOS Safari ì²« ë²ˆì§¸ ì‹œë„ ì‹¤íŒ¨:', error);

      try {
        // ë‘ ë²ˆì§¸ ì‹œë„: ë” ê°„ë‹¨í•œ ë°©ë²•
        console.log('ğŸ”„ iOS Safari ë‘ ë²ˆì§¸ ì‹œë„');
        await playResponseVideoSimpleIOS(videoUrl);

      } catch (secondError) {
        console.error('âŒ iOS Safari ë‘ ë²ˆì§¸ ì‹œë„ ì‹¤íŒ¨:', secondError);

        // ì„¸ ë²ˆì§¸ ì‹œë„: í´ë°± ëª¨ë“œ
        console.log('ğŸ†˜ iOS Safari í´ë°± ëª¨ë“œ í™œì„±í™”');
        await fallbackToWaitingVideoOnly();

        throw secondError;
      }
    }
  }

  // iOS Safari ë‹¨ìˆœ ì¬ìƒ ì‹œë„
  async function playResponseVideoSimpleIOS(videoUrl) {
    console.log('ğŸ iOS Safari ë‹¨ìˆœ ì¬ìƒ ì‹œë„');

    try {
      // ë§¤ìš° ë‹¨ìˆœí•œ ì ‘ê·¼
      mainVideo.src = videoUrl;
      mainVideo.loop = false;
      mainVideo.muted = !isAudioEnabled;
      mainVideo.playsInline = true;

      if (isAudioEnabled) {
        mainVideo.volume = 0.8;
      }

      // ë¡œë”© ì—†ì´ ë°”ë¡œ ì¬ìƒ ì‹œë„
      console.log('ğŸš€ iOS Safari ì¦‰ì‹œ ì¬ìƒ ì‹œë„');
      await mainVideo.play();

      currentVideoState = 'RESPONSE';
      console.log('âœ… iOS Safari ë‹¨ìˆœ ì¬ìƒ ì„±ê³µ');

      if (!isAudioEnabled) {
        showAudioGuide();
      }

      // ì¢…ë£Œ ì´ë²¤íŠ¸
      const onVideoEnded = async () => {
        console.log('ğŸ”„ iOS Safari ë‹¨ìˆœ ì¬ìƒ ì¢…ë£Œ');
        mainVideo.removeEventListener('ended', onVideoEnded);

        // ë‹¨ìˆœ ë³µê·€
        try {
          const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';
          mainVideo.src = waitingVideoUrl;
          mainVideo.loop = true;
          mainVideo.muted = true;
          await mainVideo.play();

          currentVideoState = 'WAITING';
          updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

        } catch (returnError) {
          console.error('âŒ iOS Safari ë‹¨ìˆœ ë³µê·€ ì‹¤íŒ¨:', returnError);
          await emergencyRecoveryIOS();
        }
      };

      mainVideo.addEventListener('ended', onVideoEnded);

    } catch (error) {
      console.error('âŒ iOS Safari ë‹¨ìˆœ ì¬ìƒ ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  // Android/Desktop ëŒ€ê¸° ì˜ìƒ ë³µê·€ (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
  async function returnToWaitingVideoOverlay(responseVideo) {
    try {
      console.log('ğŸ¤– Android/Desktop ëŒ€ê¸° ì˜ìƒ ë³µê·€');

      currentVideoState = 'TRANSITIONING';

      // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼
      if (VIDEO_SETTINGS.transitionType === 'SMOOTH') {
        mainVideo.style.transition = 'opacity 0.5s ease';
        mainVideo.style.opacity = '1';
        responseVideo.style.opacity = '0';

        // ì „í™˜ ì™„ë£Œ í›„ ì •ë¦¬
        setTimeout(() => {
          if (responseVideo.parentNode) {
            responseVideo.parentNode.removeChild(responseVideo);
          }
        }, 500);
      } else {
        // ì¦‰ì‹œ ì „í™˜
        mainVideo.style.opacity = '1';
        if (responseVideo.parentNode) {
          responseVideo.parentNode.removeChild(responseVideo);
        }
      }

      currentVideoState = 'WAITING';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
      console.log('âœ… Android/Desktop ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì™„ë£Œ');

    } catch (error) {
      console.error('âŒ Android/Desktop ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì‹¤íŒ¨:', error);
      if (responseVideo.parentNode) {
        responseVideo.parentNode.removeChild(responseVideo);
      }
      currentVideoState = 'WAITING';
      mainVideo.style.opacity = '1';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
    }
  }

  async function returnToWaitingVideoDirectly(originalSrc, originalLoop, originalMuted) {
    try {
      console.log('ğŸ”„ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ì§ì ‘ ë³µê·€ ì‹œì‘');
      console.log('ğŸ“ ë³µê·€í•  ì˜ìƒ ì •ë³´:', {
        originalSrc: originalSrc,
        originalLoop: originalLoop,
        originalMuted: originalMuted
      });

      currentVideoState = 'TRANSITIONING';

      // ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ì„¤ì • ë³µì›
      mainVideo.src = originalSrc;
      mainVideo.loop = originalLoop;
      mainVideo.muted = originalMuted;
      mainVideo.currentTime = 0;

      console.log('ğŸ”„ ëŒ€ê¸° ì˜ìƒ ë¡œë”© ì‹œì‘...');

      // ëŒ€ê¸° ì˜ìƒ ë¡œë”© ëŒ€ê¸°
      await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          console.error('â° ëŒ€ê¸° ì˜ìƒ ë¡œë”© íƒ€ì„ì•„ì›ƒ');
          reject(new Error('ëŒ€ê¸° ì˜ìƒ ë¡œë”© íƒ€ì„ì•„ì›ƒ'));
        }, 10000);

        const onCanPlay = () => {
          console.log('âœ… ëŒ€ê¸° ì˜ìƒ ë¡œë”© ì™„ë£Œ');
          clearTimeout(timeout);
          mainVideo.removeEventListener('canplay', onCanPlay);
          mainVideo.removeEventListener('error', onError);
          resolve();
        };

        const onError = (e) => {
          console.error('âŒ ëŒ€ê¸° ì˜ìƒ ë¡œë”© ì˜¤ë¥˜:', e);
          clearTimeout(timeout);
          mainVideo.removeEventListener('canplay', onCanPlay);
          mainVideo.removeEventListener('error', onError);
          reject(e);
        };

        mainVideo.addEventListener('canplay', onCanPlay);
        mainVideo.addEventListener('error', onError);

        // ë¡œë”© ì‹œì‘
        mainVideo.load();
      });

      console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹œì‘...');

      // ëŒ€ê¸° ì˜ìƒ ì¬ìƒ
      await mainVideo.play();

      console.log('âœ… ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì„±ê³µ');

      currentVideoState = 'WAITING';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

      console.log('âœ… ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ ì™„ë£Œ');

    } catch (error) {
      console.error('ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì˜¤ë¥˜:', error);

      // ì‹¤íŒ¨ ì‹œ í´ë°±
      currentVideoState = 'WAITING';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

      // ëŒ€ê¸° ì˜ìƒ ì¬ì‹œë„
      setTimeout(async () => {
        try {
          console.log('ğŸ”„ ëŒ€ê¸° ì˜ìƒ ì¬ì‹œë„...');
          await mainVideo.play();
          console.log('âœ… ëŒ€ê¸° ì˜ìƒ ì¬ì‹œë„ ì„±ê³µ');
        } catch (retryError) {
          console.error('âŒ ëŒ€ê¸° ì˜ìƒ ì¬ì‹œë„ ì‹¤íŒ¨:', retryError);
          showStaticBackground();
        }
      }, 1000);
    }
  }

  // ========== ìŒì†Œê±° ê¸°ëŠ¥ (iOS Safari ìµœì í™”) ==========

  async function toggleMute() {
    updateSessionActivity();

    try {
      if (!isAudioEnabled) {
        await enableAudio();
      } else {
        disableAudio();
      }
    } catch (error) {
      console.error('ìŒì†Œê±° í† ê¸€ ì˜¤ë¥˜:', error);
      showErrorMessage('ìŒì„± ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  async function enableAudio() {
    try {
      console.log('ğŸ”Š ì˜¤ë””ì˜¤ í™œì„±í™” ì‹œì‘');

      // iOS Safariì—ì„œ ì•ˆì •ì ì¸ ì˜¤ë””ì˜¤ í™œì„±í™”
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      if (isIOS && isSafari) {
        console.log('ğŸ iOS Safari ì˜¤ë””ì˜¤ í™œì„±í™”');

        // iOS Safariì—ì„œëŠ” ì‚¬ìš©ì ì œìŠ¤ì²˜ ì‹œì ì— unmute í•´ì•¼ í•¨
        mainVideo.muted = false;

        // ë³¼ë¥¨ì„ ë‚®ê²Œ ì„¤ì •í•œ í›„ ì¬ìƒ
        mainVideo.volume = 0.1;

        // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ì˜ìƒì˜ ì¬ìƒ ìƒíƒœ í™•ì¸
        const wasPlaying = !mainVideo.paused;
        const currentTime = mainVideo.currentTime;

        console.log('ğŸ“ í˜„ì¬ ì¬ìƒ ìƒíƒœ:', { wasPlaying, currentTime });

        if (wasPlaying) {
          // ì¬ìƒ ì¤‘ì´ë©´ ì¼ì‹œì •ì§€ í›„ ë‹¤ì‹œ ì¬ìƒ
          try {
            await mainVideo.play();
            console.log('ğŸ”Š iOS ì˜¤ë””ì˜¤ ì¬ìƒ ì„±ê³µ');
          } catch (playError) {
            console.warn('âš ï¸ iOS ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', playError);
          }
        } else {
          // ì •ì§€ ìƒíƒœë©´ ì§§ê²Œ ì¬ìƒ í›„ ì¼ì‹œì •ì§€
          try {
            await mainVideo.play();
            setTimeout(() => {
              mainVideo.pause();
              mainVideo.currentTime = currentTime;
            }, 100);
            console.log('ğŸ”Š iOS ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸ ì¬ìƒ ì„±ê³µ');
          } catch (playError) {
            console.warn('âš ï¸ iOS ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸ ì¬ìƒ ì‹¤íŒ¨:', playError);
          }
        }

        // ë³¼ë¥¨ ì •ìƒ ì„¤ì •
        mainVideo.volume = 0.8;

      } else {
        console.log('ğŸ¤– ì¼ë°˜ ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ í™œì„±í™”');

        // ì¼ë°˜ ë¸Œë¼ìš°ì € ì²˜ë¦¬
        mainVideo.muted = false;
        mainVideo.volume = 0.01;
        await mainVideo.play();
        mainVideo.volume = 0.8;
      }

      isAudioEnabled = true;
      muteIcon.textContent = 'ğŸ”Š';
      muteBtn.classList.add('active');
      muteBtn.classList.remove('pulse');

      hideAudioGuide();
      showSuccessMessage('ìŒì„±ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
      console.log('âœ… ì˜¤ë””ì˜¤ í™œì„±í™” ì™„ë£Œ');

    } catch (error) {
      console.error('ì˜¤ë””ì˜¤ í™œì„±í™” ì‹¤íŒ¨:', error);
      showErrorMessage('ìŒì„± í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function disableAudio() {
    isAudioEnabled = false;
    mainVideo.muted = true;
    muteIcon.textContent = 'ğŸ”‡';
    muteBtn.classList.remove('active');
    console.log('ğŸ”‡ ì˜¤ë””ì˜¤ ë¹„í™œì„±í™” ì™„ë£Œ');
  }

  // ========== ì•ˆë‚´ ë©”ì‹œì§€ ==========

  function showAudioGuide() {
    if (!isAudioEnabled) {
      audioGuide.classList.add('show');
      muteBtn.classList.add('pulse');

      guideTimeout = setTimeout(() => {
        hideAudioGuide();
      }, 5000);
    }
  }

  function hideAudioGuide() {
    audioGuide.classList.remove('show');
    muteBtn.classList.remove('pulse');

    if (guideTimeout) {
      clearTimeout(guideTimeout);
      guideTimeout = null;
    }
  }

  function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.textContent = message;
    successDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(39, 174, 96, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1500;
            animation: fadeInOut 2s ease-in-out;
        `;

    document.body.appendChild(successDiv);
    setTimeout(() => successDiv.remove(), 2000);
  }

  function showErrorMessage(message) {
    const errorDiv = document.createElement('div');
    errorDiv.textContent = message;
    errorDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1500;
            animation: fadeInOut 2s ease-in-out;
        `;

    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 2000);
  }

  function showInfoMessage(message) {
    const infoDiv = document.createElement('div');
    infoDiv.textContent = message;
    infoDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1500;
            text-align: center;
            line-height: 1.4;
            animation: fadeInOut 3s ease-in-out;
        `;

    document.body.appendChild(infoDiv);
    setTimeout(() => infoDiv.remove(), 3000);
  }

  // ========== ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë° ì˜¤ë¥˜ ì²˜ë¦¬ ==========

  function setupVideoEventListeners() {
    mainVideo.addEventListener('error', (e) => {
      console.error('ëŒ€ê¸° ì˜ìƒ ì˜¤ë¥˜:', e);
      if (currentVideoState === 'WAITING') {
        showStaticBackground();
      }
    });

    mainVideo.addEventListener('stalled', () => {
      console.warn('ëŒ€ê¸° ì˜ìƒ ë¡œë”© ì§€ì—°');
    });

    mainVideo.addEventListener('waiting', () => {
      console.log('ëŒ€ê¸° ì˜ìƒ ë²„í¼ë§ ì¤‘...');
    });

    mainVideo.addEventListener('canplay', () => {
      console.log('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
    });
  }

  function showStaticBackground() {
    console.log('ğŸ“º ëŒ€ì²´ ë°°ê²½ í‘œì‹œ');
    mainVideo.style.display = 'none';
    const container = document.querySelector('.main-video-container');

    container.style.background = 'linear-gradient(135deg, #2c3e50, #34495e)';

    const fallback = document.createElement('div');
    fallback.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 18px;
        `;
    fallback.innerHTML = `
            <div style="font-size: 64px; margin-bottom: 20px; animation: float 3s ease-in-out infinite;">ğŸ“¹</div>
            <div style="font-weight: 600;">ì—°ê²°ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        `;

    container.appendChild(fallback);
  }

  function handleInitializationError(error) {
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    showStaticBackground();
    updateStatusSmoothly('ì—°ê²° ì¬ì‹œë„ ì¤‘...');

    setTimeout(() => {
      window.location.reload();
    }, 5000);
  }

  async function handleResponseVideoError(error) {
    console.error('ì‘ë‹µ ì˜ìƒ ì˜¤ë¥˜:', error);

    if (error.name === 'NotAllowedError') {
      console.log('ğŸ”Š ìë™ì¬ìƒ ì°¨ë‹¨ - ìŒì„± ì•ˆë‚´ í‘œì‹œ');
      showAudioGuide();
    }

    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€
    try {
      console.log('ğŸ”„ ì˜¤ë¥˜ ë³µêµ¬: ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = true;
      mainVideo.currentTime = 0;

      await mainVideo.play();

      currentVideoState = 'WAITING';
      mainVideo.style.opacity = '1';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

      console.log('âœ… ì˜¤ë¥˜ ë³µêµ¬ ì™„ë£Œ');

    } catch (recoveryError) {
      console.error('âŒ ì˜¤ë¥˜ ë³µêµ¬ ì‹¤íŒ¨:', recoveryError);
      currentVideoState = 'WAITING';
      mainVideo.style.opacity = '1';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
      showStaticBackground();
    }
  }

  // ========== í†µí™” ì¢…ë£Œ ==========

  function endCall() {
    if (confirm('ì˜ìƒí†µí™”ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      enhancedCleanup();

      if (isRecording && mediaRecorder) {
        try {
          mediaRecorder.stop();
          isRecording = false;
        } catch (error) {
          console.error('ë…¹í™” ì¤‘ì§€ ì˜¤ë¥˜:', error);
        }
      }

      sessionKey = null;
      const hasOnboarding = hasCompletedOnboarding();
      const redirectPath = hasOnboarding ? '/mobile/home' : '/mobile/onboarding';

      console.log('ğŸ”„ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸:', {
        hasCompletedOnboarding: hasOnboarding,
        redirectPath: redirectPath
      });

      window.location.href = redirectPath;
    }
  }

  // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==========

  function updateStatusSmoothly(newStatus) {
    statusText.style.transition = 'opacity 0.3s ease';
    statusText.style.opacity = '0';

    setTimeout(() => {
      statusText.textContent = newStatus;
      statusText.style.opacity = '1';
    }, 150);
  }

  function getCurrentContactName() {
    const urlParams = new URLSearchParams(window.location.search);
    const contactName = urlParams.get('contact') ||
            localStorage.getItem('selectedContact') ||
            'ê¹€ê·¼íƒœ';
    return contactName;
  }

  function showPermissionModal() {
    permissionModal.classList.add('show');
    updateStatusSmoothly('ê¶Œí•œ ìš”ì²­ ì¤‘...');
  }

  function hidePermissionModal() {
    permissionModal.classList.remove('show');
  }

  function hasCompletedOnboarding() {
    try {
      const onboardingData = localStorage.getItem('onboarding_completed');
      if (!onboardingData) return false;

      const data = JSON.parse(onboardingData);
      return data.completed === true;
    } catch (error) {
      console.error('ì˜¨ë³´ë”© ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
      return false;
    }
  }

  function enhancedCleanup() {
    console.log('ğŸ§¹ ê°•í™”ëœ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹œì‘');

    // í•˜íŠ¸ë¹„íŠ¸ ì •ë¦¬
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
      heartbeatInterval = null;
    }

    // SSE ì—°ê²° ì •ë¦¬
    if (sseEventSource) {
      sseEventSource.close();
      sseEventSource = null;
    }

    // SessionStorage ì •ë¦¬
    sessionStorage.removeItem(SESSION_STORAGE_KEY);
    console.log('ğŸ—‘ï¸ SessionStorage ì •ë¦¬ ì™„ë£Œ');

    sessionKey = null;
    sseReconnectAttempts = 0;

    if (guideTimeout) {
      clearTimeout(guideTimeout);
      guideTimeout = null;
    }

    if (userMediaStream) {
      userMediaStream.getTracks().forEach(track => {
        track.stop();
        console.log('ë¯¸ë””ì–´ íŠ¸ë™ ì •ë¦¬:', track.kind);
      });
      userMediaStream = null;
    }

    recordedChunks = [];
    console.log('âœ… ê°•í™”ëœ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ');
  }

  // ========== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ìƒëª…ì£¼ê¸° ê´€ë¦¬ ==========

  // ì£¼ê¸°ì ìœ¼ë¡œ ì„¸ì…˜ í™œë™ ì—…ë°ì´íŠ¸
  setInterval(() => {
    updateSessionActivity();
  }, 60000);

  // í˜ì´ì§€ visibility ë³€ê²½ ê°ì§€
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      console.log('í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§');
    } else {
      console.log('í˜ì´ì§€ê°€ í‘œì‹œë¨');
      updateSessionActivity();

      if (sessionKey && (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN)) {
        setTimeout(() => {
          console.log('ì•± ë³µê·€ í›„ SSE ì¬ì—°ê²°');
          connectSSE();
        }, 500);
      }
    }
  });

  // í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™” (iOS Safari)
  if ('ontouchstart' in window) {
    document.addEventListener('touchstart', function () {
    }, {passive: true});

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  }

  // í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸
  window.addEventListener('load', function () {
    console.log('ğŸŒ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    setTimeout(() => {
      if (!cameraPermissionGranted && !microphonePermissionGranted) {
        console.log('ğŸ”„ ë°±ì—… ì´ˆê¸°í™” ì‹¤í–‰');
        showPermissionModal();
      }
    }, 500);
  });

  // í˜ì´ì§€ ì–¸ë¡œë“œ ì´ë²¤íŠ¸
  window.addEventListener('beforeunload', () => {
    enhancedCleanup();

    if (sessionKey) {
      navigator.sendBeacon(`/api/video/session/${sessionKey}/cleanup`);
    }
  });

  // í˜ì´ì§€ ë³µì› ì´ë²¤íŠ¸
  window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
      console.log('ğŸ”„ í˜ì´ì§€ ìºì‹œì—ì„œ ë³µì›ë¨ - ì „ì²´ ìƒˆë¡œê³ ì¹¨ í•„ìš”');
      window.location.reload();
    }
  });

  // ========== ìë™ ì‹¤í–‰ ì½”ë“œ ==========

  document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');

    // í˜ì´ì§€ ì§„ì… ì‹œ ì¦‰ì‹œ ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ
    setTimeout(() => {
      showPermissionModal();
    }, 500);
  });

  console.log('ğŸ¬ ê¶Œí•œ ìš”ì²­ ê¸°ëŠ¥ì´ í¬í•¨ëœ ì˜ìƒí†µí™” ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
</script>
</body>
</html>