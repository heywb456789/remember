<!-- fragments/token-sync.html - ëª¨ë“  ëª¨ë°”ì¼ ë·° í˜ì´ì§€ì— í¬í•¨í•  í† í° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->

<div th:fragment="tokenSync">
    <!-- í† í° ê°±ì‹  ì •ë³´ ë©”íƒ€ íƒœê·¸ (ì„œë²„ì—ì„œ ì„¤ì •) -->
    <meta th:if="${newAccessToken}" name="new-access-token" th:content="${newAccessToken}" />
    <meta th:if="${newRefreshToken}" name="new-refresh-token" th:content="${newRefreshToken}" />

    <!-- í† í° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        (function() {
            'use strict';

            /**
             * í† í° ë™ê¸°í™” ì²˜ë¦¬ (ìƒˆë¡œìš´ JWT ì¿ í‚¤ ì¸ì¦ ì‹œìŠ¤í…œìš©)
             */
            function syncTokens() {
                try {
                    // ë©”íƒ€ íƒœê·¸ì—ì„œ ìƒˆ í† í° ì •ë³´ í™•ì¸
                    const newAccessTokenMeta = document.querySelector('meta[name="new-access-token"]');
                    const newRefreshTokenMeta = document.querySelector('meta[name="new-refresh-token"]');

                    if (newAccessTokenMeta && newRefreshTokenMeta) {
                        const newAccessToken = newAccessTokenMeta.content;
                        const newRefreshToken = newRefreshTokenMeta.content;

                        if (newAccessToken && newRefreshToken) {
                            // localStorage ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í† í°ê³¼ ë™ê¸°í™”)
                            localStorage.setItem('accessToken', newAccessToken);
                            localStorage.setItem('refreshToken', newRefreshToken);

                            console.log('JWT ì¿ í‚¤ â†’ localStorage í† í° ë™ê¸°í™” ì™„ë£Œ');
                            console.log('Access Token:', newAccessToken.substring(0, 20) + '...');

                            // ë³´ì•ˆì„ ìœ„í•´ ë©”íƒ€ íƒœê·¸ ì œê±°
                            newAccessTokenMeta.remove();
                            newRefreshTokenMeta.remove();

                            // í† í° ë™ê¸°í™” ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ê°ì§€ ê°€ëŠ¥)
                            window.dispatchEvent(new CustomEvent('tokenSynced', {
                                detail: {
                                    accessToken: newAccessToken,
                                    refreshToken: newRefreshToken,
                                    syncedAt: new Date().toISOString()
                                }
                            }));
                        }
                    }
                } catch (error) {
                    console.error('í† í° ë™ê¸°í™” ì˜¤ë¥˜:', error);
                }
            }

            /**
             * í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ í† í° ë™ê¸°í™” ì‹¤í–‰
             */
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', syncTokens);
            } else {
                syncTokens();
            }

            /**
             * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (JWT í† í° ê¸°ë°˜)
             */
            window.checkLoginStatus = function() {
                const accessToken = localStorage.getItem('accessToken');
                const refreshToken = localStorage.getItem('refreshToken');

                if (!accessToken || !refreshToken) {
                    console.warn('JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return false;
                }

                // í† í° ë§Œë£Œ ì‹œê°„ ì²´í¬ (JWT payload ë””ì½”ë”©)
                try {
                    const payload = JSON.parse(atob(accessToken.split('.')[1]));
                    const now = Math.floor(Date.now() / 1000);

                    if (payload.exp && payload.exp < now) {
                        console.warn('Access Tokenì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì„œë²„ì—ì„œ ìë™ ê°±ì‹ ë¨)');
                        return false;
                    }

                    console.log('JWT í† í° ìœ íš¨:', {
                        memberId: payload.sub,
                        role: payload.role,
                        expiresAt: new Date(payload.exp * 1000)
                    });

                    return true;
                } catch (error) {
                    console.error('JWT í† í° ê²€ì¦ ì˜¤ë¥˜:', error);
                    return false;
                }
            };

            /**
             * ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (JWT ì¿ í‚¤ ë° localStorage ì •ë¦¬)
             */
            window.forceLogout = function(message = 'ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.') {
                // localStorage ì •ë¦¬
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');

                // ì¿ í‚¤ ì •ë¦¬ (ì„œë²„ì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œë„ ì‹œë„)
                document.cookie = 'MEMBER_ACCESS_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; Secure; HttpOnly; SameSite=Strict';
                document.cookie = 'MEMBER_REFRESH_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; Secure; HttpOnly; SameSite=Strict';

                alert(message);
                window.location.href = '../../static/login';
            };

            /**
             * JWT í† í° ì •ë³´ ë””ë²„ê¹… (ê°œë°œìš©)
             */
            window.debugTokens = function() {
                const accessToken = localStorage.getItem('accessToken');
                const refreshToken = localStorage.getItem('refreshToken');

                console.group('JWT í† í° ì •ë³´ (ìƒˆë¡œìš´ ì¿ í‚¤ ì¸ì¦ ì‹œìŠ¤í…œ)');
                console.log('Access Token:', accessToken ? accessToken.substring(0, 50) + '...' : 'None');
                console.log('Refresh Token:', refreshToken ? refreshToken.substring(0, 50) + '...' : 'None');

                if (accessToken) {
                    try {
                        const payload = JSON.parse(atob(accessToken.split('.')[1]));
                        console.log('í† í° Payload:', payload);
                        console.log('íšŒì› ID:', payload.sub);
                        console.log('ì—­í• :', payload.role);
                        console.log('í† í° íƒ€ì…:', payload.type);
                        console.log('ë°œê¸‰ ì‹œê°„:', new Date(payload.iat * 1000));
                        console.log('ë§Œë£Œ ì‹œê°„:', new Date(payload.exp * 1000));
                        console.log('ë‚¨ì€ ì‹œê°„:', Math.floor((payload.exp * 1000 - Date.now()) / 1000) + 'ì´ˆ');
                    } catch (error) {
                        console.error('JWT í† í° íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }

                // ì¿ í‚¤ ì •ë³´ë„ í™•ì¸ (ê°œë°œì ë„êµ¬ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥)
                console.log('ì¿ í‚¤:', document.cookie);
                console.groupEnd();
            };

            /**
             * í† í° ê°±ì‹  ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ê°œë°œìš©)
             */
            window.addEventListener('tokenSynced', function(event) {
                if (window.location.search.includes('debug=token')) {
                    console.log('ğŸ”„ í† í° ê°±ì‹  ì´ë²¤íŠ¸ ê°ì§€:', event.detail);
                }
            });

        })();
    </script>

    <!-- í˜ì´ì§€ë³„ ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸ (ë””ë²„ê·¸ ëª¨ë“œ) -->
    <script th:if="${param.debug == 'token'}">
        // ë””ë²„ê·¸ ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
        console.log('ğŸ”§ JWT í† í° ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”');

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ í† í° ì •ë³´ ì¶œë ¥
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                window.debugTokens();
            }, 1000);
        });

        // í† í° ë™ê¸°í™” ì´ë²¤íŠ¸ ìƒì„¸ ë¡œê¹…
        window.addEventListener('tokenSynced', function(event) {
            console.log('ğŸ“¡ í† í° ë™ê¸°í™” ìƒì„¸ ì •ë³´:', {
                event: event.detail,
                localStorage: {
                    accessToken: localStorage.getItem('accessToken')?.substring(0, 30) + '...',
                    refreshToken: localStorage.getItem('refreshToken')?.substring(0, 30) + '...'
                },
                cookies: document.cookie
            });
        });
    </script>
</div>

<!--
ì‚¬ìš©ë²•:
1. ëª¨ë“  ëª¨ë°”ì¼ ë·° í˜ì´ì§€ì—ì„œ ì´ fragmentë¥¼ include
2. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ í† í° ê°±ì‹  ì‹œ modelì— newAccessToken, newRefreshToken ì¶”ê°€
3. ìë™ìœ¼ë¡œ ì¿ í‚¤ì™€ localStorageê°€ ë™ê¸°í™”ë¨
4. ë””ë²„ê·¸ ëª¨ë“œ: URLì— ?debug=token ì¶”ê°€

ì˜ˆì‹œ:
<div th:replace="~{fragments/token-sync :: tokenSync}"></div>

ìƒˆë¡œìš´ ì¸ì¦ ì‹œìŠ¤í…œ íŠ¹ì§•:
- JWT í† í°ì€ ì¿ í‚¤ì— ì €ì¥ (HttpOnly, Secure)
- localStorageì™€ ìë™ ë™ê¸°í™”ë¡œ JavaScriptì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥
- MobileJwtFilterì—ì„œ ìë™ í† í° ê°±ì‹  ì²˜ë¦¬
- API í˜¸ì¶œ ì‹œ Bearer í† í° ë˜ëŠ” ì¿ í‚¤ ì¸ì¦ ëª¨ë‘ ì§€ì›
-->