<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TomatoRemember MVP (ê¶Œí•œ ìµœì í™”)</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    html, body {
      width: 100%; height: 100%;
      background: #222;
      font-family: sans-serif;
      color: #fff;
    }
    #app {
      width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      position: relative;
    }
    video {
      display: block;
      width: 100%; height: 100%;
      object-fit: cover;
      background: black;
    }
    .controls {
      position: absolute;
      display: flex; gap: 8px;
      left: 50%; transform: translateX(-50%);
    }
    .controls input {
      padding: 6px 8px;
      border-radius: 4px; border: none;
      font-size: 14px;
      flex: 1;
    }
    .controls button {
      padding: 6px 12px;
      border: none; border-radius: 4px;
      background: #4CAF50; color: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    /* í†µí™” ì‹œì‘ ëª¨ë‹¬ */
    .start-modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: #333;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      max-width: 90vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .modal-content h2 {
      margin-bottom: 15px;
      color: #fff;
      font-size: 24px;
    }
    .modal-content p {
      margin-bottom: 25px;
      color: #ccc;
      font-size: 16px;
      line-height: 1.4;
    }
    .start-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .start-button:hover {
      background: #45a049;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 1500;
    }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 4px solid #333;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ëª¨ë°”ì¼ í° í”„ë ˆì„ */
    .phone-frame {
      position: relative;
      width: 360px; height: 640px;
      background: #111;
      border: 12px solid #333;
      border-radius: 36px;
      box-shadow: inset 0 0 0 1px #000, 0 4px 20px rgba(0,0,0,0.5);
      overflow: hidden;
      max-width: 90vw;
      max-height: 95vh;
      transform: scale(0.95);
      margin: auto;
    }
    .phone-frame .header {
      position: absolute; top: 8px; width: 100%; text-align: center;
      font-size: 14px; pointer-events: none;
    }
    .phone-frame .screen {
      position: absolute; top: 56px; left: 16px;
      width: calc(100% - 32px); height: calc(100% - 120px);
      background: #000;
    }
    .phone-frame .controls {
      bottom: 12px;
      width: calc(100% - 40px);
    }

    /* ë°˜ì‘í˜• */
    @media (min-width: 768px) {
      #full-video {
        position: relative;
        width: 100vw; height: 100vh;
        overflow: hidden;
      }
      #full-video video {
        object-fit: contain;
        background: black;
      }
      #full-video .controls {
        bottom: 24px;
        padding: 0 16px;
      }
      .phone-frame { display: none; }
      #full-video { display: block; }
    }

    @media (max-width: 767px) {
      #full-video { display: none; }
      .phone-frame { display: block; }
    }

    .video-hidden {
      display: none;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p style="margin-top: 20px;">ê¶Œí•œ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
  </div>

  <!-- í†µí™” ì‹œì‘ ëª¨ë‹¬ (ì¡°ê±´ë¶€ í‘œì‹œ) -->
  <div id="start-modal" class="start-modal" style="display: none;">
    <div class="modal-content">
      <h2>ğŸ… TomatoRemember</h2>
      <p id="modal-message">í†µí™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ì‹œì‘í•´ì£¼ì„¸ìš”.</p>
      <button id="start-button" class="start-button">í†µí™” ì‹œì‘</button>
    </div>
  </div>

  <!-- PC/íƒœë¸”ë¦¿: ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ + ì»¨íŠ¸ë¡¤ -->
  <div id="full-video" class="video-hidden">
    <video id="videoPlayerDesktop" loop autoplay muted playsinline>
      <source src="http://110.93.190.10:6060/static/waiting_3_slow.mp4" type="video/mp4">
      ë™ì˜ìƒ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
    </video>
    <div class="controls">
      <input id="textInputDesktop" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button id="sendBtnDesktop">ì „ì†¡</button>
    </div>
  </div>

  <!-- ëª¨ë°”ì¼: í° í”„ë ˆì„ ë‚´ë¶€ ë¹„ë””ì˜¤ + ì»¨íŠ¸ë¡¤ -->
  <div class="phone-frame video-hidden">
    <div class="header">
      TOMATOREMEMBER
    </div>
    <div class="screen">
      <video id="videoPlayerMobile" loop autoplay muted playsinline>
        <source src="http://110.93.190.10:6060/static/waiting_3_slow.mp4" type="video/mp4">
        ë™ì˜ìƒ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.
      </video>
    </div>
    <div class="controls">
      <input id="textInputMobile" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button id="sendBtnMobile">ì „ì†¡</button>
    </div>
  </div>
</div>

<script>
  let callStarted = false;
  let sseConnection = null;
  const WAITING_VIDEO_URL = 'http://110.93.190.10:6060/static/waiting_3_slow.mp4';

  // ğŸ”§ ê¶Œí•œ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
  async function initializeApp() {
    try {
      console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘');

      // ê¸°ë³¸ ë¯¸ë””ì–´ ê¶Œí•œ í™•ì¸
      const permissions = await checkMediaPermissions();
      console.log('ğŸ“‹ ê¶Œí•œ ìƒíƒœ:', permissions);

      // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
      document.getElementById('loading-overlay').style.display = 'none';

      if (permissions.hasAllPermissions) {
        // âœ… ëª¨ë“  ê¶Œí•œì´ ìŠ¹ì¸ëœ ê²½ìš° - ë°”ë¡œ í†µí™” ì‹œì‘
        console.log('âœ… ëª¨ë“  ê¶Œí•œ ìŠ¹ì¸ë¨ - ë°”ë¡œ í†µí™” ì‹œì‘');
        await startCall();
      } else {
        // âŒ ê¶Œí•œì´ í•„ìš”í•œ ê²½ìš° - ëª¨ë‹¬ í‘œì‹œ
        console.log('âŒ ê¶Œí•œ í•„ìš” - ëª¨ë‹¬ í‘œì‹œ');
        showPermissionModal(permissions);
      }

    } catch (error) {
      console.error('âŒ ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);

      // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
      document.getElementById('loading-overlay').style.display = 'none';

      // ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨ ì‹œì—ë„ ëª¨ë‹¬ í‘œì‹œ
      showPermissionModal({
        hasAllPermissions: false,
        camera: 'unknown',
        microphone: 'unknown',
        autoplay: 'unknown'
      });
    }
  }

  // ğŸ” ë¯¸ë””ì–´ ê¶Œí•œ ìƒíƒœ í™•ì¸
  async function checkMediaPermissions() {
    const result = {
      hasAllPermissions: false,
      camera: 'unknown',
      microphone: 'unknown',
      autoplay: 'unknown'
    };

    try {
      // Navigator.permissions API ì‚¬ìš© (ì§€ì›ë˜ëŠ” ê²½ìš°)
      if (navigator.permissions) {
        try {
          const cameraPermission = await navigator.permissions.query({name: 'camera'});
          const microphonePermission = await navigator.permissions.query({name: 'microphone'});

          result.camera = cameraPermission.state;
          result.microphone = microphonePermission.state;

          console.log('ğŸ¥ ì¹´ë©”ë¼ ê¶Œí•œ:', cameraPermission.state);
          console.log('ğŸ¤ ë§ˆì´í¬ ê¶Œí•œ:', microphonePermission.state);
        } catch (e) {
          console.log('ğŸ“‹ Permissions API ë¶€ë¶„ ì§€ì›:', e.message);
        }
      }

      // getUserMediaë¡œ ì‹¤ì œ ê¶Œí•œ í…ŒìŠ¤íŠ¸ (ë” ì •í™•í•¨)
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });

        // ê¶Œí•œì´ ìŠ¹ì¸ëœ ê²½ìš°
        result.camera = 'granted';
        result.microphone = 'granted';

        // ìŠ¤íŠ¸ë¦¼ ì¦‰ì‹œ ì •ë¦¬
        stream.getTracks().forEach(track => track.stop());

        console.log('âœ… getUserMedia í…ŒìŠ¤íŠ¸ ì„±ê³µ - ê¶Œí•œ ìŠ¹ì¸ë¨');
      } catch (error) {
        console.log('âŒ getUserMedia í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error.name);

        if (error.name === 'NotAllowedError') {
          result.camera = 'denied';
          result.microphone = 'denied';
        } else if (error.name === 'NotFoundError') {
          console.log('ğŸ“· ë¯¸ë””ì–´ ë””ë°”ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
      }

      // autoplay ì •ì±… í™•ì¸ (ê°„ì ‘ì )
      try {
        const video = document.createElement('video');
        video.muted = true;
        video.autoplay = true;
        video.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAAwAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAQAAAAAALgAAAC4AAAAAAAccGlkAAAAYXN0c2QAAAAAAAAAAQAAAFFhdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALgAuABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhmdHlwAAAAGGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAADhtZGF0AAAA';
        result.autoplay = 'granted';
      } catch (e) {
        result.autoplay = 'unknown';
      }

      // ëª¨ë“  ê¶Œí•œ ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸
      result.hasAllPermissions = (
              result.camera === 'granted' &&
              result.microphone === 'granted'
      );

    } catch (error) {
      console.error('ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
    }

    return result;
  }

  // ğŸ“± ê¶Œí•œ ëª¨ë‹¬ í‘œì‹œ
  function showPermissionModal(permissions) {
    const modal = document.getElementById('start-modal');
    const message = document.getElementById('modal-message');

    if (permissions.camera === 'denied' || permissions.microphone === 'denied') {
      message.innerHTML = `
          <strong>âš ï¸ ë¯¸ë””ì–´ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤</strong><br><br>
          ì˜ìƒí†µí™”ë¥¼ ìœ„í•´ ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
          ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
        `;
    } else {
      message.innerHTML = `
          í†µí™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
          ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.
        `;
    }

    modal.style.display = 'flex';
  }

  // ğŸ“ í†µí™” ì‹œì‘
  async function startCall() {
    if (callStarted) return;

    try {
      callStarted = true;
      console.log('ğŸ“ í†µí™” ì‹œì‘!');

      // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      document.getElementById('start-modal').style.display = 'none';

      // ë¹„ë””ì˜¤ ì˜ì—­ ë³´ì´ê¸°
      document.getElementById('full-video').classList.remove('video-hidden');
      document.querySelector('.phone-frame').classList.remove('video-hidden');

      // ëª¨ë“  ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ (ì†Œë¦¬ í¬í•¨)
      const videos = document.querySelectorAll('video');
      for (const video of videos) {
        try {
          video.muted = false; // ì†Œë¦¬ í™œì„±í™”
          await video.play();
          console.log('ğŸ¥ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ (ì†Œë¦¬ í¬í•¨)');
        } catch (err) {
          console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', err);
        }
      }

      // SSE ì—°ê²° ì‹œì‘
      initializeSSE();

    } catch (error) {
      console.error('í†µí™” ì‹œì‘ ì‹¤íŒ¨:', error);
      callStarted = false;

      // ì˜¤ë¥˜ ì‹œ ëª¨ë‹¬ ë‹¤ì‹œ í‘œì‹œ
      showPermissionModal({
        hasAllPermissions: false,
        camera: 'error',
        microphone: 'error'
      });
    }
  }

  // í†µí™” ì‹œì‘ ë²„íŠ¼ í´ë¦­
  document.getElementById('start-button').addEventListener('click', async () => {
    console.log('ğŸ”˜ í†µí™” ì‹œì‘ ë²„íŠ¼ í´ë¦­');
    await startCall();
  });

  // SSE ì—°ê²° ì´ˆê¸°í™”
  function initializeSSE() {
    if (sseConnection) return;

    console.log('ğŸ”Œ SSE ì—°ê²° ì‹œì‘');
    sseConnection = new EventSource('/api/stream');

    sseConnection.addEventListener('videoUpdate', handleVideoUpdate);
    sseConnection.onerror = (err) => {
      console.error('SSE ì—°ê²° ì˜¤ë¥˜:', err);
    };
  }

  // ë¹„ë””ì˜¤ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
  function handleVideoUpdate(event) {
    const newVideoUrl = event.data;
    console.log('ğŸ¬ ìƒˆ ë¹„ë””ì˜¤ URL ë°›ìŒ:', newVideoUrl);

    const activeVideo = window.innerWidth >= 768
            ? document.getElementById('videoPlayerDesktop')
            : document.getElementById('videoPlayerMobile');

    playResultVideo(activeVideo, newVideoUrl);
  }

  // ê²°ê³¼ ë¹„ë””ì˜¤ ì¬ìƒ
  async function playResultVideo(videoElement, resultUrl) {
    try {
      console.log('â–¶ï¸ ê²°ê³¼ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘:', resultUrl);

      videoElement.src = resultUrl;
      videoElement.loop = false;
      videoElement.muted = false;

      await new Promise((resolve, reject) => {
        videoElement.onloadedmetadata = resolve;
        videoElement.onerror = reject;
        videoElement.load();
      });

      await videoElement.play();
      console.log('ğŸ¥ ê²°ê³¼ ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘');

      videoElement.onended = () => {
        console.log('âœ… ê²°ê³¼ ë¹„ë””ì˜¤ ì¬ìƒ ì™„ë£Œ, ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
        returnToWaitingVideo(videoElement);
      };

    } catch (err) {
      console.error('ê²°ê³¼ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', err);
      returnToWaitingVideo(videoElement);
    }
  }

  // ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€
  async function returnToWaitingVideo(videoElement) {
    try {
      console.log('ğŸ”„ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');

      videoElement.src = WAITING_VIDEO_URL;
      videoElement.loop = true;
      videoElement.muted = false;

      await new Promise((resolve, reject) => {
        videoElement.onloadedmetadata = resolve;
        videoElement.onerror = reject;
        videoElement.load();
      });

      await videoElement.play();
      console.log('ğŸ” ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹œì‘');

    } catch (err) {
      console.error('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', err);
    }
  }

  // ë©”ì‹œì§€ ì „ì†¡
  async function sendMessage(text) {
    console.log('ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡:', text);

    try {
      fetch('/api/request', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text: text })
      }).then(response => {
        if (response.ok) {
          console.log('âœ… ì „ì†¡ ì„±ê³µ');
        } else {
          console.error('âŒ ì „ì†¡ ì‹¤íŒ¨:', response.status);
        }
      }).catch(err => {
        console.error('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', err);
      });
    } catch (err) {
      console.error('ğŸ“¤ ì „ì†¡ ì˜¤ë¥˜:', err);
    }
  }

  // ì»¨íŠ¸ë¡¤ ì„¤ì •
  function setupControls(inputEl, btnEl) {
    function handleSend() {
      const text = inputEl.value.trim();
      if (!text) return;

      sendMessage(text);
      inputEl.value = '';
    }

    btnEl.addEventListener('click', handleSend);
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleSend();
      }
    });
  }

  // ì»¨íŠ¸ë¡¤ ì„¤ì •
  setupControls(
          document.getElementById('textInputDesktop'),
          document.getElementById('sendBtnDesktop')
  );
  setupControls(
          document.getElementById('textInputMobile'),
          document.getElementById('sendBtnMobile')
  );

  // ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ ì•± ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>