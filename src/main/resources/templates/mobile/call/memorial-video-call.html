<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† ë§ˆí† ë¦¬ë©¤ë²„ - Memorial Video Call</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) */
    .main-video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .main-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      transition: opacity 0.5s ease;
    }

    /* ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) */
    .my-camera-container {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 160px;
      background: #2c3e50;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }

    .my-camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3498db, #2980b9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
    .control-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 30px 20px 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 1000;
      min-height: 120px;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 30px;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
    }

    .record-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .record-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .record-btn.recording {
      background: #e74c3c;
      animation: recordingPulse 1.5s ease-in-out infinite;
    }

    .mute-btn {
      background: #95a5a6;
      box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
    }

    .mute-btn:hover {
      background: #7f8c8d;
      transform: scale(1.1);
    }

    .mute-btn.active {
      background: #27ae60;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
    }

    .end-call-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .end-call-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    /* ìƒíƒœ í‘œì‹œ */
    .status-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      font-size: 14px;
      backdrop-filter: blur(10px);
      z-index: 100;
      transition: opacity 0.3s ease;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #27ae60;
      border-radius: 50%;
      margin-right: 8px;
      animation: statusBlink 2s ease-in-out infinite;
    }

    .status-dot.connecting {
      background: #f39c12;
    }

    .status-dot.error {
      background: #e74c3c;
    }

    /* WebSocket ì—°ê²° ìƒíƒœ */
    .connection-indicator {
      position: absolute;
      top: 70px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 6px 12px;
      border-radius: 15px;
      color: white;
      font-size: 12px;
      backdrop-filter: blur(10px);
      z-index: 100;
      opacity: 0.8;
    }

    .connection-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .connection-dot.connected {
      background: #27ae60;
      animation: connectedBlink 2s ease-in-out infinite;
    }

    .connection-dot.connecting {
      background: #f39c12;
      animation: connectingPulse 1s ease-in-out infinite;
    }

    .connection-dot.disconnected {
      background: #e74c3c;
    }

    /* ì„¸ì…˜ ì •ë³´ í‘œì‹œ */
    .session-info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 6px 12px;
      border-radius: 15px;
      color: white;
      font-size: 12px;
      backdrop-filter: blur(10px);
      z-index: 100;
      opacity: 0.7;
      display: none;
    }

    /* ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ */
    .permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .permission-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .permission-dialog {
      background: #2c3e50;
      border-radius: 16px;
      padding: 32px;
      max-width: 360px;
      width: 90%;
      text-align: center;
      color: white;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }

    .permission-modal.show .permission-dialog {
      transform: scale(1);
    }

    .permission-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .permission-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .permission-btn.deny {
      background: #7f8c8d;
      color: white;
    }

    .permission-btn.allow {
      background: #3498db;
      color: white;
    }

    /* ë””ë²„ê·¸ ì •ë³´ */
    .debug-info {
      position: absolute;
      top: 120px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 8px;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.3;
      z-index: 100;
      max-width: 300px;
      display: none;
    }

    .debug-info.show {
      display: block;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes recordingPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes statusBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes connectedBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes connectingPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* ë°˜ì‘í˜• */
    @media (min-width: 768px) {
      .my-camera-container {
        width: 180px;
        height: 240px;
        top: 30px;
        right: 30px;
      }

      .control-bar {
        padding: 40px 30px 50px;
        gap: 30px;
      }

      .control-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }
    }

    @media (max-width: 480px) {
      .my-camera-container {
        width: 100px;
        height: 133px;
        top: 15px;
        right: 15px;
      }

      .control-bar {
        padding: 20px 15px 30px;
        gap: 15px;
        min-height: 100px;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
<!-- ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ -->
<div id="permissionModal" class="permission-modal">
  <div class="permission-dialog">
    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ¥</div>
    <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">ë¯¸ë””ì–´ ê¶Œí•œ í•„ìš”</div>
    <div style="font-size: 14px; line-height: 1.6; margin-bottom: 24px; color: #bdc3c7;">
      Memorial Video Callì„ ìœ„í•´ ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
      WebSocket ê¸°ë°˜ìœ¼ë¡œ ì•ˆì •ì ì¸ ì—°ê²°ì„ ì œê³µí•©ë‹ˆë‹¤.
    </div>
    <div class="permission-buttons">
      <button class="permission-btn deny" onclick="denyPermission()">ë‚˜ì¤‘ì—</button>
      <button class="permission-btn allow" onclick="requestPermissions()">í—ˆìš©</button>
    </div>
  </div>
</div>

<!-- ìƒíƒœ í‘œì‹œ -->
<div class="status-indicator">
  <span id="statusDot" class="status-dot"></span>
  <span id="statusText">ì´ˆê¸°í™” ì¤‘...</span>
</div>

<!-- WebSocket ì—°ê²° ìƒíƒœ -->
<div class="connection-indicator">
  <span id="connectionDot" class="connection-dot disconnected"></span>
  <span id="connectionText">WebSocket ì—°ê²° ì¤‘...</span>
</div>

<!-- ì„¸ì…˜ ì •ë³´ í‘œì‹œ -->
<div id="sessionInfo" class="session-info">
  <span id="sessionDisplay">ì„¸ì…˜: ë¡œë”©ì¤‘...</span>
</div>

<!-- ë””ë²„ê·¸ ì •ë³´ -->
<div id="debugInfo" class="debug-info">
  <div>WebSocket Status: <span id="debugWsStatus">-</span></div>
  <div>Session Key: <span id="debugSessionKey">-</span></div>
  <div>Session Age: <span id="debugSessionAge">-</span></div>
  <div>TTL Remaining: <span id="debugTtlRemaining">-</span></div>
  <div>Reconnect Count: <span id="debugReconnectCount">-</span></div>
  <div>Last Heartbeat: <span id="debugLastHeartbeat">-</span></div>
  <div>Message Count: <span id="debugMessageCount">0</span></div>
</div>

<!-- ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) -->
<div class="main-video-container">
  <video id="mainVideo" class="main-video" autoplay loop muted playsinline style="display: none;">
    <source src="https://aicut.newstomato.com/remember/static/waiting_kt.mp4" type="video/mp4">
    ëŒ€ê¸° ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  </video>
</div>

<!-- ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) -->
<div class="my-camera-container">
  <video id="myCamera" class="my-camera" autoplay muted playsinline style="display: none;"></video>
  <div id="cameraPlaceholder" class="camera-placeholder">ğŸ“¹</div>
</div>

<!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
<div class="control-bar">
  <button id="recordBtn" class="control-btn record-btn" onclick="toggleRecording()">
    <span id="recordIcon">âº</span>
  </button>

  <button id="muteBtn" class="control-btn mute-btn" onclick="toggleMute()">
    <span id="muteIcon">ğŸ”‡</span>
  </button>

  <button class="control-btn end-call-btn" onclick="endCall()">
    ğŸ“
  </button>
</div>

<script>
  // ========== ì „ì—­ ë³€ìˆ˜ ==========

  // í˜ì´ì§€ íŒŒë¼ë¯¸í„° (Thymeleafì—ì„œ ì£¼ì…)
  const PAGE_PARAMS = {
    contactName: '[[${contactName}]]' || 'ê¹€ê·¼íƒœ',
    memorialId: '[[${memorialId}]]' || null,
    callerId: '[[${callerId}]]' || null,
    existingSessionKey: '[[${existingSessionKey}]]' || null,
    debugMode: '[[${debugMode}]]' === 'true'
  };

  // WebSocket ê´€ë ¨
  let webSocket = null;
  let sessionKey = null;
  let reconnectAttempts = 0;
  let maxReconnectAttempts = 10;
  let reconnectDelay = 1000;
  let connectionState = 'DISCONNECTED'; // DISCONNECTED, CONNECTING, CONNECTED
  let lastHeartbeatTime = 0;
  let messageCount = 0;

  // ì„¸ì…˜ ê´€ë ¨
  let sessionData = null;
  let sessionAge = 0;
  let ttlRemaining = 0;
  let reconnectCount = 0;

  // ë¯¸ë””ì–´ ê´€ë ¨
  let userMediaStream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let isRecording = false;
  let isAudioEnabled = false;
  let cameraPermissionGranted = false;
  let microphonePermissionGranted = false;

  // ì˜ìƒ ê´€ë ¨
  let currentVideoState = 'WAITING';
  let videoTransitionInProgress = false;

  // DOM ìš”ì†Œë“¤
  const permissionModal = document.getElementById('permissionModal');
  const mainVideo = document.getElementById('mainVideo');
  const myCamera = document.getElementById('myCamera');
  const cameraPlaceholder = document.getElementById('cameraPlaceholder');
  const recordBtn = document.getElementById('recordBtn');
  const recordIcon = document.getElementById('recordIcon');
  const muteBtn = document.getElementById('muteBtn');
  const muteIcon = document.getElementById('muteIcon');
  const statusText = document.getElementById('statusText');
  const statusDot = document.getElementById('statusDot');
  const connectionText = document.getElementById('connectionText');
  const connectionDot = document.getElementById('connectionDot');
  const sessionInfo = document.getElementById('sessionInfo');
  const sessionDisplay = document.getElementById('sessionDisplay');
  const debugInfo = document.getElementById('debugInfo');

  // ========== WebSocket í´ë˜ìŠ¤ ==========

  class MemorialVideoWebSocket {
    constructor() {
      this.ws = null;
      this.heartbeatInterval = null;
      this.reconnectTimeout = null;
    }

    connect(sessionKey) {
      this.disconnect(); // ê¸°ì¡´ ì—°ê²° ì •ë¦¬

      const wsUrl = this.getWebSocketUrl(sessionKey);
      console.log('ğŸ”— WebSocket ì—°ê²° ì‹œë„:', wsUrl);

      try {
        this.ws = new WebSocket(wsUrl);
        this.setupEventHandlers();
        this.updateConnectionState('CONNECTING');
      } catch (error) {
        console.error('âŒ WebSocket ìƒì„± ì‹¤íŒ¨:', error);
        this.handleConnectionError(error);
      }
    }

    getWebSocketUrl(sessionKey) {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = location.host;
      return `${protocol}//${host}/ws/memorial-video/${sessionKey}`;
    }

    setupEventHandlers() {
      this.ws.onopen = (event) => {
        console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
        this.updateConnectionState('CONNECTED');
        reconnectAttempts = 0;
        reconnectDelay = 1000;

        // ì—°ê²° ë©”ì‹œì§€ ì „ì†¡
        this.sendConnectMessage();
      };

      this.ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          this.handleMessage(message);
          messageCount++;
          this.updateDebugInfo();
        } catch (error) {
          console.error('âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error, event.data);
        }
      };

      this.ws.onclose = (event) => {
        console.log('ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ:', event.code, event.reason);
        this.updateConnectionState('DISCONNECTED');
        this.stopHeartbeat();

        // ì •ìƒ ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš° ì¬ì—°ê²° ì‹œë„
        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
          this.scheduleReconnect();
        }
      };

      this.ws.onerror = (error) => {
        console.error('ğŸ”¥ WebSocket ì˜¤ë¥˜:', error);
        this.handleConnectionError(error);
      };
    }

    sendConnectMessage() {
      const isReconnect = sessionData !== null;

      const connectMessage = {
        type: 'CONNECT',
        sessionKey: sessionKey,
        contactName: PAGE_PARAMS.contactName,
        memorialId: PAGE_PARAMS.memorialId,
        callerId: PAGE_PARAMS.callerId,
        reconnect: isReconnect
      };

      this.sendMessage(connectMessage);
      console.log('ğŸ“¡ CONNECT ë©”ì‹œì§€ ì „ì†¡:', connectMessage);
    }

    handleMessage(message) {
      console.log('ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :', message.type, message);

      switch (message.type) {
        case 'CONNECTED':
          this.handleConnected(message);
          break;

        case 'HEARTBEAT':
          this.handleHeartbeat(message);
          break;

        case 'RESPONSE_VIDEO':
          this.handleResponseVideo(message);
          break;

        case 'VIDEO_UPLOADED':
          this.handleVideoUploaded(message);
          break;

        case 'ERROR':
          this.handleError(message);
          break;

        case 'FORCE_DISCONNECT':
          this.handleForceDisconnect(message);
          break;

        default:
          console.warn('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', message.type);
      }
    }

    handleConnected(message) {
      sessionData = {
        sessionKey: message.sessionKey,
        contactName: message.contactName,
        reconnected: message.reconnected,
        sessionAge: message.sessionAge,
        ttlRemaining: message.ttlRemaining,
        reconnectCount: message.reconnectCount || 0
      };

      reconnectCount = sessionData.reconnectCount;

      if (message.reconnected) {
        updateStatusSmoothly(`${message.contactName}ì™€ ì¬ì—°ê²°ë¨`);
        console.log('ğŸ”„ ì„¸ì…˜ ë³µêµ¬ ì„±ê³µ (ì¬ì—°ê²° íšŸìˆ˜: ' + reconnectCount + ')');
      } else {
        updateStatusSmoothly(`${message.contactName}ì™€ ì—°ê²°ë¨`);
        console.log('âœ… ìƒˆ ì„¸ì…˜ ìƒì„± ì„±ê³µ');
      }

      this.updateSessionDisplay();
      this.startHeartbeat();
      this.updateDebugInfo();
    }

    handleHeartbeat(message) {
      lastHeartbeatTime = Date.now();
      sessionAge = message.sessionAge || 0;
      ttlRemaining = message.ttlRemaining || 0;

      console.log('ğŸ’“ í•˜íŠ¸ë¹„íŠ¸:', sessionAge, 'ë¶„, TTL:', ttlRemaining, 'ì´ˆ');

      // í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ
      this.sendMessage({
        type: 'HEARTBEAT_RESPONSE',
        sessionKey: sessionKey,
        timestamp: Date.now()
      });

      this.updateSessionDisplay();
      this.updateDebugInfo();
    }

    handleResponseVideo(message) {
      console.log('ğŸ¬ ì‘ë‹µ ì˜ìƒ ìˆ˜ì‹ :', message.videoUrl);
      updateStatusSmoothly('ì‘ë‹µ ì˜ìƒ ì¬ìƒ');
      playResponseVideo(message.videoUrl);
    }

    handleVideoUploaded(message) {
      console.log('ğŸ“¹ ì˜ìƒ ì—…ë¡œë“œ ì™„ë£Œ ì•Œë¦¼:', message.filePath);
      updateStatusSmoothly('AI ì²˜ë¦¬ ì¤‘...');
    }

    handleError(message) {
      console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', message);
      updateStatusSmoothly('ì˜¤ë¥˜: ' + message.message);

      if (message.code === 'SESSION_EXPIRED') {
        sessionData = null;
        sessionKey = null;
        showErrorMessage('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
        setTimeout(() => window.location.reload(), 2000);
      }
    }

    handleForceDisconnect(message) {
      console.warn('ğŸšª ê°•ì œ ì—°ê²° í•´ì œ:', message.reason);
      showErrorMessage('ê´€ë¦¬ìì— ì˜í•´ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤: ' + message.reason);
      this.disconnect();
    }

    sendMessage(message) {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify(message));
      } else {
        console.warn('âš ï¸ WebSocket ì—°ê²°ë˜ì§€ ì•ŠìŒ - ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
      }
    }

    startHeartbeat() {
      this.stopHeartbeat();

      // 35ì´ˆë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸ (ì„œë²„ í•˜íŠ¸ë¹„íŠ¸ 30ì´ˆë³´ë‹¤ ê¸¸ê²Œ)
      this.heartbeatInterval = setInterval(() => {
        const timeSinceLastHeartbeat = Date.now() - lastHeartbeatTime;

        if (timeSinceLastHeartbeat > 65000) { // 65ì´ˆ ì´ìƒ í•˜íŠ¸ë¹„íŠ¸ ì—†ìœ¼ë©´
          console.warn('ğŸ’” í•˜íŠ¸ë¹„íŠ¸ íƒ€ì„ì•„ì›ƒ - ì¬ì—°ê²° í•„ìš”');
          this.scheduleReconnect();
        }
      }, 35000);
    }

    stopHeartbeat() {
      if (this.heartbeatInterval) {
        clearInterval(this.heartbeatInterval);
        this.heartbeatInterval = null;
      }
    }

    scheduleReconnect() {
      if (this.reconnectTimeout) {
        clearTimeout(this.reconnectTimeout);
      }

      reconnectAttempts++;

      if (reconnectAttempts > maxReconnectAttempts) {
        console.error('ğŸš¨ ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
        updateStatusSmoothly('ì—°ê²° ì‹¤íŒ¨');
        this.updateConnectionState('DISCONNECTED');
        showErrorMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }

      console.log(`ğŸ”„ ${reconnectDelay/1000}ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„ (${reconnectAttempts}/${maxReconnectAttempts})`);
      updateStatusSmoothly(`${Math.round(reconnectDelay/1000)}ì´ˆ í›„ ì¬ì—°ê²°...`);

      this.reconnectTimeout = setTimeout(() => {
        if (sessionKey) {
          this.connect(sessionKey);
        }
      }, reconnectDelay);

      // ì§€ìˆ˜ ë°±ì˜¤í”„ (ìµœëŒ€ 30ì´ˆ)
      reconnectDelay = Math.min(reconnectDelay * 2, 30000);
    }

    updateConnectionState(state) {
      connectionState = state;

      const dot = connectionDot;
      const text = connectionText;

      dot.className = 'connection-dot';

      switch (state) {
        case 'CONNECTED':
          dot.classList.add('connected');
          text.textContent = 'WebSocket ì—°ê²°ë¨';
          break;
        case 'CONNECTING':
          dot.classList.add('connecting');
          text.textContent = 'WebSocket ì—°ê²° ì¤‘...';
          break;
        case 'DISCONNECTED':
          dot.classList.add('disconnected');
          text.textContent = 'WebSocket ì—°ê²° ëŠê¹€';
          break;
      }

      this.updateDebugInfo();
    }

    updateSessionDisplay() {
      if (sessionData) {
        const shortKey = sessionData.sessionKey.substring(sessionData.sessionKey.length - 8);
        const age = Math.round((Date.now() - Date.now()) / 1000 / 60) + sessionAge;
        sessionDisplay.textContent = `ì„¸ì…˜: ${shortKey} (${age}ë¶„, TTL: ${Math.round(ttlRemaining/60)}ë¶„)`;
        sessionInfo.style.display = 'block';
      } else {
        sessionInfo.style.display = 'none';
      }
    }

    updateDebugInfo() {
      if (!PAGE_PARAMS.debugMode) return;

      document.getElementById('debugWsStatus').textContent = connectionState;
      document.getElementById('debugSessionKey').textContent = sessionKey || '-';
      document.getElementById('debugSessionAge').textContent = sessionAge + 'ë¶„';
      document.getElementById('debugTtlRemaining').textContent = ttlRemaining + 'ì´ˆ';
      document.getElementById('debugReconnectCount').textContent = reconnectCount;
      document.getElementById('debugLastHeartbeat').textContent =
              lastHeartbeatTime ? new Date(lastHeartbeatTime).toLocaleTimeString() : '-';
      document.getElementById('debugMessageCount').textContent = messageCount;
    }

    handleConnectionError(error) {
      console.error('WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
      this.updateConnectionState('DISCONNECTED');

      if (reconnectAttempts === 0) {
        updateStatusSmoothly('ì—°ê²° ì˜¤ë¥˜');
      }
    }

    disconnect() {
      this.stopHeartbeat();

      if (this.reconnectTimeout) {
        clearTimeout(this.reconnectTimeout);
        this.reconnectTimeout = null;
      }

      if (this.ws) {
        this.ws.close(1000);
        this.ws = null;
      }

      this.updateConnectionState('DISCONNECTED');
    }

    sendVideoUploadComplete(filePath) {
      this.sendMessage({
        type: 'VIDEO_UPLOAD_COMPLETE',
        sessionKey: sessionKey,
        filePath: filePath
      });
    }

    sendDisconnect(reason = 'USER_ACTION') {
      this.sendMessage({
        type: 'DISCONNECT',
        sessionKey: sessionKey,
        reason: reason
      });
    }
  }

  // ========== WebSocket ì¸ìŠ¤í„´ìŠ¤ ==========
  const memorialVideoWS = new MemorialVideoWebSocket();

  // ========== ê¶Œí•œ ê´€ë¦¬ ==========

  async function checkExistingPermissions() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 320, height: 240 },
        audio: true
      });

      stream.getTracks().forEach(track => track.stop());
      cameraPermissionGranted = true;
      microphonePermissionGranted = true;
      return true;
    } catch (error) {
      cameraPermissionGranted = false;
      microphonePermissionGranted = false;
      return false;
    }
  }

  async function requestPermissions() {
    hidePermissionModal();
    updateStatusSmoothly('ê¶Œí•œ ìš”ì²­ ì¤‘...');

    try {
      userMediaStream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: { echoCancellation: true, noiseSuppression: true }
      });

      cameraPermissionGranted = true;
      microphonePermissionGranted = true;

      setupCamera();
      await initializeAfterPermission();

      updateStatusSmoothly('ê¶Œí•œ ì„¤ì • ì™„ë£Œ');

    } catch (error) {
      console.error('âŒ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', error);
      handlePermissionError(error);
    }
  }

  function denyPermission() {
    hidePermissionModal();
    updateStatusSmoothly('ê¶Œí•œ ì—†ì´ ì²´í—˜');
    initializeWithoutPermission();
  }

  function setupCamera() {
    if (userMediaStream) {
      myCamera.srcObject = userMediaStream;
      myCamera.style.display = 'block';
      cameraPlaceholder.style.display = 'none';
      console.log('ğŸ“· ì¹´ë©”ë¼ ì„¤ì • ì™„ë£Œ');
    }
  }

  function handlePermissionError(error) {
    if (error.name === 'NotAllowedError') {
      updateStatusSmoothly('ê¶Œí•œì´ ê±°ë¶€ë¨');
      showErrorMessage('ì¹´ë©”ë¼ ë° ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
    } else {
      updateStatusSmoothly('ê¶Œí•œ ì˜¤ë¥˜');
      showErrorMessage('ë¯¸ë””ì–´ ê¶Œí•œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ========== ì´ˆê¸°í™” ==========

  async function initializeAfterPermission() {
    try {
      console.log('ğŸš€ ê¶Œí•œ í›„ ì´ˆê¸°í™” ì‹œì‘');

      // 1. ëŒ€ê¸° ì˜ìƒ ì‹œì‘
      await startWaitingVideo();

      // 2. ì„¸ì…˜ ìƒì„± ë˜ëŠ” ë³µêµ¬
      if (PAGE_PARAMS.existingSessionKey) {
        console.log('ğŸ“± ê¸°ì¡´ ì„¸ì…˜ í‚¤ë¡œ ë³µêµ¬ ì‹œë„:', PAGE_PARAMS.existingSessionKey);
        sessionKey = PAGE_PARAMS.existingSessionKey;
      } else {
        await createNewSession();
      }

      // 3. WebSocket ì—°ê²°
      if (sessionKey) {
        memorialVideoWS.connect(sessionKey);
      }

      console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');

    } catch (error) {
      console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      handleInitializationError(error);
    }
  }

  async function initializeWithoutPermission() {
    try {
      console.log('ğŸ¬ ê¶Œí•œ ì—†ì´ ì²´í—˜ ëª¨ë“œ ì´ˆê¸°í™”');
      await startWaitingVideo();
      updateStatusSmoothly('ì²´í—˜ ëª¨ë“œ');

      setTimeout(() => {
        showInfoMessage('ì²´í—˜ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\në…¹í™” ê¸°ëŠ¥ì€ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }, 2000);

    } catch (error) {
      console.error('ì²´í—˜ ëª¨ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  async function createNewSession() {
    try {
      updateStatusSmoothly('ì„¸ì…˜ ìƒì„± ì¤‘...');

      const response = await fetch('/api/memorial-video/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contactName: PAGE_PARAMS.contactName,
          memorialId: PAGE_PARAMS.memorialId,
          callerId: PAGE_PARAMS.callerId
        })
      });

      const data = await response.json();

      if (data.status.code === 'OK_0000') {
        sessionKey = data.response.sessionKey;
        console.log('âœ… ìƒˆ ì„¸ì…˜ ìƒì„±:', sessionKey);
      } else {
        throw new Error(data.status.message);
      }

    } catch (error) {
      console.error('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
      updateStatusSmoothly('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨');
      throw error;
    }
  }

  // ========== ì˜ìƒ ê´€ë¦¬ ==========

  async function startWaitingVideo() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = !isAudioEnabled;
      mainVideo.style.display = 'block';

      await mainVideo.play();
      currentVideoState = 'WAITING';

      console.log('ğŸ¬ ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹œì‘');

    } catch (error) {
      console.error('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:', error);
      if (error.name === 'NotAllowedError') {
        showTouchToPlayGuide();
      } else {
        showStaticBackground();
      }
    }
  }

  async function playResponseVideo(videoUrl) {
    if (videoTransitionInProgress) return;

    try {
      videoTransitionInProgress = true;
      console.log('ğŸ¬ ì‘ë‹µ ì˜ìƒ ì¬ìƒ:', videoUrl);

      mainVideo.src = videoUrl;
      mainVideo.loop = false;
      mainVideo.muted = !isAudioEnabled;

      await mainVideo.play();
      currentVideoState = 'RESPONSE';

      // ì˜ìƒ ì¢…ë£Œ ì‹œ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€
      mainVideo.onended = async () => {
        console.log('ğŸ”„ ì‘ë‹µ ì˜ìƒ ì¢…ë£Œ, ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
        await returnToWaitingVideo();
      };

      if (!isAudioEnabled) {
        showAudioGuide();
      }

    } catch (error) {
      console.error('ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜:', error);
      await returnToWaitingVideo();
    } finally {
      videoTransitionInProgress = false;
    }
  }

  async function returnToWaitingVideo() {
    try {
      const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

      mainVideo.src = waitingVideoUrl;
      mainVideo.loop = true;
      mainVideo.muted = !isAudioEnabled;

      await mainVideo.play();
      currentVideoState = 'WAITING';
      updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

    } catch (error) {
      console.error('ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì‹¤íŒ¨:', error);
      showStaticBackground();
    }
  }

  // ========== ë…¹í™” ê¸°ëŠ¥ ==========

  async function toggleRecording() {
    if (!cameraPermissionGranted || !userMediaStream) {
      showInfoMessage('ë…¹í™” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    if (!isRecording) {
      await startRecording();
    } else {
      await stopRecording();
    }
  }

  async function startRecording() {
    try {
      recordedChunks = [];

      const options = {
        mimeType: 'video/webm;codecs=vp9,opus',
        videoBitsPerSecond: 5000000,
        audioBitsPerSecond: 128000
      };

      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options.mimeType = 'video/webm;codecs=vp8,opus';
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = 'video/webm';
        }
      }

      mediaRecorder = new MediaRecorder(userMediaStream, options);

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = () => {
        processRecordedVideo();
      };

      mediaRecorder.start();
      isRecording = true;

      recordBtn.classList.add('recording');
      recordIcon.textContent = 'â¹';
      updateStatusSmoothly('ë…¹í™” ì¤‘');

      console.log('ğŸ“¹ ë…¹í™” ì‹œì‘');

    } catch (error) {
      console.error('ë…¹í™” ì‹œì‘ ì˜¤ë¥˜:', error);
      showErrorMessage('ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  }

  async function stopRecording() {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      isRecording = false;

      recordBtn.classList.remove('recording');
      recordIcon.textContent = 'âº';
      updateStatusSmoothly('ì²˜ë¦¬ ì¤‘');

      console.log('â¹ ë…¹í™” ì¤‘ì§€');
    }
  }

  async function processRecordedVideo() {
    if (!sessionKey) {
      showErrorMessage('ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      updateStatusSmoothly('ì „ì†¡ ì¤‘...');

      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const formData = new FormData();
      formData.append('video', blob, `recorded_video_${sessionKey}_${Date.now()}.webm`);

      console.log('ğŸ“¤ ì„œë²„ë¡œ ì˜ìƒ ì „ì†¡:', blob.size, 'bytes');

      const response = await fetch(`/api/memorial-video/process/${sessionKey}`, {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        console.log('âœ… ì˜ìƒ ì—…ë¡œë“œ ì„±ê³µ:', result);
        updateStatusSmoothly('AI ì²˜ë¦¬ ì¤‘...');

        // WebSocketìœ¼ë¡œ ì—…ë¡œë“œ ì™„ë£Œ ì•Œë¦¼
        memorialVideoWS.sendVideoUploadComplete(result.response.filePath);
      } else {
        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
      }

    } catch (error) {
      console.error('ì˜ìƒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      updateStatusSmoothly('ì „ì†¡ ì‹¤íŒ¨');
      showErrorMessage('ì˜ìƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ========== ìŒì†Œê±° ê¸°ëŠ¥ ==========

  async function toggleMute() {
    try {
      if (!isAudioEnabled) {
        await enableAudio();
      } else {
        disableAudio();
      }
    } catch (error) {
      console.error('ìŒì†Œê±° í† ê¸€ ì˜¤ë¥˜:', error);
      showErrorMessage('ìŒì„± ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  async function enableAudio() {
    try {
      mainVideo.muted = false;
      mainVideo.volume = 0.8;

      if (!mainVideo.paused) {
        await mainVideo.play();
      }

      isAudioEnabled = true;
      muteIcon.textContent = 'ğŸ”Š';
      muteBtn.classList.add('active');

      showSuccessMessage('ìŒì„±ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
      console.log('ğŸ”Š ì˜¤ë””ì˜¤ í™œì„±í™” ì™„ë£Œ');

    } catch (error) {
      console.error('ì˜¤ë””ì˜¤ í™œì„±í™” ì‹¤íŒ¨:', error);
      showErrorMessage('ìŒì„± í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function disableAudio() {
    isAudioEnabled = false;
    mainVideo.muted = true;
    muteIcon.textContent = 'ğŸ”‡';
    muteBtn.classList.remove('active');
    console.log('ğŸ”‡ ì˜¤ë””ì˜¤ ë¹„í™œì„±í™” ì™„ë£Œ');
  }

  // ========== í†µí™” ì¢…ë£Œ ==========

  function endCall() {
    if (confirm('Memorial Video Callì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      cleanup();

      if (isRecording && mediaRecorder) {
        try {
          mediaRecorder.stop();
          isRecording = false;
        } catch (error) {
          console.error('ë…¹í™” ì¤‘ì§€ ì˜¤ë¥˜:', error);
        }
      }

      // WebSocketìœ¼ë¡œ ì¢…ë£Œ ì•Œë¦¼
      if (sessionKey) {
        memorialVideoWS.sendDisconnect('USER_ACTION');
      }

      // í˜ì´ì§€ ì´ë™
      const hasOnboarding = hasCompletedOnboarding();
      const redirectPath = hasOnboarding ? '/mobile/home' : '/mobile/onboarding';
      console.log('ğŸ”„ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸:', redirectPath);
      window.location.href = redirectPath;
    }
  }

  // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==========

  function updateStatusSmoothly(newStatus) {
    statusText.style.transition = 'opacity 0.3s ease';
    statusText.style.opacity = '0';

    setTimeout(() => {
      statusText.textContent = newStatus;
      statusText.style.opacity = '1';
    }, 150);
  }

  function showPermissionModal() {
    permissionModal.classList.add('show');
  }

  function hidePermissionModal() {
    permissionModal.classList.remove('show');
  }

  function showSuccessMessage(message) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(39, 174, 96, 0.9); color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 14px; z-index: 1500;
                animation: fadeInOut 2s ease-in-out;
            `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2000);
  }

  function showErrorMessage(message) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(231, 76, 60, 0.9); color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 14px; z-index: 1500;
                animation: fadeInOut 3s ease-in-out;
            `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  function showInfoMessage(message) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(52, 152, 219, 0.9); color: white; padding: 16px 24px;
                border-radius: 8px; font-size: 14px; z-index: 1500; text-align: center;
                line-height: 1.4; animation: fadeInOut 3s ease-in-out;
            `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  function showAudioGuide() {
    if (!isAudioEnabled) {
      showInfoMessage('ğŸ”Š ìŒì„±ì„ ë“¤ìœ¼ë ¤ë©´ ğŸ”‡ ë²„íŠ¼ì„ í„°ì¹˜í•˜ì„¸ìš”');
    }
  }

  function showTouchToPlayGuide() {
    const guide = document.createElement('div');
    guide.style.cssText = `
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.85); color: white; padding: 24px;
                border-radius: 16px; text-align: center; z-index: 200;
                cursor: pointer; backdrop-filter: blur(10px);
            `;
    guide.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¬</div>
                <div style="font-weight: 600; margin-bottom: 8px;">í™”ë©´ì„ í„°ì¹˜í•´ì£¼ì„¸ìš”</div>
                <div style="font-size: 14px; opacity: 0.8;">ì˜ìƒì„ ì‹œì‘í•˜ë ¤ë©´ í„°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤</div>
            `;

    guide.onclick = async () => {
      try {
        await mainVideo.play();
        guide.remove();
        console.log('âœ… ì‚¬ìš©ì í„°ì¹˜ë¡œ ì¬ìƒ ì‹œì‘');
        updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');
      } catch (e) {
        console.error('ìˆ˜ë™ ì¬ìƒ ì‹¤íŒ¨:', e);
        guide.remove();
        showStaticBackground();
      }
    };

    document.querySelector('.main-video-container').appendChild(guide);
  }

  function showStaticBackground() {
    mainVideo.style.display = 'none';
    const container = document.querySelector('.main-video-container');
    container.style.background = 'linear-gradient(135deg, #2c3e50, #34495e)';

    const fallback = document.createElement('div');
    fallback.style.cssText = `
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                text-align: center; color: white; font-size: 18px;
            `;
    fallback.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“¹</div>
                <div style="font-weight: 600;">Memorial Video Call</div>
                <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">ì—°ê²°ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
            `;

    container.appendChild(fallback);
  }

  function handleInitializationError(error) {
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    showStaticBackground();
    updateStatusSmoothly('ì—°ê²° ì¬ì‹œë„ ì¤‘...');

    setTimeout(() => {
      window.location.reload();
    }, 5000);
  }

  function hasCompletedOnboarding() {
    try {
      const data = localStorage.getItem('onboarding_completed');
      if (!data) return false;
      return JSON.parse(data).completed === true;
    } catch (error) {
      return false;
    }
  }

  function cleanup() {
    console.log('ğŸ§¹ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹œì‘');

    // WebSocket ì •ë¦¬
    memorialVideoWS.disconnect();

    // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
    if (userMediaStream) {
      userMediaStream.getTracks().forEach(track => {
        track.stop();
        console.log('ë¯¸ë””ì–´ íŠ¸ë™ ì •ë¦¬:', track.kind);
      });
      userMediaStream = null;
    }

    // ë³€ìˆ˜ ì´ˆê¸°í™”
    sessionKey = null;
    sessionData = null;
    recordedChunks = [];
    isRecording = false;

    console.log('âœ… ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ');
  }

  // ========== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ìƒëª…ì£¼ê¸° ê´€ë¦¬ ==========

  // DOM ë¡œë“œ ì™„ë£Œ ì‹œ
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸ“„ Memorial Video Call DOM ë¡œë“œ ì™„ë£Œ');
    console.log('ğŸ“± í˜ì´ì§€ íŒŒë¼ë¯¸í„°:', PAGE_PARAMS);

    // ë””ë²„ê·¸ ëª¨ë“œ í‘œì‹œ
    if (PAGE_PARAMS.debugMode) {
      debugInfo.classList.add('show');
      console.log('ğŸ› ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”');
    }

    updateStatusSmoothly('ê¶Œí•œ í™•ì¸ ì¤‘...');

    // ê¶Œí•œ í™•ì¸ í›„ ì´ˆê¸°í™”
    const hasPermissions = await checkExistingPermissions();

    if (hasPermissions) {
      console.log('ğŸš€ ê¸°ì¡´ ê¶Œí•œìœ¼ë¡œ ìë™ ì´ˆê¸°í™”');
      await initializeAfterPermission();
    } else {
      console.log('ğŸ” ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ');
      setTimeout(() => {
        showPermissionModal();
      }, 500);
    }
  });

  // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ
  window.addEventListener('beforeunload', () => {
    cleanup();

    if (sessionKey) {
      // ì„¸ì…˜ ì •ë¦¬ API í˜¸ì¶œ (ë¹„ë™ê¸°)
      navigator.sendBeacon(`/api/memorial-video/session/${sessionKey}/cleanup`);
    }
  });

  // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      console.log('ğŸ“± í˜ì´ì§€ ìˆ¨ê¹€');
    } else {
      console.log('ğŸ“± í˜ì´ì§€ í‘œì‹œ');

      // ì•± ë³µê·€ ì‹œ WebSocket ì¬ì—°ê²° í™•ì¸
      if (sessionKey && connectionState !== 'CONNECTED') {
        setTimeout(() => {
          console.log('ğŸ”„ ì•± ë³µê·€ í›„ WebSocket ì¬ì—°ê²°');
          memorialVideoWS.connect(sessionKey);
        }, 500);
      }
    }
  });

  // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ë³€ê²½
  window.addEventListener('online', () => {
    console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
    showSuccessMessage('ë„¤íŠ¸ì›Œí¬ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤');

    if (sessionKey && connectionState !== 'CONNECTED') {
      setTimeout(() => {
        memorialVideoWS.connect(sessionKey);
      }, 1000);
    }
  });

  window.addEventListener('offline', () => {
    console.log('ğŸ“µ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
    showErrorMessage('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
  });

  // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ
  window.addEventListener('load', function() {
    console.log('ğŸŒ Memorial Video Call í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
  });

  console.log('ğŸ¬ Memorial Video Call WebSocket ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
</script>
</body>
</html>