<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† ë§ˆí† ë¦¬ë©¤ë²„ - ì˜ìƒí†µí™”</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) */
    .main-video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .main-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) */
    .my-camera-container {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 160px;
      background: #2c3e50;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }

    .my-camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3498db, #2980b9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
    .control-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 30px 20px 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 100;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 30px;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .record-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .record-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .record-btn.recording {
      background: #e74c3c;
      animation: recordingPulse 1.5s ease-in-out infinite;
    }

    .record-btn.recording::after {
      content: '';
      position: absolute;
      width: 80px;
      height: 80px;
      border: 2px solid rgba(231, 76, 60, 0.6);
      border-radius: 50%;
      animation: recordingRing 1.5s ease-out infinite;
    }

    @keyframes recordingPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes recordingRing {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.3);
        opacity: 0;
      }
    }

    .end-call-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .end-call-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    /* ìƒíƒœ í‘œì‹œ */
    .status-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      font-size: 14px;
      backdrop-filter: blur(10px);
      z-index: 100;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #27ae60;
      border-radius: 50%;
      margin-right: 8px;
      animation: statusBlink 2s ease-in-out infinite;
    }

    @keyframes statusBlink {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 480px) {
      .my-camera-container {
        width: 100px;
        height: 133px;
        top: 15px;
        right: 15px;
      }

      .control-bar {
        padding: 20px 15px 30px;
        gap: 15px;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
    }

    /* ìŒì†Œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .mute-btn {
      background: #95a5a6;
      box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
    }

    .mute-btn:hover {
      background: #7f8c8d;
      transform: scale(1.1);
    }

    .mute-btn.active {
      background: #27ae60;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
    }

    /* ìŒì„± ì•ˆë‚´ ë§í’ì„  */
    .audio-guide {
      position: absolute;
      bottom: 130px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(52, 73, 94, 0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      text-align: center;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      z-index: 150;
      animation: guideBounce 0.5s ease-out;
      display: none;
    }

    .audio-guide.show {
      display: block;
    }

    .guide-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid rgba(52, 73, 94, 0.95);
    }

    .guide-text strong {
      color: #f39c12;
    }

    @keyframes guideBounce {
      0% {
        transform: translateX(-50%) translateY(10px);
        opacity: 0;
      }
      100% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* í„ìŠ¤ íš¨ê³¼ (ë²„íŠ¼ ê°•ì¡°) */
    .mute-btn.pulse {
      animation: mutePulse 1.5s ease-in-out infinite;
    }

    @keyframes mutePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 4px 20px rgba(241, 196, 15, 0.6);
      }
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 480px) {
      .audio-guide {
        bottom: 120px;
        font-size: 13px;
        padding: 10px 14px;
      }
    }
  </style>
</head>
<body>
<!-- ìƒíƒœ í‘œì‹œ -->
<div class="status-indicator">
  <span class="status-dot"></span>
  <span id="statusText">ì—°ê²° ì¤‘...</span>
</div>

<!-- ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) -->
<div class="main-video-container">
  <video id="mainVideo" class="main-video" autoplay loop muted playsinline>
    <source src="http://110.93.190.10:6063/static/waiting_kt.mp4" type="video/mp4">
    ëŒ€ê¸° ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  </video>
</div>

<!-- ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) -->
<div class="my-camera-container">
  <video id="myCamera" class="my-camera" autoplay muted playsinline style="display: none;"></video>
  <div id="cameraPlaceholder" class="camera-placeholder">ğŸ“¹</div>
</div>

<!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
<div class="control-bar">
  <button id="recordBtn" class="control-btn record-btn" onclick="toggleRecording()">
    <span id="recordIcon">âº</span>
  </button>

  <!-- ìŒì†Œê±° ë²„íŠ¼ ì¶”ê°€ -->
  <button id="muteBtn" class="control-btn mute-btn" onclick="toggleMute()">
    <span id="muteIcon">ğŸ”‡</span>
  </button>

  <button class="control-btn end-call-btn" onclick="endCall()">
    ğŸ“
  </button>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p id="loadingText">ì˜ìƒì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
  </div>
</div>

<!-- ìŒì„± ì•ˆë‚´ ë§í’ì„  -->
<div id="audioGuide" class="audio-guide">
  <div class="guide-arrow"></div>
  <div class="guide-text">
    ìŒì„± ì¬ìƒì„ ìœ„í•´<br>
    <strong>ğŸ”‡ ë²„íŠ¼ì„ í„°ì¹˜</strong>í•´ì£¼ì„¸ìš”
  </div>
</div>

<script>
    // ìŒì†Œê±° ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    // ì „ì—­ ë³€ìˆ˜
    let sessionKey = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let userMediaStream = null;
    let sseEventSource = null;

    // ìŒì†Œê±° ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let isAudioEnabled = false;
    let guideTimeout = null;

    // DOM ìš”ì†Œë“¤ ì„ ì–¸
    const mainVideo = document.getElementById('mainVideo');
    const myCamera = document.getElementById('myCamera');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const recordBtn = document.getElementById('recordBtn');
    const recordIcon = document.getElementById('recordIcon');
    const statusText = document.getElementById('statusText');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const muteBtn = document.getElementById('muteBtn');
    const muteIcon = document.getElementById('muteIcon');
    const audioGuide = document.getElementById('audioGuide');

    // 1. ì˜ìƒí†µí™” ì´ˆê¸°í™” ì‹œ ì„¸ì…˜ ìƒì„±
    async function initializeVideoCall() {
        try {
            // í˜„ì¬ ì—°ë½ì²˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const contactName = getCurrentContactName();
            console.log('ì„ íƒëœ ì—°ë½ì²˜:', contactName);

            // ì„¸ì…˜ ìƒì„± API í˜¸ì¶œ
            const sessionResponse = await fetch('/api/video/create-session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({contactName: contactName})
            });

            const sessionData = await sessionResponse.json();

            if (sessionData.status.code === 'OK_0000') {
                sessionKey = sessionData.response.sessionKey;
                console.log('ì„¸ì…˜ ìƒì„± ì™„ë£Œ:', sessionKey);

                // SSE ì—°ê²° ì‹œì‘
                connectSSE();
            } else {
                throw new Error(sessionData.status.message);
            }

            // ì‚¬ìš©ì ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
            userMediaStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: {ideal: 1920, min: 1280},
                    height: {ideal: 1080, min: 720},
                    frameRate: {ideal: 30, min: 24},
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });

            // ë‚´ ì¹´ë©”ë¼ì— ìŠ¤íŠ¸ë¦¼ ì—°ê²°
            myCamera.srcObject = userMediaStream;
            myCamera.style.display = 'block';
            cameraPlaceholder.style.display = 'none';

            // ëŒ€ê¸° ì˜ìƒ ì¬ìƒ
            await playWaitingVideo();

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            statusText.textContent = 'ëŒ€ê¸° ì¤‘';
            console.log('ì˜ìƒí†µí™” ì´ˆê¸°í™” ì™„ë£Œ');

        } catch (error) {
            console.error('ì˜ìƒí†µí™” ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            statusText.textContent = 'ì—°ê²° ì‹¤íŒ¨';
            alert('ì˜ìƒí†µí™” ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // 2. í‚¤ ê¸°ë°˜ SSE ì—°ê²°
    function connectSSE() {
        if (!sessionKey) {
            console.error('ì„¸ì…˜ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        console.log('SSE ì—°ê²° ì‹œì‘:', sessionKey);

        sseEventSource = new EventSource(`/api/video/stream/${sessionKey}`);

        // ì—°ê²° ì™„ë£Œ ì´ë²¤íŠ¸
        sseEventSource.addEventListener('connected', function (event) {
            try {
                const data = JSON.parse(event.data);
                console.log('SSE ì—°ê²° ì™„ë£Œ:', data);
                statusText.textContent = `${data.contactName}ì™€ ì—°ê²°ë¨`;
            } catch (error) {
                console.error('Connected ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error);
                statusText.textContent = 'ì—°ê²°ë¨';
            }
        });

        // ì‘ë‹µ ì˜ìƒ ìˆ˜ì‹  ì´ë²¤íŠ¸
        sseEventSource.addEventListener('response', function (event) {
            try {
                const data = JSON.parse(event.data);
                console.log('ì‘ë‹µ ì˜ìƒ ìˆ˜ì‹ :', data);
                playResponseVideo(data.videoUrl);
            } catch (error) {
                console.error('Response ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error);
            }
        });

        // âœ… ìˆ˜ì •ëœ ì˜¤ë¥˜ ì´ë²¤íŠ¸ (ì•ˆì „í•œ íŒŒì‹±)
        sseEventSource.addEventListener('error', function (event) {
            console.error('SSE ì»¤ìŠ¤í…€ ì˜¤ë¥˜ ì´ë²¤íŠ¸:', event);

            try {
                // event.dataê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ íŒŒì‹± ì‹œë„
                if (event.data) {
                    const data = JSON.parse(event.data);
                    console.error('SSE ì˜¤ë¥˜ ë°ì´í„°:', data);
                    statusText.textContent = 'ì—°ê²° ì˜¤ë¥˜';

                    // ì•Œë¦¼ ëŒ€ì‹  ì¡°ìš©íˆ ì²˜ë¦¬
                    console.warn('ì—°ê²° ì˜¤ë¥˜:', data.error);
                }
            } catch (parseError) {
                console.error('SSE ì˜¤ë¥˜ ì´ë²¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨:', parseError);
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œì—ë„ ì¡°ìš©íˆ ì²˜ë¦¬
            }
        });

        // âœ… ì£¼ìš” ì˜¤ë¥˜ ì²˜ë¦¬ (onerror)
        sseEventSource.onerror = function (event) {
            console.error('SSE ì—°ê²° ì˜¤ë¥˜:', event);

            // ì—°ê²° ìƒíƒœ í™•ì¸
            if (sseEventSource.readyState === EventSource.CLOSED) {
                console.log('SSE ì—°ê²°ì´ ë‹«í˜”ìŠµë‹ˆë‹¤');
                statusText.textContent = 'ì—°ê²° ì¢…ë£Œ';
                return;
            }

            if (sseEventSource.readyState === EventSource.CONNECTING) {
                console.log('SSE ì¬ì—°ê²° ì¤‘...');
                statusText.textContent = 'ì¬ì—°ê²° ì¤‘...';
                return;
            }

            // ì¼ë°˜ì ì¸ ì—°ê²° ì˜¤ë¥˜
            statusText.textContent = 'ì—°ê²° ë¶ˆì•ˆì •';

            // âœ… ì¬ì—°ê²° ì‹œë„ (ë” ê¸´ ê°„ê²©ìœ¼ë¡œ)
            setTimeout(() => {
                if (sessionKey && sseEventSource.readyState !== EventSource.OPEN) {
                    console.log('SSE ì¬ì—°ê²° ì‹œë„');
                    sseEventSource.close(); // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
                    connectSSE(); // ìƒˆë¡œ ì—°ê²°
                }
            }, 5000); // 5ì´ˆ í›„ ì¬ì—°ê²°
        };

        // âœ… ì—°ê²° ì—´ë¦¼ ì´ë²¤íŠ¸ ì¶”ê°€
        sseEventSource.onopen = function (event) {
            console.log('SSE ì—°ê²° ì—´ë¦¼');
            statusText.textContent = 'ì—°ê²° ì¤‘...';
        };
    }

    // 3. ëŒ€ê¸° ì˜ìƒ ì¬ìƒ
    async function playWaitingVideo() {
        try {
            const waitingVideoUrl = 'http://110.93.190.10:6063/static/waiting_kt.mp4';
            mainVideo.src = waitingVideoUrl;
            mainVideo.loop = true;
            mainVideo.muted = true;
            await mainVideo.play();
            console.log('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì‹œì‘');
        } catch (error) {
            console.error('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜:', error);
            // ëŒ€ì²´ ë°°ê²½ í‘œì‹œ
            mainVideo.style.display = 'none';
            document.querySelector('.main-video-container').style.background =
                'linear-gradient(135deg, #2c3e50, #34495e)';
        }
    }

    // 4. ë…¹í™” í† ê¸€
    async function toggleRecording() {
        if (!isRecording) {
            await startRecording();
        } else {
            await stopRecording();
        }
    }

    // 5. ë…¹í™” ì‹œì‘
    async function startRecording() {
        if (!userMediaStream) {
            alert('ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            recordedChunks = [];

            const options = {
                mimeType: 'video/webm;codecs=vp9,opus',
                videoBitsPerSecond: 5000000,
                audioBitsPerSecond: 128000
            };

            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm;codecs=vp8,opus';
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
            }

            mediaRecorder = new MediaRecorder(userMediaStream, options);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                processRecordedVideo();
            };

            mediaRecorder.start();
            isRecording = true;

            // UI ì—…ë°ì´íŠ¸
            recordBtn.classList.add('recording');
            recordIcon.textContent = 'â¹';
            statusText.textContent = 'ë…¹í™” ì¤‘';

            console.log('ë…¹í™” ì‹œì‘');

        } catch (error) {
            console.error('ë…¹í™” ì‹œì‘ ì˜¤ë¥˜:', error);
            alert('ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // 6. ë…¹í™” ì¤‘ì§€
    async function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;

            // UI ì—…ë°ì´íŠ¸
            recordBtn.classList.remove('recording');
            recordIcon.textContent = 'âº';
            statusText.textContent = 'ì²˜ë¦¬ ì¤‘';

            console.log('ë…¹í™” ì¤‘ì§€');
        }
    }

    // 7. í‚¤ ê¸°ë°˜ ì˜ìƒ ì—…ë¡œë“œ
    async function processRecordedVideo() {
        if (!sessionKey) {
            alert('ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            showLoading('ì˜ìƒì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

            const blob = new Blob(recordedChunks, {type: 'video/webm'});
            const formData = new FormData();
            formData.append('video', blob, `recorded_video_${sessionKey}_${Date.now()}.webm`);

            console.log('ì„œë²„ë¡œ ì˜ìƒ ì „ì†¡ ì¤‘...', sessionKey, blob.size, 'bytes');

            const response = await fetch(`/api/video/process/${sessionKey}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                console.log('ì„œë²„ ì‘ë‹µ:', result);

                hideLoading();
                statusText.textContent = 'ì²˜ë¦¬ ì¤‘...';

                console.log('SSE ì‘ë‹µ ëŒ€ê¸° ì¤‘...');
            } else {
                throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
            }

        } catch (error) {
            console.error('ì˜ìƒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            hideLoading();
            statusText.textContent = 'ì²˜ë¦¬ ì‹¤íŒ¨';
            alert('ì˜ìƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // 8. í˜„ì¬ ì—°ë½ì²˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    function getCurrentContactName() {
        const urlParams = new URLSearchParams(window.location.search);
        const contactName = urlParams.get('contact') ||
            localStorage.getItem('selectedContact') ||
            'ê¹€ê·¼íƒœ';
        return contactName;
    }

    // 9. ìŒì„± ì•ˆë‚´ ë§í’ì„  í‘œì‹œ
    function showAudioGuide() {
        if (!isAudioEnabled) {
            audioGuide.classList.add('show');
            muteBtn.classList.add('pulse');

            guideTimeout = setTimeout(() => {
                hideAudioGuide();
            }, 5000);
        }
    }

    // 10. ìŒì„± ì•ˆë‚´ ë§í’ì„  ìˆ¨ê¹€
    function hideAudioGuide() {
        audioGuide.classList.remove('show');
        muteBtn.classList.remove('pulse');

        if (guideTimeout) {
            clearTimeout(guideTimeout);
            guideTimeout = null;
        }
    }

    // 11. ìŒì†Œê±° í† ê¸€ í•¨ìˆ˜
    async function toggleMute() {
        try {
            if (!isAudioEnabled) {
                await enableAudio();
            } else {
                disableAudio();
            }
        } catch (error) {
            console.error('ìŒì†Œê±° í† ê¸€ ì˜¤ë¥˜:', error);
            showErrorMessage('ìŒì„± ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // 12. ì˜¤ë””ì˜¤ í™œì„±í™”
    async function enableAudio() {
        try {
            mainVideo.muted = false;
            mainVideo.volume = 0.01;

            await mainVideo.play();

            isAudioEnabled = true;
            mainVideo.muted = true;
            mainVideo.volume = 0.8;

            muteIcon.textContent = 'ğŸ”Š';
            muteBtn.classList.add('active');

            hideAudioGuide();
            showSuccessMessage('ìŒì„±ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');

            console.log('ì˜¤ë””ì˜¤ í™œì„±í™” ì™„ë£Œ');

        } catch (error) {
            console.error('ì˜¤ë””ì˜¤ í™œì„±í™” ì‹¤íŒ¨:', error);
            showErrorMessage('ìŒì„± í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // 13. ì˜¤ë””ì˜¤ ë¹„í™œì„±í™”
    function disableAudio() {
        isAudioEnabled = false;
        mainVideo.muted = true;

        muteIcon.textContent = 'ğŸ”‡';
        muteBtn.classList.remove('active');

        console.log('ì˜¤ë””ì˜¤ ë¹„í™œì„±í™” ì™„ë£Œ');
    }

    // 14. ê°œì„ ëœ ì‘ë‹µ ì˜ìƒ ì¬ìƒ
    async function playResponseVideo(videoUrl) {
        try {
            console.log('ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì‹œì‘:', videoUrl);
            statusText.textContent = 'ì‘ë‹µ ì¬ìƒ ì¤‘';

            mainVideo.src = videoUrl;
            mainVideo.loop = false;

            if (isAudioEnabled) {
                mainVideo.muted = false;
                mainVideo.volume = 0.8;
            } else {
                mainVideo.muted = true;
                showAudioGuide();
            }

            await mainVideo.play();

            mainVideo.addEventListener('ended', async () => {
                console.log('ì‘ë‹µ ì˜ìƒ ì¢…ë£Œ, ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
                await playWaitingVideo();
                statusText.textContent = 'ëŒ€ê¸° ì¤‘';
            }, {once: true});

        } catch (error) {
            console.error('ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜:', error);

            if (error.name === 'NotAllowedError') {
                console.log('ìŒì†Œê±°ë¡œ ì¬ìƒ ì‹œë„');
                mainVideo.muted = true;
                try {
                    await mainVideo.play();
                    showAudioGuide();
                } catch (mutedError) {
                    console.error('ìŒì†Œê±° ì¬ìƒë„ ì‹¤íŒ¨:', mutedError);
                    await playWaitingVideo();
                    statusText.textContent = 'ì¬ìƒ ì˜¤ë¥˜';
                }
            } else {
                await playWaitingVideo();
                statusText.textContent = 'ì¬ìƒ ì˜¤ë¥˜';
            }
        }
    }

    // 15. í†µí™” ì¢…ë£Œ
    function endCall() {
        if (confirm('ì˜ìƒí†µí™”ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if (sseEventSource) {
                sseEventSource.close();
                sseEventSource = null;
            }

            if (userMediaStream) {
                userMediaStream.getTracks().forEach(track => track.stop());
            }

            if (isRecording) {
                stopRecording();
            }

            sessionKey = null;
            window.location.href = '/mobile/home';
        }
    }

    // 16. ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
    function showLoading(message) {
        loadingText.textContent = message;
        loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }

    // 17. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        successDiv.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(39, 174, 96, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
        animation: fadeInOut 2s ease-in-out;
    `;

        document.body.appendChild(successDiv);

        setTimeout(() => {
            successDiv.remove();
        }, 2000);
    }

    // 18. ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        errorDiv.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(231, 76, 60, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
        animation: fadeInOut 2s ease-in-out;
    `;

        document.body.appendChild(errorDiv);

        setTimeout(() => {
            errorDiv.remove();
        }, 2000);
    }

    // 19. CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
`;
    document.head.appendChild(style);

    // 20. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', () => {
        initializeVideoCall();

        setTimeout(() => {
            showAudioGuide();
        }, 1000);
    });

    // 21. í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        if (sseEventSource) {
            sseEventSource.close();
        }
        if (userMediaStream) {
            userMediaStream.getTracks().forEach(track => track.stop());
        }
    });

    // ========== ì¶”ê°€ ê°œì„ ì‚¬í•­ (í˜„ì¬ script íƒœê·¸ ë§ˆì§€ë§‰ì— ì¶”ê°€) ==========

    // 1. ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
    let isOnline = navigator.onLine;

    window.addEventListener('online', () => {
        console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
        isOnline = true;
        statusText.textContent = 'ì—°ê²° ë³µêµ¬ë¨';

        // ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œ SSE ì¬ì—°ê²° ì‹œë„
        if (sessionKey && (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN)) {
            setTimeout(() => {
                console.log('ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ í›„ SSE ì¬ì—°ê²°');
                connectSSE();
            }, 1000);
        }
    });

    window.addEventListener('offline', () => {
        console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
        isOnline = false;
        statusText.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤í”„ë¼ì¸';
    });

    // 2. ì„¸ì…˜ ìƒíƒœ ì£¼ê¸°ì  í™•ì¸ (ì„ íƒì )
    let sessionCheckInterval = null;

    function startSessionMonitoring() {
        if (sessionCheckInterval) {
            clearInterval(sessionCheckInterval);
        }

        sessionCheckInterval = setInterval(async () => {
            if (sessionKey && isOnline) {
                try {
                    const response = await fetch(`/api/video/session/${sessionKey}`);
                    const data = await response.json();

                    if (data.status.code !== 'OK_0000') {
                        console.warn('ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', data.status.message);
                        clearInterval(sessionCheckInterval);
                        showErrorMessage('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    }
                } catch (error) {
                    console.error('ì„¸ì…˜ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                }
            }
        }, 30000); // 30ì´ˆë§ˆë‹¤ í™•ì¸
    }

    // 3. ë¹„ë””ì˜¤ ì¬ìƒ ì•ˆì •ì„± ê°œì„ 
    function enhanceVideoPlayback() {
        // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        mainVideo.addEventListener('error', (e) => {
            console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e);
            statusText.textContent = 'ì˜ìƒ ì˜¤ë¥˜';

            // 3ì´ˆ í›„ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ ì‹œë„
            setTimeout(async () => {
                try {
                    await playWaitingVideo();
                } catch (error) {
                    console.error('ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì‹¤íŒ¨:', error);
                }
            }, 3000);
        });

        // ë¹„ë””ì˜¤ ë¡œë”© ìƒíƒœ ëª¨ë‹ˆí„°ë§
        mainVideo.addEventListener('loadstart', () => {
            console.log('ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘');
        });

        mainVideo.addEventListener('canplay', () => {
            console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
        });

        mainVideo.addEventListener('stalled', () => {
            console.warn('ë¹„ë””ì˜¤ ë¡œë”© ì§€ì—°');
            statusText.textContent = 'ì˜ìƒ ë¡œë”© ì¤‘...';
        });
    }

    // 4. ë©”ëª¨ë¦¬ ì •ë¦¬ ê°œì„ 
    function enhancedCleanup() {
        // ê¸°ì¡´ SSE ì •ë¦¬
        if (sseEventSource) {
            sseEventSource.close();
            sseEventSource = null;
        }

        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (guideTimeout) {
            clearTimeout(guideTimeout);
            guideTimeout = null;
        }

        if (sessionCheckInterval) {
            clearInterval(sessionCheckInterval);
            sessionCheckInterval = null;
        }

        // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        if (userMediaStream) {
            userMediaStream.getTracks().forEach(track => {
                track.stop();
                console.log('ë¯¸ë””ì–´ íŠ¸ë™ ì •ë¦¬:', track.kind);
            });
            userMediaStream = null;
        }

        // ë…¹í™” ë°ì´í„° ì •ë¦¬
        recordedChunks = [];

        console.log('ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ');
    }

    // 5. ê°œì„ ëœ ì´ˆê¸°í™” (ê¸°ì¡´ initializeVideoCall í•¨ìˆ˜ ë’¤ì— í˜¸ì¶œ)
    function enhancedInitialization() {
        // ë¹„ë””ì˜¤ ì¬ìƒ ì•ˆì •ì„± ê°œì„ 
        enhanceVideoPlayback();

        // ì„¸ì…˜ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ì„ íƒì )
        // startSessionMonitoring();

        console.log('ê³ ê¸‰ ê¸°ëŠ¥ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    // 6. ê°œì„ ëœ ì¢…ë£Œ í•¨ìˆ˜ (ê¸°ì¡´ endCall í•¨ìˆ˜ ëŒ€ì²´)
    function endCall() {
        if (confirm('ì˜ìƒí†µí™”ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            // ê°•í™”ëœ ì •ë¦¬ í•¨ìˆ˜ ì‚¬ìš©
            enhancedCleanup();

            // ë…¹í™” ì¤‘ì´ë©´ ê°•ì œ ì¤‘ì§€
            if (isRecording && mediaRecorder) {
                try {
                    mediaRecorder.stop();
                    isRecording = false;
                } catch (error) {
                    console.error('ë…¹í™” ì¤‘ì§€ ì˜¤ë¥˜:', error);
                }
            }

            sessionKey = null;
            window.location.href = '/mobile/home';
        }
    }

    // 7. ê°œì„ ëœ í˜ì´ì§€ ì–¸ë¡œë“œ ì²˜ë¦¬
    window.addEventListener('beforeunload', () => {
        enhancedCleanup();
    });

    // 8. í˜ì´ì§€ ìˆ¨ê¹€/í‘œì‹œ ì²˜ë¦¬ (ëª¨ë°”ì¼ ì•± ì „í™˜ ì‹œ)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ (ì•± ì „í™˜)');
            // í•„ìš”ì‹œ ë…¹í™” ì¼ì‹œì •ì§€ ë“± ì²˜ë¦¬
        } else {
            console.log('í˜ì´ì§€ê°€ í‘œì‹œë¨ (ì•± ë³µê·€)');
            // ì—°ê²° ìƒíƒœ í™•ì¸ ë° ë³µêµ¬
            if (sessionKey && (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN)) {
                setTimeout(() => {
                    console.log('ì•± ë³µê·€ í›„ SSE ì¬ì—°ê²°');
                    connectSSE();
                }, 500);
            }
        }
    });

    // 9. í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™” (ëª¨ë°”ì¼)
    if ('ontouchstart' in window) {
        // í„°ì¹˜ ì§€ì—° ì œê±°
        document.addEventListener('touchstart', function () {
        }, {passive: true});

        // ë”ë¸” íƒ­ ì¤Œ ë°©ì§€ (í•„ìš”ì‹œ)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }

    // 10. ì´ˆê¸°í™” í•¨ìˆ˜ì— ê³ ê¸‰ ê¸°ëŠ¥ ì¶”ê°€ (ê¸°ì¡´ window.addEventListener('load') ìˆ˜ì •)
    window.addEventListener('load', () => {
        initializeVideoCall();

        // ê³ ê¸‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
        enhancedInitialization();

        setTimeout(() => {
            showAudioGuide();
        }, 1000);
    });

    console.log('ê³ ê¸‰ ê¸°ëŠ¥ ë¡œë“œ ì™„ë£Œ');
</script>
</body>
</html>