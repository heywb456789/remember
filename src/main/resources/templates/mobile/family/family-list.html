<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ì¡±ê´€ë¦¬ - í† ë§ˆí† ë¦¬ë©¤ë²„</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link th:href="@{/bootstrap/css/bootstrap.css}" rel="stylesheet"/>
    <!-- Common CSS -->
    <link th:href="@{/assets/mobile/css/common.css}" rel="stylesheet"/>
    <!-- Family List CSS -->
    <!-- Family List CSS -->
    <link th:href="@{/assets/mobile/css/family-list.css}" rel="stylesheet"/>
</head>

<body>
<div class="container">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
        <button class="back-btn" id="backBtn" aria-label="ë’¤ë¡œê°€ê¸°">
            <i class="fas fa-chevron-left"></i>
        </button>
        <h1 class="page-title">ê°€ì¡±ê´€ë¦¬</h1>
    </div>

    <!-- ì„œë¸Œíƒ€ì´í‹€ -->
    <p class="page-subtitle">ê°€ì¡± êµ¬ì„±ì›ì„ ì´ˆëŒ€í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>

    <!-- ë©”ëª¨ë¦¬ì–¼ ì„ íƒ ì„¹ì…˜ (ë‚´ê°€ ì†Œìœ í•œ ë©”ëª¨ë¦¬ì–¼ë§Œ) -->
    <div class="memorial-selector-section" th:if="${!memorials.empty}">
        <div class="memorial-selector-header">
            <h3 class="selector-title">
                <i class="fas fa-heart"></i>
                ë©”ëª¨ë¦¬ì–¼ ì„ íƒ
            </h3>
            <p class="selector-description">ê´€ë¦¬í•  ë©”ëª¨ë¦¬ì–¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <!-- ë©”ëª¨ë¦¬ì–¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <div class="memorial-dropdown">
            <button class="memorial-select-btn" id="memorialSelectBtn">
                <div class="selected-memorial">
                    <div class="memorial-avatar" id="selectedMemorialAvatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="memorial-info">
                        <div class="memorial-name" id="selectedMemorialName">ì „ì²´</div>
                        <div class="memorial-relation" id="selectedMemorialRelation">ëª¨ë“  ë©”ëª¨ë¦¬ì–¼ì˜ ê°€ì¡± êµ¬ì„±ì›</div>
                    </div>
                </div>
                <div class="dropdown-arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </button>

            <!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
            <div class="memorial-dropdown-menu" id="memorialDropdownMenu">
                <div class="memorial-list">
                    <!-- ì „ì²´ ì˜µì…˜ (ê¸°ë³¸ ì„ íƒ) -->
                    <button class="memorial-item selected" data-memorial-id="all">
                        <div class="memorial-avatar">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="memorial-info">
                            <div class="memorial-name">ì „ì²´</div>
                            <div class="memorial-relation">ëª¨ë“  ë©”ëª¨ë¦¬ì–¼ì˜ ê°€ì¡± êµ¬ì„±ì›</div>
                        </div>
                        <div class="memorial-stats">
                            <i class="fas fa-users"></i>
                            <span th:text="${totalMembers ?: 0}">0</span>
                        </div>
                    </button>

                    <!-- ê°œë³„ ë©”ëª¨ë¦¬ì–¼ë“¤ -->
                    <button th:each="memorial : ${memorials}"
                            class="memorial-item"
                            th:attr="data-memorial-id=${memorial.id}">
                        <div class="memorial-avatar">
                            <span class="memorial-emoji" th:switch="${memorial.relationship?.name()}">
                                <!-- ë¶€ëª¨ë‹˜ ê´€ê³„ -->
                                <span th:case="'FATHER'" class="emoji">ğŸ‘¨</span>
                                <span th:case="'MOTHER'" class="emoji">ğŸ‘©</span>
                                <span th:case="'SPOUSE_FATHER'" class="emoji">ğŸ‘¨</span>
                                <span th:case="'SPOUSE_MOTHER'" class="emoji">ğŸ‘©</span>

                                <!-- ì¡°ë¶€ëª¨ë‹˜ ê´€ê³„ -->
                                <span th:case="'GRANDFATHER'" class="emoji">ğŸ‘´</span>
                                <span th:case="'GRANDMOTHER'" class="emoji">ğŸ‘µ</span>

                                <!-- ë°°ìš°ì ê´€ê³„ -->
                                <span th:case="'SPOUSE'" class="emoji">ğŸ’‘</span>

                                <!-- ìë…€ ê´€ê³„ -->
                                <span th:case="'CHILD'" class="emoji">ğŸ‘¶</span>

                                <!-- í˜•ì œ/ìë§¤ ê´€ê³„ -->
                                <span th:case="'SIBLING'" class="emoji">ğŸ‘«</span>

                                <!-- ë³¸ì¸ -->
                                <span th:case="'SELF'" class="emoji">ğŸ˜Š</span>

                                <!-- ê¸°íƒ€ ë˜ëŠ” ê¸°ë³¸ê°’ -->
                                <span th:case="*" class="emoji">ğŸ‘¤</span>
                            </span>
                        </div>
                        <div class="memorial-info">
                            <div class="memorial-name" th:text="${memorial.nickname + ' (' + memorial.name + ')'}">ë©”ëª¨ë¦¬ì–¼ëª…</div>
                            <div class="memorial-relation">ë‚´ê°€ ìƒì„±í•œ ë©”ëª¨ë¦¬ì–¼</div>
                        </div>
                        <div class="memorial-stats">
                            <i class="fas fa-users"></i>
                            <span>-</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ê°€ì¡± êµ¬ì„±ì› ì´ˆëŒ€ ì¹´ë“œ -->
    <div class="invite-card" th:if="${!memorials.empty}">
        <div class="invite-content">
            <div class="invite-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <h2 class="invite-title">ìƒˆ ê°€ì¡± êµ¬ì„±ì› ì´ˆëŒ€</h2>
            <p class="invite-description">ì´ë©”ì¼ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê°€ì¡±ì„ ì´ˆëŒ€í•˜ì„¸ìš”</p>
            <button class="invite-btn" id="inviteBtn">
                ì´ˆëŒ€ ë§í¬ ë³´ë‚´ê¸°
            </button>
        </div>
    </div>

    <!-- ë“±ë¡ëœ ê°€ì¡± êµ¬ì„±ì› ì„¹ì…˜ -->
    <div class="family-section">
        <div class="family-section-header">
            <h3 class="family-section-title">ë“±ë¡ëœ ê°€ì¡± êµ¬ì„±ì›</h3>
            <div class="family-section-actions">
                <button class="refresh-btn" id="refreshBtn" title="ìƒˆë¡œê³ ì¹¨">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="family-stats">
                    <span class="stat-item">
                        <i class="fas fa-users"></i>
                        <span id="totalMembersCount" th:text="${totalMembers ?: 0}">0</span>ëª…
                    </span>
                </div>
            </div>
        </div>

        <!-- ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ -->
        <div id="familyMembersList" class="family-members-container">
            <!-- ê°€ì¡± êµ¬ì„±ì›ì´ ìˆëŠ” ê²½ìš° -->
            <div th:if="${familyMembers != null and !familyMembers.empty}">
                <div class="family-member-card"
                     th:each="member : ${familyMembers}"
                     th:class="'family-member-card' + (${member.relationship.name() == 'SELF'} ? ' owner-card' : '')"
                     th:attr="data-member-id=${member.id}">

                    <div class="member-content">
                        <div class="member-info">
                            <!-- ì•„ë°”íƒ€ -->
                            <div th:class="'member-avatar' + (${member.relationship.name() == 'SELF'} ? ' owner-avatar' : '')">
                                <span th:text="${member.member?.name?.substring(0,1) ?: '?'}">?</span>
                            </div>

                            <div class="member-details">
                                <!-- ì´ë¦„ + ì†Œìœ ì ë°°ì§€ -->
                                <div class="member-name">
                                    <span th:text="${member.member?.name ?: 'ì•Œ ìˆ˜ ì—†ìŒ'}">ì•Œ ìˆ˜ ì—†ìŒ</span>
                                    <span class="owner-badge" th:if="${member.relationship.name() == 'SELF'}">
                                        <i class="fas fa-crown"></i> ì†Œìœ ì
                                    </span>
                                </div>

                                <!-- ê´€ê³„ ì •ë³´ -->
                                <div class="member-relation">
                                    <span th:text="'ë©”ëª¨ë¦¬ì–¼: ' + ${member.memorial?.nickname ?: 'ì•Œ ìˆ˜ ì—†ìŒ'}">ë©”ëª¨ë¦¬ì–¼: ì•Œ ìˆ˜ ì—†ìŒ</span>
                                    <span th:text="' â€¢ ê³ ì¸ê³¼ì˜ ê´€ê³„: ' + ${member.relationshipDisplayName ?: 'ë¯¸ì„¤ì •'}"> â€¢ ê³ ì¸ê³¼ì˜ ê´€ê³„: ë¯¸ì„¤ì •</span>
                                </div>

                                <!-- ìƒíƒœ ì •ë³´ -->
                                <div th:class="'member-status' + (${member.relationship.name() == 'SELF'} ? ' status-owner' : ' status-' + ${member.inviteStatus.name()?.toLowerCase()})">
                                    <span th:text="'ìƒíƒœ: ' + ${member.inviteStatusDisplayName ?: 'ì•Œ ìˆ˜ ì—†ìŒ'}">ìƒíƒœ: ì•Œ ìˆ˜ ì—†ìŒ</span>
                                </div>
                            </div>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                        <div class="member-actions">
                            <!-- ì†Œìœ ìëŠ” ê¶Œí•œ ë²„íŠ¼ ë¹„í™œì„±í™” -->
                            <th:block th:if="${member.relationship.name() == 'SELF'}">
                                <button class="permission-btn owner-permission" disabled>
                                    ëª¨ë“  ê¶Œí•œ
                                </button>
                            </th:block>

                            <!-- ì¼ë°˜ ê°€ì¡± êµ¬ì„±ì› -->
                            <th:block th:if="${member.relationship.name() != 'SELF'}">
                                <button th:class="'permission-btn' + (${member.permissions?.memorialAccess == true} ? ' granted' : ' denied')"
                                        th:attr="data-member-id=${member.id}">
                                    <span th:if="${member.permissions?.memorialAccess == true}">ê¶Œí•œ ì„¤ì •</span>
                                    <span th:if="${member.permissions?.memorialAccess != true}">ê¶Œí•œ ì—†ìŒ</span>
                                </button>

                                <button class="menu-btn"
                                        th:attr="data-member-id=${member.id}, data-member-name=${member.member?.name ?: 'Unknown'}"
                                        aria-label="ë”ë³´ê¸°">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </th:block>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" th:if="${familyMembers == null or familyMembers.empty}">
                <i class="fas fa-user-plus"></i>
                <h4>ë“±ë¡ëœ ê°€ì¡± êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ìƒˆ ê°€ì¡± êµ¬ì„±ì›ì„ ì´ˆëŒ€í•˜ì—¬<br>í•¨ê»˜ ì†Œì¤‘í•œ ì¶”ì–µì„ ë‚˜ëˆ„ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <!-- ë©”ëª¨ë¦¬ì–¼ ì—†ìŒ ìƒíƒœ -->
    <div class="empty-state" th:if="${memorials.empty}">
        <i class="fas fa-plus-circle"></i>
        <h4>ë©”ëª¨ë¦¬ì–¼ì´ ì—†ìŠµë‹ˆë‹¤</h4>
        <p>ìƒˆë¡œìš´ ë©”ëª¨ë¦¬ì–¼ì„ ë“±ë¡í•˜ì—¬<br>ê°€ì¡±ë“¤ê³¼ ì¶”ì–µì„ ë‚˜ëˆ„ì„¸ìš”</p>
        <a href="/mobile/memorial/create" class="btn btn-primary">ìƒˆ ë©”ëª¨ë¦¬ì–¼ ë“±ë¡</a>
    </div>
</div>

<!-- ì´ˆëŒ€ ëª¨ë‹¬ -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê°€ì¡± êµ¬ì„±ì› ì´ˆëŒ€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inviteForm">
                    <!-- ì´ˆëŒ€ ë°©ë²• ì„ íƒ -->
                    <div class="form-group">
                        <label class="form-label">ì´ˆëŒ€ ë°©ë²•</label>
                        <div class="method-group active" id="emailMethodGroup">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="inviteMethod" id="emailMethod" value="email" checked>
                                <label class="form-check-label" for="emailMethod">
                                    <i class="fas fa-envelope"></i> ì´ë©”ì¼ë¡œ ì´ˆëŒ€
                                </label>
                            </div>
                            <div class="form-group" id="emailGroup">
                                <input type="email" class="form-control" id="inviteEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                        </div>

                        <div class="method-group" id="smsMethodGroup">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="inviteMethod" id="smsMethod" value="sms">
                                <label class="form-check-label" for="smsMethod">
                                    <i class="fas fa-sms"></i> ë¬¸ìë©”ì‹œì§€ë¡œ ì´ˆëŒ€
                                </label>
                            </div>
                            <div class="form-group" id="phoneGroup" style="display: none;">
                                <input type="tel" class="form-control" id="invitePhone" placeholder="010-0000-0000">
                            </div>
                        </div>
                    </div>

                    <!-- ê´€ê³„ ì„ íƒ -->
                    <div class="form-group">
                        <label for="inviteRelationship" class="form-label">ê³ ì¸ê³¼ì˜ ê´€ê³„</label>
                        <select class="form-control" id="inviteRelationship" required>
                            <option value="">ê´€ê³„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="SPOUSE">ë°°ìš°ì</option>
                            <option value="CHILD">ìë…€</option>
                            <option value="PARENT">ë¶€ëª¨</option>
                            <option value="SIBLING">í˜•ì œ/ìë§¤</option>
                            <option value="GRANDPARENT">ì¡°ë¶€ëª¨</option>
                            <option value="GRANDCHILD">ì†ì/ì†ë…€</option>
                            <option value="RELATIVE">ì¹œì²™</option>
                            <option value="FRIEND">ì¹œêµ¬</option>
                            <option value="OTHER">ê¸°íƒ€</option>
                        </select>
                    </div>

                    <!-- ì´ˆëŒ€ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­) -->
                    <div class="form-group">
                        <label for="inviteMessage" class="form-label">ì´ˆëŒ€ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)</label>
                        <textarea class="form-control" id="inviteMessage" rows="3" placeholder="ì´ˆëŒ€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="sendInviteBtn">ì´ˆëŒ€ ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script th:src="@{/bootstrap/js/bootstrap.bundle.js}"></script>

<!-- í† í° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
<div th:replace="~{fragments/token-sync :: tokenSync}"></div>

<!-- Common JS -->
<script th:src="@{/assets/mobile/js/common.js}" type="module"></script>
<script th:src="@{/assets/mobile/js/commonFetch.js}" type="module"></script>

<script th:inline="javascript">
    // ì„œë²„ ë°ì´í„° ì„¤ì • (ê°„ë‹¨í•œ ë°ì´í„°ë§Œ ì „ë‹¬)
    window.serverData = {
        memorials: [
            /*[# th:each="memorial : ${memorials}"]*/
            {
                id: /*[[ ${memorial.id} ]]*/,
                name: /*[[ ${memorial.name} ]]*/,
                nickname: /*[[ ${memorial.nickname} ]]*/,
                relationship: /*[[ ${memorial.relationship?.name()} ]]*/,
                mainProfileImageUrl: /*[[ ${memorial.mainProfileImageUrl} ]]*/ null
            }/*[# th:if="${!memorialStat.last}"]*/,/*[/]*/
            /*[/]*/
        ],
        familyMembers: [
            /*[# th:each="member : ${familyMembers}"]*/
            {
                id: /*[[ ${member.id} ]]*/,
                relationship: /*[[ ${member.relationship?.name()} ]]*/,
                relationshipDisplayName: /*[[ ${member.relationshipDisplayName} ]]*/,
                inviteStatus: /*[[ ${member.inviteStatus?.name()} ]]*/,
                inviteStatusDisplayName: /*[[ ${member.inviteStatusDisplayName} ]]*/,
                memorial: {
                    id: /*[[ ${member.memorial?.id} ]]*/,
                    nickname: /*[[ ${member.memorial?.nickname} ]]*/
                },
                member: {
                    id: /*[[ ${member.member?.id} ]]*/,
                    name: /*[[ ${member.member?.name} ]]*/
                },
                permissions: {
                    memorialAccess: /*[[ ${member.permissions?.memorialAccess ?: false} ]]*/,
                    videoCallAccess: /*[[ ${member.permissions?.videoCallAccess ?: false} ]]*/
                }
            }/*[# th:if="${!memberStat.last}"]*/,/*[/]*/
            /*[/]*/
        ],
        selectedMemorial: null,
        totalMemorials: /*[[ ${totalMemorials ?: 0} ]]*/,
        totalMembers: /*[[ ${totalMembers ?: 0} ]]*/
    };

    // í˜„ì¬ ì„ íƒëœ ë©”ëª¨ë¦¬ì–¼ ID (null = ì „ì²´ ì„ íƒ)
    window.currentMemorialId = null;

    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ë©”ëª¨ë¦¬ì–¼:', window.serverData.memorials.length, 'êµ¬ì„±ì›:', window.serverData.familyMembers.length);
</script>

<!-- Family List JS -->
<script type="module">
    import { authFetch } from '/assets/mobile/js/commonFetch.js';
    import { showToast, showConfirm } from '/assets/mobile/js/common.js';

    // ì „ì—­ ìƒíƒœ
    let pageState = {
        currentMemorialId: null,
        allMembers: [],
        filteredMembers: []
    };

    /**
     * í˜ì´ì§€ ì´ˆê¸°í™”
     */
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ê°€ì¡± ëª©ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

        try {
            // ì„œë²„ ë°ì´í„° ë¡œë“œ
            loadServerData();

            // ì´ë²¤íŠ¸ ë°”ì¸ë”©
            bindEvents();

            // ì´ˆê¸°ì—ëŠ” ì „ì²´ ì„ íƒ ìƒíƒœë¡œ ì‹œì‘
            pageState.currentMemorialId = 'all';
            pageState.filteredMembers = pageState.allMembers;

            console.log('ê°€ì¡± ëª©ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            console.error('ê°€ì¡± ëª©ë¡ í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            showToast('í˜ì´ì§€ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    });

    /**
     * ì„œë²„ ë°ì´í„° ë¡œë“œ
     */
    function loadServerData() {
        if (window.serverData) {
            pageState.allMembers = window.serverData.familyMembers || [];
            pageState.currentMemorialId = window.currentMemorialId;

            console.log('ì„œë²„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ - ì „ì²´ êµ¬ì„±ì›:', pageState.allMembers.length);
        }
    }

    /**
     * ë©”ëª¨ë¦¬ì–¼ ì„ íƒ
     */
    function selectMemorial(memorialId) {
        console.log('ë©”ëª¨ë¦¬ì–¼ ì„ íƒ:', memorialId);

        pageState.currentMemorialId = memorialId;

        if (memorialId === 'all') {
            // ì „ì²´ ì„ íƒ - ëª¨ë“  êµ¬ì„±ì› í‘œì‹œ
            pageState.filteredMembers = pageState.allMembers;
            updateSelectedMemorialUI('all');
        } else {
            // íŠ¹ì • ë©”ëª¨ë¦¬ì–¼ ì„ íƒ - í•´ë‹¹ ë©”ëª¨ë¦¬ì–¼ì˜ êµ¬ì„±ì›ë§Œ í•„í„°ë§
            pageState.filteredMembers = pageState.allMembers.filter(
                member => member.memorial.id === memorialId
            );
            updateSelectedMemorialUI(memorialId);
        }

        // UI ì—…ë°ì´íŠ¸
        updateFamilyMembersList(pageState.filteredMembers);
        closeMemorialDropdown();

        console.log('ë©”ëª¨ë¦¬ì–¼ ì„ íƒ ì™„ë£Œ - í•„í„°ë§ëœ êµ¬ì„±ì›:', pageState.filteredMembers.length);
    }

    /**
     * ì„ íƒëœ ë©”ëª¨ë¦¬ì–¼ UI ì—…ë°ì´íŠ¸
     */
    function updateSelectedMemorialUI(memorialId) {
        const avatarElement = document.getElementById('selectedMemorialAvatar');
        const nameElement = document.getElementById('selectedMemorialName');
        const relationElement = document.getElementById('selectedMemorialRelation');

        if (memorialId === 'all') {
            // ì „ì²´ ì„ íƒ
            if (avatarElement) {
                avatarElement.innerHTML = '<i class="fas fa-users"></i>';
            }
            if (nameElement) {
                nameElement.textContent = 'ì „ì²´';
            }
            if (relationElement) {
                relationElement.textContent = 'ëª¨ë“  ë©”ëª¨ë¦¬ì–¼ì˜ ê°€ì¡± êµ¬ì„±ì›';
            }
        } else {
            // íŠ¹ì • ë©”ëª¨ë¦¬ì–¼ ì„ íƒ
            const memorial = window.serverData.memorials.find(m => m.id === memorialId);
            if (!memorial) return;

            if (avatarElement) {
                // ê´€ê³„ì— ë”°ë¥¸ ì´ëª¨ì§€ í‘œì‹œ
                const emoji = getRelationshipEmoji(memorial.relationship?.name);
                avatarElement.innerHTML = `<span class="emoji">${emoji}</span>`;
            }

            if (nameElement) {
                nameElement.textContent = `${memorial.nickname} (${memorial.name})`;
            }

            if (relationElement) {
                relationElement.textContent = 'ì„ íƒëœ ë©”ëª¨ë¦¬ì–¼';
            }
        }

        // ë“œë¡­ë‹¤ìš´ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.memorial-item').forEach(item => {
            const itemMemorialId = item.getAttribute('data-memorial-id');
            if (itemMemorialId === String(memorialId)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    /**
     * ê´€ê³„ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
     */
    function getRelationshipEmoji(relationship) {
        const emojiMap = {
            'FATHER': 'ğŸ‘¨',
            'MOTHER': 'ğŸ‘©',
            'SPOUSE_FATHER': 'ğŸ‘¨',
            'SPOUSE_MOTHER': 'ğŸ‘©',
            'GRANDFATHER': 'ğŸ‘´',
            'GRANDMOTHER': 'ğŸ‘µ',
            'SPOUSE': 'ğŸ’‘',
            'CHILD': 'ğŸ‘¶',
            'SIBLING': 'ğŸ‘«',
            'SELF': 'ğŸ˜Š'
        };
        return emojiMap[relationship] || 'ğŸ‘¤';
    }

    /**
     * ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ ì—…ë°ì´íŠ¸
     */
    function updateFamilyMembersList(members) {
        const listContainer = document.getElementById('familyMembersList');
        const totalCountElement = document.getElementById('totalMembersCount');

        if (totalCountElement) {
            totalCountElement.textContent = members.length;
        }

        if (!members || members.length === 0) {
            listContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-plus"></i>
                    <h4>ë“±ë¡ëœ ê°€ì¡± êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ìƒˆ ê°€ì¡± êµ¬ì„±ì›ì„ ì´ˆëŒ€í•˜ì—¬<br>í•¨ê»˜ ì†Œì¤‘í•œ ì¶”ì–µì„ ë‚˜ëˆ„ì„¸ìš”</p>
                </div>
            `;
            return;
        }

        const membersHtml = members.map(member => {
            const memberName = member.member?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const isOwner = member.relationship === 'SELF';
            const memorialAccess = member.permissions?.memorialAccess || false;

            return `
                <div class="family-member-card ${isOwner ? 'owner-card' : ''}">
                    <div class="member-content">
                        <div class="member-info">
                            <div class="member-avatar ${isOwner ? 'owner-avatar' : ''}">
                                <span>${memberName.charAt(0)}</span>
                            </div>
                            <div class="member-details">
                                <div class="member-name">
                                    <span>${memberName}</span>
                                    ${isOwner ? '<span class="owner-badge"><i class="fas fa-crown"></i> ì†Œìœ ì</span>' : ''}
                                </div>
                                <div class="member-relation">
                                    ë©”ëª¨ë¦¬ì–¼: ${member.memorial?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'} â€¢ ê³ ì¸ê³¼ì˜ ê´€ê³„: ${member.relationshipDisplayName || 'ë¯¸ì„¤ì •'}
                                </div>
                                <div class="member-status ${isOwner ? 'status-owner' : 'status-' + (member.inviteStatus || 'pending').toLowerCase()}">
                                    <span>ìƒíƒœ: ${member.inviteStatusDisplayName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="member-actions">
                            ${isOwner ? `
                                <button class="permission-btn owner-permission" disabled>
                                    ëª¨ë“  ê¶Œí•œ
                                </button>
                            ` : `
                                <button class="permission-btn ${memorialAccess ? 'granted' : 'denied'}"
                                        data-member-id="${member.id}">
                                    ${memorialAccess ? 'ê¶Œí•œ ì„¤ì •' : 'ê¶Œí•œ ì—†ìŒ'}
                                </button>
                                <button class="menu-btn" data-member-id="${member.id}" data-member-name="${memberName}"
                                        aria-label="ë”ë³´ê¸°">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        listContainer.innerHTML = membersHtml;

        // ìƒˆë¡œ ìƒì„±ëœ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindMemberActionEvents();
    }

    /**
     * ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (API í˜¸ì¶œ)
     */
    async function refreshFamilyMembersList() {
        if (!pageState.currentMemorialId || pageState.currentMemorialId === 'all') {
            showToast('íŠ¹ì • ë©”ëª¨ë¦¬ì–¼ì„ ì„ íƒí•œ í›„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        try {
            const response = await authFetch(`/api/family/memorial/${pageState.currentMemorialId}/members`);
            const result = await response.json();

            if (result.status?.code === 'OK_0000') {
                const newMembers = result.response || [];

                // ì„œë²„ ë°ì´í„° ì—…ë°ì´íŠ¸ (í•´ë‹¹ ë©”ëª¨ë¦¬ì–¼ë§Œ)
                pageState.allMembers = pageState.allMembers.filter(
                    member => member.memorial.id !== pageState.currentMemorialId
                );
                pageState.allMembers.push(...newMembers);

                // í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ì—…ë°ì´íŠ¸
                pageState.filteredMembers = newMembers;

                // UI ì—…ë°ì´íŠ¸
                updateFamilyMembersList(pageState.filteredMembers);

                showToast('ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                throw new Error(result.status?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            }
        } catch (error) {
            console.error('ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
            showToast('ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        }
    }

    /**
     * ë©”ëª¨ë¦¬ì–¼ ë“œë¡­ë‹¤ìš´ í† ê¸€
     */
    function toggleMemorialDropdown() {
        const dropdown = document.getElementById('memorialDropdownMenu');
        const button = document.getElementById('memorialSelectBtn');

        if (!dropdown || !button) return;

        if (dropdown.classList.contains('show')) {
            closeMemorialDropdown();
        } else {
            dropdown.classList.add('show');
            button.classList.add('active');
        }
    }

    /**
     * ë©”ëª¨ë¦¬ì–¼ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
     */
    function closeMemorialDropdown() {
        const dropdown = document.getElementById('memorialDropdownMenu');
        const button = document.getElementById('memorialSelectBtn');

        if (dropdown) dropdown.classList.remove('show');
        if (button) button.classList.remove('active');
    }

    /**
     * ì´ˆëŒ€ ëª¨ë‹¬ ì—´ê¸°
     */
    function openInviteModal() {
        if (!pageState.currentMemorialId || pageState.currentMemorialId === 'all') {
            showToast('íŠ¹ì • ë©”ëª¨ë¦¬ì–¼ì„ ì„ íƒí•œ í›„ ì´ˆëŒ€í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('inviteModal'));
        modal.show();
    }

    /**
     * ì´ˆëŒ€ ë³´ë‚´ê¸°
     */
    async function sendInvite() {
        const method = document.querySelector('input[name="inviteMethod"]:checked')?.value;
        const email = document.getElementById('inviteEmail')?.value;
        const phone = document.getElementById('invitePhone')?.value;
        const relationship = document.getElementById('inviteRelationship')?.value;
        const message = document.getElementById('inviteMessage')?.value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!relationship) {
            showToast('ê³ ì¸ê³¼ì˜ ê´€ê³„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        if (method === 'email' && !email) {
            showToast('ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        if (method === 'sms' && !phone) {
            showToast('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        try {
            const btn = document.getElementById('sendInviteBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì „ì†¡ ì¤‘...';

            const inviteData = {
                method: method,
                contact: method === 'email' ? email : phone,
                relationship: relationship,
                memorialId: pageState.currentMemorialId,
                message: message
            };

            const response = await authFetch('/api/family/invite', {
                method: 'POST',
                body: JSON.stringify(inviteData)
            });

            const result = await response.json();

            if (result.status?.code === 'OK_0000') {
                bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
                showToast('ì´ˆëŒ€ ë§í¬ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // í¼ ë¦¬ì…‹
                document.getElementById('inviteForm').reset();
                document.getElementById('emailMethodGroup').classList.add('active');
                document.getElementById('smsMethodGroup').classList.remove('active');
                document.getElementById('emailGroup').style.display = 'block';
                document.getElementById('phoneGroup').style.display = 'none';

                // 3ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    refreshFamilyMembersList();
                }, 3000);
            } else {
                showToast(result.status?.message || 'ì´ˆëŒ€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ì´ˆëŒ€ ì „ì†¡ ì‹¤íŒ¨:', error);
            showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            const btn = document.getElementById('sendInviteBtn');
            btn.disabled = false;
            btn.textContent = 'ì´ˆëŒ€ ë³´ë‚´ê¸°';
        }
    }

    /**
     * ê¶Œí•œ ì„¤ì • ëª¨ë‹¬ (ì„ì‹œ)
     */
    function openPermissionModal(memberId) {
        showToast('ê¶Œí•œ ì„¤ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    /**
     * êµ¬ì„±ì› ë©”ë‰´ (ì„ì‹œ)
     */
    function showMemberMenu(memberId, memberName) {
        showToast(`${memberName}ë‹˜ì˜ ë©”ë‰´ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.`, 'info');
    }

    /**
     * êµ¬ì„±ì› ì•¡ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
     */
    function bindMemberActionEvents() {
        // ê¶Œí•œ ì„¤ì • ë²„íŠ¼
        document.querySelectorAll('.permission-btn:not(.owner-permission)').forEach(btn => {
            btn.addEventListener('click', function() {
                const memberId = this.getAttribute('data-member-id');
                openPermissionModal(memberId);
            });
        });

        // ë©”ë‰´ ë²„íŠ¼
        document.querySelectorAll('.menu-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const memberId = this.getAttribute('data-member-id');
                const memberName = this.getAttribute('data-member-name');
                showMemberMenu(memberId, memberName);
            });
        });
    }

    /**
     * ì´ë²¤íŠ¸ ë°”ì¸ë”©
     */
    function bindEvents() {
        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                window.history.back();
            });
        }

        // ë©”ëª¨ë¦¬ì–¼ ì„ íƒ ë²„íŠ¼
        const memorialSelectBtn = document.getElementById('memorialSelectBtn');
        if (memorialSelectBtn) {
            memorialSelectBtn.addEventListener('click', toggleMemorialDropdown);
        }

        // ë©”ëª¨ë¦¬ì–¼ ë“œë¡­ë‹¤ìš´ ì•„ì´í…œë“¤
        document.querySelectorAll('.memorial-item').forEach(item => {
            item.addEventListener('click', function() {
                const memorialId = this.getAttribute('data-memorial-id');
                selectMemorial(memorialId === 'all' ? 'all' : parseInt(memorialId));
            });
        });

        // ì´ˆëŒ€ ë²„íŠ¼
        const inviteBtn = document.getElementById('inviteBtn');
        if (inviteBtn) {
            inviteBtn.addEventListener('click', openInviteModal);
        }

        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshFamilyMembersList);
        }

        // ì´ˆëŒ€ ë°©ë²• ë¼ë””ì˜¤ ë²„íŠ¼
        const emailMethod = document.getElementById('emailMethod');
        const smsMethod = document.getElementById('smsMethod');
        const emailGroup = document.getElementById('emailGroup');
        const phoneGroup = document.getElementById('phoneGroup');
        const emailMethodGroup = document.getElementById('emailMethodGroup');
        const smsMethodGroup = document.getElementById('smsMethodGroup');

        if (emailMethod && smsMethod) {
            emailMethod.addEventListener('change', function() {
                if (this.checked) {
                    if (emailGroup) emailGroup.style.display = 'block';
                    if (phoneGroup) phoneGroup.style.display = 'none';
                    if (emailMethodGroup) emailMethodGroup.classList.add('active');
                    if (smsMethodGroup) smsMethodGroup.classList.remove('active');
                }
            });

            smsMethod.addEventListener('change', function() {
                if (this.checked) {
                    if (emailGroup) emailGroup.style.display = 'none';
                    if (phoneGroup) phoneGroup.style.display = 'block';
                    if (emailMethodGroup) emailMethodGroup.classList.remove('active');
                    if (smsMethodGroup) smsMethodGroup.classList.add('active');
                }
            });
        }

        // ì „í™”ë²ˆí˜¸ í˜•ì‹ ìë™ ë³€í™˜
        const phoneInput = document.getElementById('invitePhone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length > 3 && value.length <= 7) {
                    value = value.replace(/(\d{3})(\d+)/, '$1-$2');
                } else if (value.length > 7) {
                    value = value.replace(/(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
                }
                e.target.value = value;
            });
        }

        // ì´ˆëŒ€ ë³´ë‚´ê¸° ë²„íŠ¼
        const sendInviteBtn = document.getElementById('sendInviteBtn');
        if (sendInviteBtn) {
            sendInviteBtn.addEventListener('click', sendInvite);
        }

        // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ê°ì§€
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('memorialDropdownMenu');
            const button = document.getElementById('memorialSelectBtn');

            if (dropdown && button) {
                if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                    closeMemorialDropdown();
                }
            }
        });

        // ì´ˆê¸° êµ¬ì„±ì› ì•¡ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindMemberActionEvents();
    }

    console.log('family-list-simple.js ë¡œë“œ ì™„ë£Œ');
</script>
</body>
</html>