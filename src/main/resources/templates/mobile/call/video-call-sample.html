<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† ë§ˆí† ë¦¬ë©¤ë²„ - ì˜ìƒí†µí™”</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) */
    .main-video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .main-video {
      width: 100%;
      height: 100%;
      object-fit: contain; /* âœ… cover â†’ containìœ¼ë¡œ ë³€ê²½ */
      background: #000; /* âœ… ì—¬ë°± ë¶€ë¶„ ê²€ì€ìƒ‰ ë°°ê²½ */
      transition: opacity 0.5s ease;
    }

    /* ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) - PC/ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    .my-camera-container {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 160px;
      background: #2c3e50;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }

    .my-camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3498db, #2980b9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” - ê³ ì • ìœ„ì¹˜ ë³´ì¥ */
    .control-bar {
      position: fixed; /* âœ… absolute â†’ fixedë¡œ ë³€ê²½ */
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 30px 20px 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 1000; /* âœ… z-index ë†’ì„ */
      min-height: 120px; /* âœ… ìµœì†Œ ë†’ì´ ë³´ì¥ */
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 30px;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0; /* âœ… ë²„íŠ¼ í¬ê¸° ìœ ì§€ */
    }

    .record-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .record-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .record-btn.recording {
      background: #e74c3c;
      animation: recordingPulse 1.5s ease-in-out infinite;
    }

    .record-btn.recording::after {
      content: '';
      position: absolute;
      width: 80px;
      height: 80px;
      border: 2px solid rgba(231, 76, 60, 0.6);
      border-radius: 50%;
      animation: recordingRing 1.5s ease-out infinite;
    }

    @keyframes recordingPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes recordingRing {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.3);
        opacity: 0;
      }
    }

    .end-call-btn {
      background: #e74c3c;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .end-call-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    /* ìƒíƒœ í‘œì‹œ */
    .status-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      font-size: 14px;
      backdrop-filter: blur(10px);
      z-index: 100;
      transition: opacity 0.3s ease;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #27ae60;
      border-radius: 50%;
      margin-right: 8px;
      animation: statusBlink 2s ease-in-out infinite;
    }

    @keyframes statusBlink {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* ìŒì†Œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .mute-btn {
      background: #95a5a6;
      box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
    }

    .mute-btn:hover {
      background: #7f8c8d;
      transform: scale(1.1);
    }

    .mute-btn.active {
      background: #27ae60;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
    }

    /* ìŒì„± ì•ˆë‚´ ë§í’ì„  */
    .audio-guide {
      position: absolute;
      bottom: 130px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(52, 73, 94, 0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      text-align: center;
      line-height: 1.4;
      backdrop-filter: blur(10px);
      z-index: 150;
      animation: guideBounce 0.5s ease-out;
      display: none;
    }

    .audio-guide.show {
      display: block;
    }

    .guide-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid rgba(52, 73, 94, 0.95);
    }

    .guide-text strong {
      color: #f39c12;
    }

    @keyframes guideBounce {
      0% {
        transform: translateX(-50%) translateY(10px);
        opacity: 0;
      }
      100% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* í„ìŠ¤ íš¨ê³¼ (ë²„íŠ¼ ê°•ì¡°) */
    .mute-btn.pulse {
      animation: mutePulse 1.5s ease-in-out infinite;
    }

    @keyframes mutePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 4px 20px rgba(241, 196, 15, 0.6);
      }
    }

    /* PC/íƒœë¸”ë¦¿ ë°˜ì‘í˜• (768px ì´ìƒ) */
    @media (min-width: 768px) {
      .my-camera-container {
        width: 180px; /* âœ… PCì—ì„œ ì¹´ë©”ë¼ í¬ê¸° í™•ëŒ€ */
        height: 240px;
        top: 30px;
        right: 30px;
      }

      .control-bar {
        padding: 40px 30px 50px;
        gap: 30px;
      }

      .control-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }

      .status-indicator {
        top: 30px;
        left: 30px;
        font-size: 16px;
        padding: 10px 20px;
      }

      .audio-guide {
        bottom: 160px;
        font-size: 16px;
        padding: 16px 20px;
      }

      /* âœ… PCì—ì„œ ë¹„ë””ì˜¤ ë¹„ìœ¨ ì¡°ì • */
      .main-video {
        object-fit: contain; /* PCì—ì„œëŠ” ë¹„ìœ¨ ìœ ì§€ */
      }
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• (480px ì´í•˜) */
    @media (max-width: 480px) {
      .my-camera-container {
        width: 100px;
        height: 133px;
        top: 15px;
        right: 15px;
      }

      .control-bar {
        padding: 20px 15px 30px; /* âœ… ëª¨ë°”ì¼ì—ì„œ íŒ¨ë”© ì¡°ì • */
        gap: 15px;
        min-height: 100px; /* âœ… ëª¨ë°”ì¼ ìµœì†Œ ë†’ì´ */
      }

      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .audio-guide {
        bottom: 120px;
        font-size: 13px;
        padding: 10px 14px;
      }

      .status-indicator {
        top: 15px;
        left: 15px;
        font-size: 12px;
        padding: 6px 12px;
      }

      /* âœ… ëª¨ë°”ì¼ì—ì„œëŠ” cover ìœ ì§€ (í™”ë©´ì— ê½‰ ì°¨ê²Œ) */
      .main-video {
        object-fit: cover;
      }
    }

    /* ì•„ì´í° SE ë° ë§¤ìš° ì‘ì€ í™”ë©´ (375px ì´í•˜) */
    @media (max-width: 375px) {
      .control-bar {
        padding: 15px 10px 25px; /* âœ… ë§¤ìš° ì‘ì€ í™”ë©´ ëŒ€ì‘ */
        gap: 12px;
        min-height: 90px;
      }

      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }

      .my-camera-container {
        width: 80px;
        height: 107px;
        top: 10px;
        right: 10px;
      }
    }

    /* ê°€ë¡œ ëª¨ë“œ ëŒ€ì‘ */
    @media (orientation: landscape) and (max-height: 500px) {
      .control-bar {
        padding: 15px 20px 20px; /* âœ… ê°€ë¡œ ëª¨ë“œì—ì„œ íŒ¨ë”© ì¶•ì†Œ */
        min-height: 80px;
      }

      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }

      .my-camera-container {
        width: 80px;
        height: 107px;
        top: 10px;
        right: 10px;
      }

      .audio-guide {
        bottom: 90px;
      }
    }

    /* ëŠê¹€ ì—†ëŠ” ì „í™˜ì„ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    @keyframes pulseGlow {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
        box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 0 30px rgba(52, 152, 219, 0.8);
      }
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes fadeInOut {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
    }

    /* âœ… ì•ˆì „ ì˜ì—­ ëŒ€ì‘ (ì•„ì´í° ë…¸ì¹˜ ë“±) */
    @supports (padding: max(0px)) {
      .control-bar {
        padding-bottom: max(30px, env(safe-area-inset-bottom));
      }

      .my-camera-container {
        top: max(20px, env(safe-area-inset-top));
        right: max(20px, env(safe-area-inset-right));
      }

      .status-indicator {
        top: max(20px, env(safe-area-inset-top));
        left: max(20px, env(safe-area-inset-left));
      }
    }
  </style>
</head>
<body>
<!-- ìƒíƒœ í‘œì‹œ -->
<div class="status-indicator">
  <span class="status-dot"></span>
  <span id="statusText">ì—°ê²° ì¤€ë¹„ ì¤‘...</span>
</div>

<!-- ë©”ì¸ ë¹„ë””ì˜¤ (ì „ì²´ í™”ë©´) -->
<div class="main-video-container">
  <video id="mainVideo" class="main-video" autoplay loop muted playsinline>
    <source src="https://aicut.newstomato.com/remember/static/waiting_kt.mp4" type="video/mp4">
    ëŒ€ê¸° ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  </video>
</div>

<!-- ë‚´ ì¹´ë©”ë¼ (ìš°ì¸¡ ìƒë‹¨) -->
<div class="my-camera-container">
  <video id="myCamera" class="my-camera" autoplay muted playsinline style="display: none;"></video>
  <div id="cameraPlaceholder" class="camera-placeholder">ğŸ“¹</div>
</div>

<!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
<div class="control-bar">
  <button id="recordBtn" class="control-btn record-btn" onclick="toggleRecording()">
    <span id="recordIcon">âº</span>
  </button>

  <!-- ìŒì†Œê±° ë²„íŠ¼ -->
  <button id="muteBtn" class="control-btn mute-btn" onclick="toggleMute()">
    <span id="muteIcon">ğŸ”‡</span>
  </button>

  <button class="control-btn end-call-btn" onclick="endCall()">
    ğŸ“
  </button>
</div>

<!-- ìŒì„± ì•ˆë‚´ ë§í’ì„  -->
<div id="audioGuide" class="audio-guide">
  <div class="guide-arrow"></div>
  <div class="guide-text">
    ìŒì„± ì¬ìƒì„ ìœ„í•´<br>
    <strong>ğŸ”‡ ë²„íŠ¼ì„ í„°ì¹˜</strong>í•´ì£¼ì„¸ìš”
  </div>
</div>

<script>
    // ========== ì „ì—­ ë³€ìˆ˜ ==========

    // ì„¸ì…˜ ë° ì—°ê²° ê´€ë ¨
    let sessionKey = null;
    let sseEventSource = null;

    // ë…¹í™” ê´€ë ¨
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let userMediaStream = null;

    // ìŒì†Œê±° ê´€ë ¨
    let isAudioEnabled = false;
    let guideTimeout = null;

    // ëŠê¹€ ì—†ëŠ” ì˜ìƒ ì¬ìƒ ê´€ë ¨
    let waitingVideoPreloaded = false;
    let currentVideoState = 'WAITING'; // WAITING, RESPONSE, TRANSITIONING
    let videoTransitionInProgress = false;

    // DOM ìš”ì†Œë“¤
    const mainVideo = document.getElementById('mainVideo');
    const myCamera = document.getElementById('myCamera');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const recordBtn = document.getElementById('recordBtn');
    const recordIcon = document.getElementById('recordIcon');
    const statusText = document.getElementById('statusText');
    const muteBtn = document.getElementById('muteBtn');
    const muteIcon = document.getElementById('muteIcon');
    const audioGuide = document.getElementById('audioGuide');

    // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
    let sseReconnectAttempts = 0;
    let maxReconnectAttempts = 10;
    let heartbeatInterval = null;
    let lastHeartbeat = Date.now();

    // ========== 1. ëŠê¹€ ì—†ëŠ” ì˜ìƒí†µí™” ì´ˆê¸°í™” ==========
    async function initializeVideoCall() {
        try {
            console.log('ğŸš€ ì˜ìƒí†µí™” ì´ˆê¸°í™” ì‹œì‘');

            // âœ… 1ë‹¨ê³„: ì¦‰ì‹œ ëŒ€ê¸° ì˜ìƒ ì‹œì‘ (ì‚¬ìš©ìëŠ” ë°”ë¡œ ì˜ìƒì„ ë´„)
            await startWaitingVideoImmediately();

            // âœ… 2ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„¸ì…˜ ìƒì„± (ë¹„ë™ê¸°)
            initializeSessionInBackground();

            // âœ… 3ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œ (ë¹„ë™ê¸°)
            initializeCameraInBackground();

            console.log('âœ… ì˜ìƒí†µí™” ì´ˆê¸°í™” ì™„ë£Œ - ì‚¬ìš©ìëŠ” ì¦‰ì‹œ ì˜ìƒì„ ë³´ê³  ìˆìŒ');

        } catch (error) {
            console.error('ì˜ìƒí†µí™” ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            handleInitializationError(error);
        }
    }

    // ========== 2. ì¦‰ì‹œ ëŒ€ê¸° ì˜ìƒ ì‹œì‘ ==========
    async function startWaitingVideoImmediately() {
        try {
            const waitingVideoUrl = 'https://aicut.newstomato.com/remember/static/waiting_kt.mp4';

            // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì¦‰ì‹œ ì„¤ì •
            mainVideo.src = waitingVideoUrl;
            mainVideo.loop = true;
            mainVideo.muted = true;
            mainVideo.autoplay = true;

            // ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ì„¤ì •
            setupVideoEventListeners();

            // ì¦‰ì‹œ ì¬ìƒ ì‹œë„
            try {
                await mainVideo.play();
                console.log('âœ… ëŒ€ê¸° ì˜ìƒ ì¦‰ì‹œ ì¬ìƒ ì„±ê³µ');
                currentVideoState = 'WAITING';
                waitingVideoPreloaded = true;

                updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');

            } catch (playError) {
                if (playError.name === 'NotAllowedError') {
                    console.log('ğŸ“± ìë™ì¬ìƒ ì°¨ë‹¨ë¨ - ì‚¬ìš©ì í„°ì¹˜ ëŒ€ê¸°');
                    showTouchToPlayGuide();
                } else {
                    throw playError;
                }
            }

        } catch (error) {
            console.error('ì¦‰ì‹œ ì¬ìƒ ì‹¤íŒ¨:', error);
            showStaticBackground();
        }
    }

    // ========== 3. ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ì´ˆê¸°í™” ==========
    async function initializeSessionInBackground() {
        try {
            const contactName = getCurrentContactName();
            console.log('ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ìƒì„± ì¤‘:', contactName);

            const sessionResponse = await fetch('/api/video/create-session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({contactName: contactName})
            });

            const sessionData = await sessionResponse.json();

            if (sessionData.status.code === 'OK_0000') {
                sessionKey = sessionData.response.sessionKey;
                console.log('âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ:', sessionKey);

                // SSE ì—°ê²° ì‹œì‘
                connectSSE();

                // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì‹œì‘
                startConnectionMonitoring();

                // ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ ì„¤ì •
                setupNetworkMonitoring();

                updateStatusSmoothly('ëŒ€ê¸° ì¤‘');

            } else {
                throw new Error(sessionData.status.message);
            }

        } catch (error) {
            console.error('ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
            updateStatusSmoothly('ì—°ê²° ì¬ì‹œë„ ì¤‘...');

            // 3ì´ˆ í›„ ì¬ì‹œë„
            setTimeout(() => {
                initializeSessionInBackground();
            }, 3000);
        }
    }

    // ========== 4. ë°±ê·¸ë¼ìš´ë“œ ì¹´ë©”ë¼ ì´ˆê¸°í™” ==========
    async function initializeCameraInBackground() {
        try {
            console.log('ğŸ¥ ë°±ê·¸ë¼ìš´ë“œ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...');

            userMediaStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: {ideal: 1920, min: 1280},
                    height: {ideal: 1080, min: 720},
                    frameRate: {ideal: 30, min: 24},
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });

            myCamera.srcObject = userMediaStream;
            myCamera.style.display = 'block';
            cameraPlaceholder.style.display = 'none';

            console.log('âœ… ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ');

        } catch (error) {
            console.error('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            showCameraError();
        }
    }

    // ========== 5. SSE ì—°ê²° ==========
    function connectSSE() {
        if (!sessionKey) {
            console.error('ì„¸ì…˜ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        console.log(`ğŸ”— SSE ì—°ê²° ì‹œë„ (${sseReconnectAttempts + 1}/${maxReconnectAttempts}):`, sessionKey);

        // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
        if (sseEventSource) {
            sseEventSource.close();
            sseEventSource = null;
        }

        // í•˜íŠ¸ë¹„íŠ¸ ì •ë¦¬
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }

        // ìƒˆ SSE ì—°ê²° ìƒì„±
        sseEventSource = new EventSource(`/api/video/stream/${sessionKey}`);
        lastHeartbeat = Date.now();

        // ========== ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸ ==========
        sseEventSource.onopen = function (event) {
            console.log('âœ… SSE ì—°ê²° ì„±ê³µ');
            sseReconnectAttempts = 0; // ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ë¦¬ì…‹
            updateStatusSmoothly('ì—°ê²° ì¤‘...');

            // í•˜íŠ¸ë¹„íŠ¸ ì‹œì‘
            startHeartbeat();
        };

        // ========== ì—°ê²° ì™„ë£Œ ì´ë²¤íŠ¸ ==========
        sseEventSource.addEventListener('connected', function (event) {
            try {
                const data = JSON.parse(event.data);
                console.log('ğŸ“¡ SSE ì—°ê²° ì™„ë£Œ:', data);
                updateStatusSmoothly(`${data.contactName}ì™€ ì—°ê²°ë¨`);
                lastHeartbeat = Date.now();
            } catch (error) {
                console.error('Connected ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error);
                updateStatusSmoothly('ì—°ê²°ë¨');
            }
        });

        // ========== í•˜íŠ¸ë¹„íŠ¸ ì´ë²¤íŠ¸ ==========
        sseEventSource.addEventListener('heartbeat', function (event) {
            lastHeartbeat = Date.now();
            console.log('ğŸ’“ í•˜íŠ¸ë¹„íŠ¸ ìˆ˜ì‹ :', new Date().toLocaleTimeString());
        });

        // ========== ì‘ë‹µ ì˜ìƒ ì´ë²¤íŠ¸ ==========
        sseEventSource.addEventListener('response', function (event) {
            try {
                const data = JSON.parse(event.data);
                console.log('ğŸ¬ ì‘ë‹µ ì˜ìƒ ìˆ˜ì‹ :', data);
                lastHeartbeat = Date.now();
                playResponseVideo(data.videoUrl);
            } catch (error) {
                console.error('Response ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error);
            }
        });

        // ========== ì»¤ìŠ¤í…€ ì˜¤ë¥˜ ì´ë²¤íŠ¸ ==========
        sseEventSource.addEventListener('error', function (event) {
            console.error('âŒ SSE ì»¤ìŠ¤í…€ ì˜¤ë¥˜:', event);
            try {
                if (event.data) {
                    const data = JSON.parse(event.data);
                    console.error('ì˜¤ë¥˜ ë°ì´í„°:', data);
                    updateStatusSmoothly('ì²˜ë¦¬ ì˜¤ë¥˜');
                    showErrorMessage(data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (parseError) {
                console.error('ì˜¤ë¥˜ ì´ë²¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨:', parseError);
            }
        });

        // ========== ì—°ê²° ì˜¤ë¥˜ ì²˜ë¦¬ (í•µì‹¬!) ==========
        sseEventSource.onerror = function (event) {
            console.error('ğŸ”¥ SSE ì—°ê²° ì˜¤ë¥˜:', event);

            // ì—°ê²° ìƒíƒœë³„ ì²˜ë¦¬
            switch (sseEventSource.readyState) {
                case EventSource.CONNECTING:
                    console.log('ğŸ”„ SSE ì¬ì—°ê²° ì¤‘...');
                    updateStatusSmoothly('ì¬ì—°ê²° ì¤‘...');
                    return; // ë¸Œë¼ìš°ì €ê°€ ìë™ ì¬ì—°ê²° ì¤‘ì´ë¯€ë¡œ ëŒ€ê¸°

                case EventSource.CLOSED:
                    console.log('ğŸš« SSE ì—°ê²° ë‹«í˜');
                    updateStatusSmoothly('ì—°ê²° ì¢…ë£Œ');
                    handleSSEReconnection(); // ìˆ˜ë™ ì¬ì—°ê²°
                    return;

                default:
                    console.log('âš ï¸ SSE ì—°ê²° ë¶ˆì•ˆì •');
                    updateStatusSmoothly('ì—°ê²° ë¶ˆì•ˆì •');
                    handleSSEReconnection(); // ìˆ˜ë™ ì¬ì—°ê²°
                    return;
            }
        };
    }

    // ========== 2. í•˜íŠ¸ë¹„íŠ¸ ì‹œìŠ¤í…œ ==========
    function startHeartbeat() {
        // ê¸°ì¡´ í•˜íŠ¸ë¹„íŠ¸ ì •ë¦¬
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }

        // 30ì´ˆë§ˆë‹¤ í•˜íŠ¸ë¹„íŠ¸ í™•ì¸
        heartbeatInterval = setInterval(() => {
            const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
            const heartbeatTimeout = 60000; // 60ì´ˆ

            console.log(`ğŸ’“ í•˜íŠ¸ë¹„íŠ¸ ì²´í¬: ${Math.round(timeSinceLastHeartbeat / 1000)}ì´ˆ ì „`);

            // í•˜íŠ¸ë¹„íŠ¸ íƒ€ì„ì•„ì›ƒ ì²´í¬
            if (timeSinceLastHeartbeat > heartbeatTimeout) {
                console.warn('ğŸ’” í•˜íŠ¸ë¹„íŠ¸ íƒ€ì„ì•„ì›ƒ - ì¬ì—°ê²° í•„ìš”');
                handleSSEReconnection();
            }
        }, 30000); // 30ì´ˆë§ˆë‹¤ ì²´í¬
    }

    // ========== 3. ì§€ëŠ¥ì ì¸ ì¬ì—°ê²° ë¡œì§ ==========
    function handleSSEReconnection() {
        // í•˜íŠ¸ë¹„íŠ¸ ì¤‘ì§€
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }

        // ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì²´í¬
        if (sseReconnectAttempts >= maxReconnectAttempts) {
            console.error('ğŸš¨ ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
            updateStatusSmoothly('ì—°ê²° ì‹¤íŒ¨');
            showErrorMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }

        sseReconnectAttempts++;

        // ì§€ìˆ˜ ë°±ì˜¤í”„ (1ì´ˆ, 2ì´ˆ, 4ì´ˆ, 8ì´ˆ, 16ì´ˆ, ìµœëŒ€ 30ì´ˆ)
        const delay = Math.min(1000 * Math.pow(2, sseReconnectAttempts - 1), 30000);

        console.log(`ğŸ”„ ${delay / 1000}ì´ˆ í›„ SSE ì¬ì—°ê²° ì‹œë„ (${sseReconnectAttempts}/${maxReconnectAttempts})`);
        updateStatusSmoothly(`${Math.round(delay / 1000)}ì´ˆ í›„ ì¬ì—°ê²°...`);

        setTimeout(() => {
            // ì„¸ì…˜ì´ ì—¬ì „íˆ ìœ íš¨í•œì§€ í™•ì¸
            if (sessionKey) {
                console.log('ğŸ”„ SSE ì¬ì—°ê²° ì‹œì‘');
                connectSSE();
            } else {
                console.error('âŒ ì„¸ì…˜ í‚¤ê°€ ì—†ì–´ ì¬ì—°ê²° ë¶ˆê°€');
            }
        }, delay);
    }

    // ========== 4. ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ==========
    function startConnectionMonitoring() {
        // 5ë¶„ë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸
        setInterval(() => {
            if (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN) {
                console.warn('âš ï¸ SSE ì—°ê²° ìƒíƒœ ì´ìƒ - ì¬ì—°ê²° ì‹œë„');
                handleSSEReconnection();
            } else {
                console.log('âœ… SSE ì—°ê²° ìƒíƒœ ì •ìƒ');
            }
        }, 300000); // 5ë¶„ë§ˆë‹¤
    }

    // ========== 5. ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê°ì§€ ==========
    function setupNetworkMonitoring() {
        let isOnline = navigator.onLine;

        window.addEventListener('online', () => {
            console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
            isOnline = true;
            updateStatusSmoothly('ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ë¨');

            // ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œ ì¦‰ì‹œ ì¬ì—°ê²°
            setTimeout(() => {
                if (sessionKey && (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN)) {
                    console.log('ğŸ”„ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ í›„ SSE ì¬ì—°ê²°');
                    sseReconnectAttempts = 0; // ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ë¦¬ì…‹
                    connectSSE();
                }
            }, 1000);
        });

        window.addEventListener('offline', () => {
            console.log('ğŸ“µ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
            isOnline = false;
            updateStatusSmoothly('ë„¤íŠ¸ì›Œí¬ ì˜¤í”„ë¼ì¸');

            // ì˜¤í”„ë¼ì¸ ì‹œ ì¬ì—°ê²° ì‹œë„ ì¤‘ì§€
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        });
    }

    // ========== 6. ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ ==========
    async function validateSession() {
        if (!sessionKey) {
            return false;
        }

        try {
            const response = await fetch(`/api/video/session/${sessionKey}`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            });

            const data = await response.json();

            if (data.status.code === 'OK_0000') {
                console.log('âœ… ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ ì™„ë£Œ');
                return true;
            } else {
                console.error('âŒ ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', data.status.message);
                return false;
            }
        } catch (error) {
            console.error('âŒ ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ ì‹¤íŒ¨:', error);
            return false;
        }
    }

    // ========== 6. ë¶€ë“œëŸ¬ìš´ ìƒíƒœ ì—…ë°ì´íŠ¸ ==========
    function updateStatusSmoothly(newStatus) {
        statusText.style.transition = 'opacity 0.3s ease';
        statusText.style.opacity = '0';

        setTimeout(() => {
            statusText.textContent = newStatus;
            statusText.style.opacity = '1';
        }, 150);
    }

    // ========== 7. ë…¹í™” í† ê¸€ ==========
    async function toggleRecording() {
        if (!isRecording) {
            await startRecording();
        } else {
            await stopRecording();
        }
    }

    // ========== 8. ë…¹í™” ì‹œì‘ ==========
    async function startRecording() {
        if (!userMediaStream) {
            showErrorMessage('ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            recordedChunks = [];

            const options = {
                mimeType: 'video/webm;codecs=vp9,opus',
                videoBitsPerSecond: 5000000,
                audioBitsPerSecond: 128000
            };

            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm;codecs=vp8,opus';
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
            }

            mediaRecorder = new MediaRecorder(userMediaStream, options);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                processRecordedVideo();
            };

            mediaRecorder.start();
            isRecording = true;

            recordBtn.classList.add('recording');
            recordIcon.textContent = 'â¹';
            updateStatusSmoothly('ë…¹í™” ì¤‘');

            console.log('ğŸ“¹ ë…¹í™” ì‹œì‘');

        } catch (error) {
            console.error('ë…¹í™” ì‹œì‘ ì˜¤ë¥˜:', error);
            showErrorMessage('ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ========== 9. ë…¹í™” ì¤‘ì§€ ==========
    async function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;

            recordBtn.classList.remove('recording');
            recordIcon.textContent = 'âº';
            updateStatusSmoothly('ì²˜ë¦¬ ì¤‘');

            console.log('â¹ ë…¹í™” ì¤‘ì§€');
        }
    }

    // ========== 10. ë…¹í™” ì˜ìƒ ì²˜ë¦¬ (ë¡œë”© ì—†ìŒ) ==========
    async function processRecordedVideo() {
        if (!sessionKey) {
            showErrorMessage('ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            console.log('ğŸ“¹ ì˜ìƒ ì²˜ë¦¬ ì‹œì‘ - ë¡œë”© í™”ë©´ ì—†ìŒ');

            // âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œí•˜ì§€ ì•ŠìŒ - ëŒ€ê¸° ì˜ìƒ ê³„ì† ì¬ìƒ
            updateStatusSmoothly('ì „ì†¡ ì¤‘...');

            const blob = new Blob(recordedChunks, {type: 'video/webm'});
            const formData = new FormData();
            formData.append('video', blob, `recorded_video_${sessionKey}_${Date.now()}.webm`);

            console.log('ğŸ“¤ ì„œë²„ë¡œ ì˜ìƒ ì „ì†¡ ì¤‘...', sessionKey, blob.size, 'bytes');

            const response = await fetch(`/api/video/process/${sessionKey}`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                console.log('âœ… ì„œë²„ ì‘ë‹µ:', result);

                updateStatusSmoothly('ì²˜ë¦¬ ì¤‘...');
                console.log('ğŸ”„ SSE ì‘ë‹µ ëŒ€ê¸° ì¤‘...');
            } else {
                throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
            }

        } catch (error) {
            console.error('ì˜ìƒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            updateStatusSmoothly('ì „ì†¡ ì‹¤íŒ¨');
            showErrorMessage('ì˜ìƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // ========== 11. ë¶€ë“œëŸ¬ìš´ ì‘ë‹µ ì˜ìƒ ì „í™˜ (í•µì‹¬!) ==========
    async function playResponseVideo(videoUrl) {
        if (videoTransitionInProgress) {
            console.log('â³ ì˜ìƒ ì „í™˜ ì¤‘ì´ë¯€ë¡œ ëŒ€ê¸°');
            return;
        }

        try {
            videoTransitionInProgress = true;
            console.log('ğŸ¬ ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì‹œì‘:', videoUrl);

            updateStatusSmoothly('ì‘ë‹µ ì¬ìƒ ì¤‘');
            currentVideoState = 'TRANSITIONING';

            // âœ… ìƒˆë¡œìš´ ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ë¡œ í”„ë¦¬ë¡œë”©
            const responseVideo = document.createElement('video');
            responseVideo.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
                background: #000;
                opacity: 0;
                transition: opacity 0.5s ease;
            `;

            responseVideo.src = videoUrl;
            responseVideo.loop = false;
            responseVideo.muted = !isAudioEnabled;
            if (isAudioEnabled) {
                responseVideo.volume = 0.8;
            }

            document.querySelector('.main-video-container').appendChild(responseVideo);

            // í”„ë¦¬ë¡œë”© ì™„ë£Œ ëŒ€ê¸°
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('ì‘ë‹µ ì˜ìƒ ë¡œë”© íƒ€ì„ì•„ì›ƒ'));
                }, 10000);

                responseVideo.addEventListener('canplaythrough', () => {
                    clearTimeout(timeout);
                    resolve();
                }, {once: true});

                responseVideo.addEventListener('error', (e) => {
                    clearTimeout(timeout);
                    reject(e);
                }, {once: true});
            });

            // âœ… ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ ì „í™˜
            await responseVideo.play();
            responseVideo.style.opacity = '1';
            mainVideo.style.opacity = '0.3';

            currentVideoState = 'RESPONSE';

            if (!isAudioEnabled) {
                showAudioGuide();
            }

            // ì‘ë‹µ ì˜ìƒ ì¢…ë£Œ ì‹œ ë¶€ë“œëŸ½ê²Œ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€
            responseVideo.addEventListener('ended', async () => {
                console.log('ğŸ”„ ì‘ë‹µ ì˜ìƒ ì¢…ë£Œ, ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€');
                await returnToWaitingVideoSmoothly(responseVideo);
            }, {once: true});

        } catch (error) {
            console.error('ì‘ë‹µ ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜:', error);
            await handleResponseVideoError(error);
        } finally {
            videoTransitionInProgress = false;
        }
    }

    // ========== 12. ë¶€ë“œëŸ¬ìš´ ëŒ€ê¸° ì˜ìƒ ë³µê·€ ==========
    async function returnToWaitingVideoSmoothly(responseVideo) {
        try {
            console.log('ğŸ”„ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ë³µê·€');

            currentVideoState = 'TRANSITIONING';

            mainVideo.style.transition = 'opacity 0.5s ease';
            mainVideo.style.opacity = '1';
            responseVideo.style.opacity = '0';

            setTimeout(() => {
                if (responseVideo.parentNode) {
                    responseVideo.parentNode.removeChild(responseVideo);
                }

                currentVideoState = 'WAITING';
                updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
                console.log('âœ… ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ë³µê·€ ì™„ë£Œ');
            }, 500);

        } catch (error) {
            console.error('ëŒ€ê¸° ì˜ìƒ ë³µê·€ ì˜¤ë¥˜:', error);
            if (responseVideo.parentNode) {
                responseVideo.parentNode.removeChild(responseVideo);
            }
            currentVideoState = 'WAITING';
            mainVideo.style.opacity = '1';
        }
    }

    // ========== 13. ìŒì†Œê±° í† ê¸€ ==========
    async function toggleMute() {
        try {
            if (!isAudioEnabled) {
                await enableAudio();
            } else {
                disableAudio();
            }
        } catch (error) {
            console.error('ìŒì†Œê±° í† ê¸€ ì˜¤ë¥˜:', error);
            showErrorMessage('ìŒì„± ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ========== 14. ì˜¤ë””ì˜¤ í™œì„±í™” ==========
    async function enableAudio() {
        try {
            mainVideo.muted = false;
            mainVideo.volume = 0.01;
            await mainVideo.play();

            isAudioEnabled = true;
            mainVideo.muted = true;
            mainVideo.volume = 0.8;

            muteIcon.textContent = 'ğŸ”Š';
            muteBtn.classList.add('active');

            hideAudioGuide();
            showSuccessMessage('ìŒì„±ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            console.log('ğŸ”Š ì˜¤ë””ì˜¤ í™œì„±í™” ì™„ë£Œ');

        } catch (error) {
            console.error('ì˜¤ë””ì˜¤ í™œì„±í™” ì‹¤íŒ¨:', error);
            showErrorMessage('ìŒì„± í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ========== 15. ì˜¤ë””ì˜¤ ë¹„í™œì„±í™” ==========
    function disableAudio() {
        isAudioEnabled = false;
        mainVideo.muted = true;
        muteIcon.textContent = 'ğŸ”‡';
        muteBtn.classList.remove('active');
        console.log('ğŸ”‡ ì˜¤ë””ì˜¤ ë¹„í™œì„±í™” ì™„ë£Œ');
    }

    // ========== 16. ìŒì„± ì•ˆë‚´ í‘œì‹œ/ìˆ¨ê¹€ ==========
    function showAudioGuide() {
        if (!isAudioEnabled) {
            audioGuide.classList.add('show');
            muteBtn.classList.add('pulse');

            guideTimeout = setTimeout(() => {
                hideAudioGuide();
            }, 5000);
        }
    }

    function hideAudioGuide() {
        audioGuide.classList.remove('show');
        muteBtn.classList.remove('pulse');

        if (guideTimeout) {
            clearTimeout(guideTimeout);
            guideTimeout = null;
        }
    }

    // ========== 17. í„°ì¹˜ë¡œ ì¬ìƒ ê°€ì´ë“œ ==========
    function showTouchToPlayGuide() {
        const guide = document.createElement('div');
        guide.id = 'touchGuide';
        guide.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            z-index: 200;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            animation: pulseGlow 2s ease-in-out infinite;
        `;
        guide.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¬</div>
            <div style="font-weight: 600; margin-bottom: 8px;">í™”ë©´ì„ í„°ì¹˜í•´ì£¼ì„¸ìš”</div>
            <div style="font-size: 14px; opacity: 0.8;">ì˜ìƒì„ ì‹œì‘í•˜ë ¤ë©´ í„°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤</div>
        `;

        guide.onclick = async () => {
            try {
                await mainVideo.play();
                guide.remove();
                console.log('âœ… ì‚¬ìš©ì í„°ì¹˜ë¡œ ì¬ìƒ ì‹œì‘');
                updateStatusSmoothly('ì—°ê²° ì¤€ë¹„ ì¤‘...');
            } catch (e) {
                console.error('ìˆ˜ë™ ì¬ìƒ ì‹¤íŒ¨:', e);
            }
        };

        document.querySelector('.main-video-container').appendChild(guide);
    }

    // ========== 18. ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ==========
    function setupVideoEventListeners() {
        mainVideo.addEventListener('error', (e) => {
            console.error('ëŒ€ê¸° ì˜ìƒ ì˜¤ë¥˜:', e);
            if (currentVideoState === 'WAITING') {
                showStaticBackground();
            }
        });

        mainVideo.addEventListener('stalled', () => {
            console.warn('ëŒ€ê¸° ì˜ìƒ ë¡œë”© ì§€ì—°');
        });

        mainVideo.addEventListener('waiting', () => {
            console.log('ëŒ€ê¸° ì˜ìƒ ë²„í¼ë§ ì¤‘...');
        });

        mainVideo.addEventListener('canplay', () => {
            console.log('ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
        });
    }

    // ========== 19. ëŒ€ì²´ ë°°ê²½ í‘œì‹œ ==========
    function showStaticBackground() {
        console.log('ğŸ“º ëŒ€ì²´ ë°°ê²½ í‘œì‹œ');
        mainVideo.style.display = 'none';
        const container = document.querySelector('.main-video-container');

        container.style.background = 'linear-gradient(135deg, #2c3e50, #34495e)';

        const fallback = document.createElement('div');
        fallback.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 18px;
        `;
        fallback.innerHTML = `
            <div style="font-size: 64px; margin-bottom: 20px; animation: float 3s ease-in-out infinite;">ğŸ“¹</div>
            <div style="font-weight: 600;">ì—°ê²°ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
            <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        `;

        container.appendChild(fallback);
    }

    // ========== 20. ì˜¤ë¥˜ ì²˜ë¦¬ ==========
    function handleInitializationError(error) {
        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showStaticBackground();
        updateStatusSmoothly('ì—°ê²° ì¬ì‹œë„ ì¤‘...');

        setTimeout(() => {
            window.location.reload();
        }, 5000);
    }

    async function handleResponseVideoError(error) {
        console.error('ì‘ë‹µ ì˜ìƒ ì˜¤ë¥˜:', error);

        if (error.name === 'NotAllowedError') {
            showAudioGuide();
        }

        currentVideoState = 'WAITING';
        mainVideo.style.opacity = '1';
        updateStatusSmoothly('ëŒ€ê¸° ì¤‘');
    }

    function showCameraError() {
        console.log('ğŸ“· ì¹´ë©”ë¼ ì˜¤ë¥˜ - í”Œë ˆì´ìŠ¤í™€ë” ìœ ì§€');
        // ì¹´ë©”ë¼ ì‹¤íŒ¨í•´ë„ ì˜ìƒí†µí™”ëŠ” ê³„ì† ì§„í–‰
    }

    // ========== 21. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==========
    function getCurrentContactName() {
        const urlParams = new URLSearchParams(window.location.search);
        const contactName = urlParams.get('contact') ||
            localStorage.getItem('selectedContact') ||
            'ê¹€ê·¼íƒœ';
        return contactName;
    }

    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.textContent = message;
        successDiv.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(39, 174, 96, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        `;

        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 2000);
    }

    function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.textContent = message;
        errorDiv.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        `;

        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 2000);
    }

    // ========== 22. í†µí™” ì¢…ë£Œ ==========
    function endCall() {
        if (confirm('ì˜ìƒí†µí™”ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            enhancedCleanup();

            if (isRecording && mediaRecorder) {
                try {
                    mediaRecorder.stop();
                    isRecording = false;
                } catch (error) {
                    console.error('ë…¹í™” ì¤‘ì§€ ì˜¤ë¥˜:', error);
                }
            }

            sessionKey = null;
            // âœ… ì˜¨ë³´ë”© ìƒíƒœì— ë”°ë¥¸ ë¦¬ë‹¤ì´ë ‰íŠ¸
            const hasOnboarding = hasCompletedOnboarding();
            const redirectPath = hasOnboarding ? '/mobile/home' : '/mobile/onboarding';

            console.log('ğŸ”„ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸:', {
                hasCompletedOnboarding: hasOnboarding,
                redirectPath: redirectPath
            });

            window.location.href = redirectPath;
        }
    }

    function hasCompletedOnboarding() {
        try {
            const onboardingData = localStorage.getItem('onboarding_completed');
            if (!onboardingData) return false;

            const data = JSON.parse(onboardingData);
            return data.completed === true;
        } catch (error) {
            console.error('ì˜¨ë³´ë”© ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            return false;
        }
    }

    // ========== 23. ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ==========
    function enhancedCleanup() {
        console.log('ğŸ§¹ ê°•í™”ëœ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹œì‘');

        // í•˜íŠ¸ë¹„íŠ¸ ì •ë¦¬
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }

        // SSE ì—°ê²° ì •ë¦¬
        if (sseEventSource) {
            sseEventSource.close();
            sseEventSource = null;
        }

        // âœ… ì„¸ì…˜ ê´€ë ¨ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith('sessionKey') || key.startsWith('VC_'))) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        console.log('ğŸ—‘ï¸ ì •ë¦¬ëœ ì„¸ì…˜ í‚¤ë“¤:', keysToRemove);

        // âœ… í˜„ì¬ ì„¸ì…˜ ì´ˆê¸°í™”
        sessionKey = null;
        sseReconnectAttempts = 0;

        // ê¸°íƒ€ ì •ë¦¬
        if (guideTimeout) {
            clearTimeout(guideTimeout);
            guideTimeout = null;
        }

        if (userMediaStream) {
            userMediaStream.getTracks().forEach(track => {
                track.stop();
                console.log('ë¯¸ë””ì–´ íŠ¸ë™ ì •ë¦¬:', track.kind);
            });
            userMediaStream = null;
        }

        recordedChunks = [];

        console.log('âœ… ê°•í™”ëœ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ');
    }

    function detectAndCleanOldSessions() {
        const currentTime = Date.now();
        const sessionTimeout = 10 * 60 * 1000; // 10ë¶„

        // ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ ì²´í¬
        const lastActivity = localStorage.getItem('lastVideoCallActivity');
        if (lastActivity) {
            const timeDiff = currentTime - parseInt(lastActivity);
            if (timeDiff > sessionTimeout) {
                console.log('âš ï¸ ì˜¤ë˜ëœ ì„¸ì…˜ ê°ì§€ - ì •ë¦¬ ì¤‘');
                enhancedCleanup();
            }
        }

        // í˜„ì¬ ì‹œê°„ ì €ì¥
        localStorage.setItem('lastVideoCallActivity', currentTime.toString());
    }

    // ========== 24. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ==========
    // âœ… ì´ˆê¸°í™” ì‹œ ì˜¤ë˜ëœ ì„¸ì…˜ ì •ë¦¬
    window.addEventListener('load', function () {
        console.log('ğŸŒ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        setTimeout(() => {
            if (!sessionKey) {
                console.log('ğŸ”„ ë°±ì—… ì´ˆê¸°í™” ì‹¤í–‰');
                initializeVideoCall();
            }
        }, 500);
    });

    window.addEventListener('beforeunload', () => {
        enhancedCleanup();

        // âœ… ì„œë²„ì— ì„¸ì…˜ ì¢…ë£Œ ì•Œë¦¼ (Best Effort)
        if (sessionKey) {
            navigator.sendBeacon(`/api/video/session/${sessionKey}/cleanup`);
        }
    });

    window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
            console.log('ğŸ”„ í˜ì´ì§€ ìºì‹œì—ì„œ ë³µì›ë¨ - ì „ì²´ ìƒˆë¡œê³ ì¹¨ í•„ìš”');
            window.location.reload();
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ (ì•± ì „í™˜)');
        } else {
            console.log('í˜ì´ì§€ê°€ í‘œì‹œë¨ (ì•± ë³µê·€)');
            if (sessionKey && (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN)) {
                setTimeout(() => {
                    console.log('ì•± ë³µê·€ í›„ SSE ì¬ì—°ê²°');
                    connectSSE();
                }, 500);
            }
        }
    });

    // í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™” (ëª¨ë°”ì¼)
    if ('ontouchstart' in window) {
        document.addEventListener('touchstart', function () {
        }, {passive: true});

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }

    // ========== ìë™ ì‹¤í–‰ ì½”ë“œ ì¶”ê°€ ==========
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ - ì˜ìƒí†µí™” ì´ˆê¸°í™” ì‹œì‘');
        initializeVideoCall();
    });

    console.log('ğŸ¬ ëŠê¹€ ì—†ëŠ” ì˜ìƒí†µí™” ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
</script>
</body>
</html>