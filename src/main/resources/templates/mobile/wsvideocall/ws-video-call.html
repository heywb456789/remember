<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† ë§ˆí† ë¦¬ë©¤ë²„ - WebSocket ì˜ìƒí†µí™”</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" th:href="@{/assets/mobile/css/ws-video-call.css}">
</head>
<body>
    <!-- ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ -->
    <div id="permissionModal" class="permission-modal">
        <div class="permission-dialog">
            <div id="permissionIcon" class="permission-icon">ğŸ¥</div>
            <div id="permissionTitle" class="permission-title">ë¯¸ë””ì–´ ê¶Œí•œ í•„ìš”</div>
            <div id="permissionMessage" class="permission-message">
                ì˜ìƒí†µí™”ë¥¼ ìœ„í•´ ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                ìµœì ì˜ ê²½í—˜ì„ ìœ„í•´ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.
            </div>
            <div class="permission-buttons">
                <button class="permission-btn deny" onclick="denyPermission()">ë‚˜ì¤‘ì—</button>
                <button class="permission-btn allow" onclick="requestPermissions()">í—ˆìš©</button>
            </div>
        </div>
    </div>

    <!-- í†µí™” ì‹œì‘ ëª¨ë‹¬ -->
    <div id="callStartModal" class="call-start-modal">
        <div class="call-start-dialog">
            <div class="call-start-icon">ğŸ“¹</div>
            <div class="call-start-title">í†µí™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="call-start-message">
                <span id="contactNameDisplay" th:text="${contactName}">ì—°ê²° ì¤€ë¹„ ì¤‘...</span>ë‹˜ê³¼ì˜ ì˜ìƒí†µí™”ë¥¼<br>
                ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
            <div class="call-start-buttons">
                <button class="call-start-btn cancel" onclick="cancelCall()">ì·¨ì†Œ</button>
                <button class="call-start-btn start" onclick="startCall()">í†µí™” ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ëª¨ë‹¬ -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-dialog">
            <div class="loading-spinner"></div>
            <div id="loadingTitle" class="loading-title">ì—°ê²° ì¤€ë¹„ ì¤‘...</div>
            <div id="loadingMessage" class="loading-message">
                ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
            </div>
        </div>
    </div>

    <!-- ìƒíƒœ í‘œì‹œ -->
    <div id="statusIndicator" class="status-indicator">
        <span class="status-dot"></span>
        <span id="statusText">ì´ˆê¸°í™” ì¤‘...</span>
    </div>

    <!-- ë©”ì¸ ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ -->
    <div class="main-video-container">
        <video id="mainVideo" class="main-video" autoplay loop muted playsinline style="display: none;">
            <source th:src="${waitingVideoUrl}" type="video/mp4" th:if="${waitingVideoUrl}">
            ëŒ€ê¸° ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </video>

        <!-- ì˜ìƒ ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="videoLoadingOverlay" class="video-loading-overlay">
            <div class="video-loading-spinner"></div>
            <div class="video-loading-text">ì˜ìƒ ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <!-- ë‚´ ì¹´ë©”ë¼ -->
    <div id="myCameraContainer" class="my-camera-container">
        <video id="myCamera" class="my-camera" autoplay muted playsinline style="display: none;"></video>
        <div id="cameraPlaceholder" class="camera-placeholder">ğŸ“¹</div>
    </div>

    <!-- í†µí™” ì¢…ë£Œ ë²„íŠ¼ -->
    <div class="end-call-container">
        <button class="end-call-x-btn" onclick="endCall()" title="í†µí™” ì¢…ë£Œ">âœ•</button>
    </div>

    <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
    <div id="controlBar" class="control-bar">
        <button id="recordBtn" class="control-btn record-btn" onclick="toggleRecording()" title="ë…¹í™”/ì¤‘ì§€">
            <i class="fas fa-microphone" id="recordIcon"></i>
        </button>
    </div>

    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="connectionStatus" class="connection-status">
        <i class="fas fa-wifi" id="connectionIcon"></i>
        <span id="connectionText">ì—°ê²° ì¤‘...</span>
    </div>

    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì ) -->
    <div th:if="${errorMessage}" class="alert alert-warning" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 3000;">
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- Scripts -->
    <script type="module" th:src="@{/assets/mobile/js/commonFetch.js}"></script>
    <script th:src="@{/assets/mobile/js/ws-video-call-config.js}" type="module"></script>
    <script th:src="@{/assets/mobile/js/ws-video-call-websocket.js}" type="module"></script>
    <script th:src="@{/assets/mobile/js/ws-video-call-media.js}" type="module"></script>
    <script th:src="@{/assets/mobile/js/ws-video-call-ui.js}" type="module"></script>
    <script th:src="@{/assets/mobile/js/ws-video-call-main.js}" type="module"></script>

    <!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬ -->
    <script th:inline="javascript">
        // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë°ì´í„°ë¥¼ JavaScript ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
        window.SERVER_DATA = {
            memberId: /*[[${memberId}]]*/ '2',
            memorialId: /*[[${memorialId}]]*/ '1',
            contactName: /*[[${contactName}]]*/ 'ê¹€ê·¼íƒœ',
            waitingVideoUrl: /*[[${waitingVideoUrl}]]*/ 'https://remember.newstomato.com/static/waiting_no.mp4',
            memberName: /*[[${memberName}]]*/ 'ì‚¬ìš©ì'
        };

        console.log('ğŸ¬ ì„œë²„ ë°ì´í„°:', window.SERVER_DATA);
    </script>

    <script type="module">
        import { checkLoginStatus, syncTokensFromPage } from '/assets/mobile/js/commonFetch.js';
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¬ WebSocket ì˜ìƒí†µí™” ì‹œìŠ¤í…œ ì‹œì‘');

            // í† í° ë™ê¸°í™”
            syncTokensFromPage();

            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!checkLoginStatus()) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/mobile/login?redirect=' + encodeURIComponent(window.location.href);
                return;
            }

            // ì„œë²„ ë°ì´í„° ì‚¬ìš©
            const { memberId, memorialId, contactName, waitingVideoUrl } = window.SERVER_DATA;

            console.log('ğŸ“‹ ì„œë²„ì—ì„œ ë°›ì€ íŒŒë¼ë¯¸í„°:', { memberId, memorialId, contactName });

            // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
            window.INITIAL_PARAMS = {
                memberId,
                memorialId,
                contactName,
                waitingVideoUrl
            };

            // ë©”ì¸ ì´ˆê¸°í™” ì‹œì‘
            if (typeof initializeVideoCall === 'function') {
                initializeVideoCall();
            } else {
                console.error('âŒ initializeVideoCall í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            console.log('ğŸ§¹ í˜ì´ì§€ ì–¸ë¡œë“œ - ë¦¬ì†ŒìŠ¤ ì •ë¦¬');
            if (typeof cleanup === 'function') {
                cleanup();
            }
        });

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        window.addEventListener('online', function() {
            console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
            if (typeof handleNetworkOnline === 'function') {
                handleNetworkOnline();
            }
        });

        window.addEventListener('offline', function() {
            console.log('ğŸ“µ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
            if (typeof handleNetworkOffline === 'function') {
                handleNetworkOffline();
            }
        });

        // ì•± í™œì„±í™”/ë¹„í™œì„±í™” ëª¨ë‹ˆí„°ë§
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('ğŸ“± ì•± ë¹„í™œì„±í™”');
                if (typeof handleAppHidden === 'function') {
                    handleAppHidden();
                }
            } else {
                console.log('ğŸ“± ì•± í™œì„±í™”');
                if (typeof handleAppVisible === 'function') {
                    handleAppVisible();
                }
            }
        });
    </script>
</body>
</html>